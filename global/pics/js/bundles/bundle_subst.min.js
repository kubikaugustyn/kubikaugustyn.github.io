"use strict";ASC.loadBundle("dbi"),ASC.setModuleSourceFunc("/substitution/online.js",function(e,require,t){e.__esModule=!0;var x=require("tslib"),A=require("react"),g=require("react-dom"),T=require("./subst"),I=require("../asc/asc_react"),k=require("../asc/edurequest"),d=require("../timetable/timeoff_r"),D=A.Fragment,R=require("../asc/datatable_r"),N=require("../rpr/dbi"),m=require("../rpr/dbi_react"),_=require("./online/rightpanel"),v=require("./online/leftpanel"),l=require("./online/combo");require("../rpr/server/maindbi"),require("../substitution/server/substdbi");var O=require("../asc/actions"),C=require("./online/timetable"),a=require("./online/dlg_addcard"),y=require("./online/dlg_ttitem"),B=require("../timetable/ttitem"),j=require("./commands"),M=require("./server/commands"),o="substonline_ttitems",u="substonline_substitutions",w="buildings",U={"":"",ok:T.ICON_subst_ok,zle:T.ICON_subst_kolizia,zle_ignored:T.ICON_subst_kolizia_ignored,spoj:T.ICON_subst_spojenie,changelesson:T.ICON_subst_changelesson,addlesson:T.ICON_subst_addlesson,movelesson:T.ICON_subst_movelesson,nomatch:"/substitution/pics/nomatch_32.png",error:"/substitution/pics/error_16.png"},h=["spoj","zle_ignored","nomatch","zle","error"],E=["officialtimetables","teachers","subjects","absent_types","substitution_types","approbations"],n={mode:"substs",date:"2000-01-01",buildingid:"",join_doubles:!1,selectedOtherId:"",selectedSubstId:"",app_data:null,tt:{teachers:{},classes:{},classrooms:{}}};function s(g,_,e,t){var v=[],y=new Map,w=[],E=new B.TTItemTimeProvider(g);E.setDate(g.rowData("substonline_dates",e),null);for(var n=g.tableFilterData("substonline_substitutions",{date:e}),S=g.tableFilterData("substonline_ttitems",{date:e}),s=function(e){var t=e.absent;if(t&&"classes"==T.absentGetTable(t))return"continue";var n=T.coreTTItemOfSubst(e,!1),s=T.coreTTItemOfSubst(e,!0),i=T.findTTItemFromSubstId(S,e.id,e.cancelled),r=x.__assign(x.__assign({},e),{stav:"",starttime:E.provide(n).starttime,ttitemid:i?i.id:"",kolizie:[]});if(!i)return r.stav="nomatch",w.push(r),"continue";t||(T.substIsAddCard(e)?r.stav=e.origid?"movelesson":"addlesson":r.stav="changelesson");for(var a=0,o=C.getSubstTTItemKolizie(g,_,i,[i.id]);a<o.length;a++){var l=o[a];if(l.item){if(l.table){var c=!1;if(s.uniperiod!=n.uniperiod&&(c=!0),T.substIsAddCard(e)&&(c=!0),N.idsArrayMatchI(T.substTTItem_tableIds(s,l.table),T.substTTItem_tableIds(n,l.table))||(c=!0),!c)continue}if(l.join)r.stav||(r.stav="spoj");else{for(var u=l.item.subjectid,d=0,m=["classids","groupnames","teacherids","classroomids"];d<m.length;d++){var p=m[d];u+="|",u+=l.item[p].join(",")}r.kolizie.push(u),0<=e.kolizie_ignored.indexOf(u)?"zle"!=r.stav&&(r.stav="zle_ignored"):r.stav="zle"}}l.absent&&(r.stav="zle")}if(e.cancelled&&(r.stav="ok"),e.orig_err&&(r.stav="error"),t){var b=T.absentGetTable(t),h=T.absentGetId(t),f=e.changes.find(function(e){return T.changeColumn2table(e.column)==b&&e.old==h});f&&!r.stav&&(f.new?r.stav="ok":"teachers"==b&&e.cancel_teacher&&(r.stav="ok"))}0==r.kolizie.length&&(r.kolizie=void 0),v.push(r),y.set(r.id,r)},i=0,r=n;i<r.length;i++){s(r[i])}var a=T.buildSubstOnlineTTItemsEx(g,e,t),o=new Map;a.map(function(e){return[e.id,e]});var l=new Map;if(a.forEach(function(e){o.set(e.id,e),e.join_substid2first&&e.join_substid2first.forEach(function(e,t){l.set(t,y.get(e))})}),t)v=v.filter(function(e){var t=o.get(e.ttitemid);if(t)return e.join_duration=t.durationperiods,!0;var n=l.get(e.id);return h.indexOf(e.stav)>h.indexOf(n.stav)&&(n.stav=e.stav),!1});else for(var c=0,u=v;c<u.length;c++){var d=u[c],m=o.get(d.ttitemid);(m.join_previd||m.join_nextid)&&(d.join_can=!0)}for(var p=0,b=w;p<b.length;p++){d=b[p];v.push(d)}return v.sort(function(e,t){return e.starttime<t.starttime?-1:1}),v}function S(e){if(!e.stav)return!1;if("movelesson"==e.stav&&0==T.coreTTItemOfSubst(e,!0).teacherids.length)return!1;return!0}(e.buildSubstExItems=s).npp=T.substOnlineNeededPartProvider(function(){return[B.TTItemTimeProvider,T.coreTTItemOfSubst,T.findTTItemFromSubstId,C.getSubstTTItemKolizie,T.buildSubstOnlineTTItemsEx,{substonline_substitutions:["date","absent","kolizie_ignored"],substonline_ttitems:["date"]}]}),e.buildSubstExCombo=function(e,t,n,s){if(!n)return null;if(!s)return null;var i=n.absent;if(!i)return null;var r=T.absentGetTable(i);if("classes"==r||"igroups"==r)return null;var a=T.absentGetId(i),o=n.changes.find(function(e){return T.changeColumn2table(e.column)==r&&e.old==a});return{table:r,items:l.substTTItemComboItems({table:r,ttitem:s,dbi:e,tt_dbi:t,remove_ttitemids:x.__spreadArrays([s.id],s.join_ttitemids||[]),topid:o?o.new:void 0})}};var i=(r.prototype.render=function(){var o=this,e=this.state,t=e.app_data,l=this.dbi,n=l.req,s=this.getDate(),i=this.getDateRow(),r=this.getSelectedSubst(),a=null;if(i.uploaded_int)a=A.createElement("div",{style:{flex:"0 0 auto",padding:"80px 20px"}},A.createElement("img",{src:"/substitution/pics/uploaded_32.png",style:{float:"left",margin:5}}),ASC.ls(2740),A.createElement("br",null),"(",A.createElement(I.DateTimeText,{datetime_int:i.uploaded_int}),","," ",A.createElement("span",{onClick:function(){return o.jsc.ASC_action("showDB","")},style:{cursor:"pointer"}},ASC.ls(3027)),")",A.createElement("br",null),A.createElement("br",null),l.tableFilterData("substonline_substitutions",{date:s}).find(function(e){return e.ttmatchfail})&&A.createElement(D,null,A.createElement("img",{src:"/substitution/pics/nomatch_32.png",style:{float:"left",margin:3}}),ASC.ls(2573)));else if(r){var c="",u="",d="",m="",p=this.getSelectedSubst();if(p&&(c=p.ttitemid,p.absent)){var b=T.absentGetTable(p.absent);if("teachers"==b||"classrooms"==b){u=b,d=T.absentGetId(p.absent);var h=p.changes.find(function(e){return T.changeColumn2table(e.column)==u&&e.old==d});h&&(m=h.new||"")}}var f=N.DBITools.removeEs(u)+(p.classroomsupervision?"id":"ids");a=A.createElement(_.TeachersView,{online:this,dbi:l,tt_dbi:this.tt_dbi,date:this.getDate(),ttitemid:c,table:u,topid:m,uiSettings:t.uiSettings,join_doubles:e.join_doubles,onRowDoubleClick:function(e){ASC.hideContextMenu(),p&&d&&o.showTTItemEditDlg(c,{select_change:{column:f,old:d,new:e}})},onRowPeriodClick:function(s,e){var i="new_"+N.DBITools.removeEs(u)+"id";e.stopPropagation();var t=[];t.push({text:ASC.ls(2105),icon:"/substitution/pics/ok_16.png",onclick:function(){return x.__awaiter(o,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return[4,M.updateSubstSubstitution(null,p.id,(t={},t[i]=s,t),1<p.join_duration)];case 1:return e.sent(),this.refresh(),[2]}})})}}),t.push([]);for(var n=function(n){t.push({text:ASC.escapeHTML(n.name),icon:l.table("substitution_types").icon(),checked:n.id==p.substitution_typeid,onclick:function(){return x.__awaiter(o,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return[4,M.updateSubstSubstitution(null,p.id,(t={},t[i]=s,t.substitution_typeid=n.id,t),1<p.join_duration)];case 1:return e.sent(),this.refresh(),[2]}})})}})},r=0,a=l.tableData("substitution_types");r<a.length;r++)n(a[r]);t.push([]),t.push({text:ASC.ttls(1034),icon:O.action_icon("edit"),onclick:function(){return o.showTTItemEditDlg(c,{select_change:{column:f,old:d,new:s}})}}),ASC.showContextMenu(t,e,e.target)}})}else a=A.createElement(A.Fragment,null,!i.tt_num&&A.createElement("div",{style:{flex:"0",padding:"80px 20px"}},A.createElement("img",{src:"/global/pics/ui/item_warning_32.png",style:{marginRight:10,verticalAlign:"middle"}}),ASC.ls(2005)),0<this.getAbsents().length&&A.createElement("div",{style:{flex:"0",padding:"80px 20px"}},ASC.ttls(2122)));g.render(A.createElement("div",{id:"fitheight",style:{display:"flex",flexDirection:"column"},className:I.classNames({subst_online_colorblind:l.rowData("user_at_settings",n.loggedUser).colorblind})},A.createElement(I.RDropZone,{className:"ribbon_d",onFile:function(e){return o.importFile(e,"multi")}},A.createElement(z,{online:this})),A.createElement("div",{style:{flex:"1 1 100px",height:100,minHeight:0},className:"content_d"},A.createElement(v.LeftPanel,{online:this}),A.createElement(I.AOUI,null,A.createElement(I.AOUI.FlexSplitPane,{vertical:!0})),A.createElement(I.RDropZone,{className:"subst_d",style:{flex:"1 1 100px",minWidth:0,display:"flex",flexDirection:"column"},onFile:function(e){o.importFile(e)}},A.createElement(P,{online:this}),"substs"==e.mode?A.createElement(Y,{online:this}):A.createElement($,{online:this,table:e.mode}),A.createElement(F,{online:this})),A.createElement(I.AOUI,null,A.createElement(I.AOUI.FlexSplitPane,{vertical:!0})),A.createElement("div",{className:"teachers_d",style:{display:"flex",flexDirection:"column",position:"relative"}},a,A.createElement(_.MenuIcon,{style:{position:"absolute",right:1,top:3},fa_icon:O.action_fa_icon("help"),onClick:function(e){return window.open("https://help.edupage.org/text.php?id=1880","_blank")},title:O.action_name("help")})))),this.app_d),this._first_render&&(this.initDD(),this._first_render=!1)},r.prototype.data=function(e,t,n,s,i){this.substs=n,this.state=x.__assign(x.__assign({},this.state),{date:e,app_data:i.app_data,tt:{classes:s.classes||{},teachers:s.teachers||{},classrooms:s.classrooms||{}}}),this.other=i},r.prototype.purchase=function(){this.jsc.purchase_action()},r.prototype.updateRibbon=function(){this.dateField.ASC_cal.fillRenderers(this.other.date_renderers)},r.prototype.initDD=function(){},r.prototype.importFile=function(a,o){return void 0===o&&(o=""),x.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r;return x.__generator(this,function(e){switch(e.label){case 0:return n=(t=this.jsc).ASC_action,s=["import"],i="cmd=upload&mode="+o+"&data=",r=encodeURIComponent,[4,I.file2base64(a)];case 1:return n.apply(t,s.concat([i+r.apply(void 0,[e.sent()])])),[2]}})})},r.prototype.getDate=function(){return this.state.date},r.prototype.getDateRow=function(){return this.dbi.rowData("substonline_dates",this.getDate())},r.prototype.getYear=function(){return ASC.getSchoolYear(this.getDate())},r.prototype.getAbsents=function(){return this.dbi.tableFilterData("substonline_absents",{date:this.getDate()})},r.prototype.getSubsts=function(){return this.dbi.tableFilterData("substonline_substitutions",{date:this.getDate()})},r.prototype.getSubstsEx=function(){return s(this.dbi,this.tt_dbi,this.getDate(),this.state.join_doubles)},r.prototype.getEvents=function(){return this.dbi.tableFilterData("events",{date:this.getDate()})},r.prototype.getTTItems=function(){return this.dbi.tableFilterData("substonline_ttitems",{date:this.getDate()})},r.prototype.getTableNameCol=function(e){return"teachers"==e?k.client_req.sort_name_col:"name"},r.prototype.fill=function(){return x.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a,o,l,c,u,d,m,p,b,h,f=this;return x.__generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,8,,9]),(t=this.state.app_data)?(n=this,[4,k.client_req.maindbi(t.year,{vt_filter:t.maindbi_vt_filter,accessor_result:t.maindbi_accessor_result})]):[2];case 1:return n.dbi=e.sent(),s=this,t.tt_num?[4,k.client_req.timetabledbi(t.tt_num,{accessor_result:t.ttdbi_accessor_result})]:[3,3];case 2:return i=e.sent(),[3,4];case 3:i=null,e.label=4;case 4:return s.tt_dbi=i,(r=this.getDateRow())||ASC.dieError("0402457372"),a=this,r.subst_dbid?[4,k.client_req.substdbi(r.subst_dbid,{tables:T.SubstApp_substdbi_needed_tables,columns:T.SubstApp_substdbi_needed_columns})]:[3,6];case 5:return o=e.sent(),[3,7];case 6:o=null,e.label=7;case 7:if(a.subst_dbi=o,l=this.getDate(),this.other.needs_regenerate=t.date_needsregenerate[l],this.other.date_renderers=t.date_renderers,this.naming_dbi=new N.MergeDBI(this.dbi,this.tt_dbi,this.subst_dbi),r.uploaded_int){for((c=new B.TTItemTimeProvider(this.dbi)).setDate(r,this.tt_dbi),this.substs=[],u=0,d=this.dbi.tableFilterData("substonline_substitutions",{date:l});u<d.length;u++)m=d[u],p=T.coreTTItemOfSubst(m),b=x.__assign(x.__assign({},m),{stav:"",ttitemid:"",starttime:c.provide(p).starttime}),m.ttmatchfail&&(b.stav="nomatch"),this.substs.push(b);this.substs.sort(function(e,t){return e.starttime<t.starttime?-1:e.starttime>t.starttime?1:0})}else this.substs=this.substs.map(function(e){var t=f.dbi.rowData("substonline_substitutions",e.id);return t.note,x.__assign(x.__assign({},e),{origofids:t.origofids,kolizie_ignored:t.kolizie_ignored,note:t.note})});return this.render(),"substs"==this.state.mode&&this.ribbonMenu.select("main"),[3,9];case 8:throw h=e.sent(),alert(h),h;case 9:return[2]}})})},r.prototype.getSelectedSubst=function(){for(var e=0,t=this.getSubstsEx();e<t.length;e++){var n=t[e];if(n.id==this.state.selectedSubstId)return n}return null},r.prototype.selectNextSubst=function(){for(var e=this.subst_dtr,t=this.state.selectedSubstId,n="",s=!1,i="",r=0,a=e.getSortedData();r<a.length;r++){var o=a[r],l=o.id;S(o.subst)||(n=n||l,s&&!i&&(i=l)),l==t&&(s=!0)}this.setState({selectedSubstId:i||n})},r.prototype.showTTItemEditDlg=function(i,r){return void 0===r&&(r={}),x.__awaiter(this,void 0,void 0,function(){var t,n,s;return x.__generator(this,function(e){switch(e.label){case 0:return t=this.dbi,(n=t.rowData(o,i)).cancelled&&1==n.origofids.length?(s=n.origofids[0]).split(":")[0]!=this.getDate()?[3,1]:(i=s,n=t.rowData(o,i),[3,3]):[3,3];case 1:return[4,this.showMoveSubstDlg(n.substids[0])];case 2:return e.sent(),[2];case 3:return 1==n.substids.length&&T.substIsAddCard(t.rowData(u,n.substids[0]))?[4,a.showSubstEditAddCardDlg(this.getYear(),n.substids[0],{online:this,date:this.getDate()})]:[3,5];case 4:return e.sent()&&this.refresh(),[2];case 5:return 0<n.origofids.length&&ASC.dieError("8792878433"),n.origsubstid&&n.substids.indexOf(n.origsubstid)<0?(alert("TODO origsubstid presun"),[2]):[4,I.RDialog.show(y.SubstEditTTItemDlg,{dbi:this.dbi,tt_dbi:this.tt_dbi,ttitemid:i,select_change:r.select_change,join_doubles:this.state.join_doubles})];case 6:return e.sent()&&this.refresh(),[2]}})})},r.prototype.showSubstEditDlg=function(s,i){return void 0===i&&(i={}),x.__awaiter(this,void 0,void 0,function(){var t,n;return x.__generator(this,function(e){switch(e.label){case 0:return(t=s?this.dbi.rowData(u,s):null)||!i.addcard?[3,2]:[4,a.showSubstEditAddCardDlg(this.getYear(),s,{online:this,date:this.getDate()})];case 1:return e.sent()&&this.refresh(),[2];case 2:return(n=i.select_change)&&!n.old&&t.absent&&(n=x.__assign(x.__assign({},n),{old:T.absentGetId(t.absent)})),[4,this.showTTItemEditDlg(T.findTTItemFromSubstId(this.getTTItems(),s,t.cancelled).id,{select_change:n})];case 3:return e.sent(),[2]}})})},r.prototype.tt_showChangelessonDlg=function(s,i,r,a){return x.__awaiter(this,void 0,void 0,function(){var n,t;return x.__generator(this,function(e){switch(e.label){case 0:return n=this.dbi,1<(t=this.getTTItems().filter(function(e){return e.uniperiod==r&&!!T.substTTItem_filter_match(e,s,i)})).length&&(t=t.filter(function(e){var t=n.rowName("subjects",e.subjectid,"short");return t+=" ",t+=n.rowNames("classes",e.classids,"short"),0<e.groupnames.length&&!N.DBITools.groupnamesIsEntireClass(e.groupnames)&&(t+=" ("+n.tools.groupnames_names(e.groupnames)+")"),t+=" ",t+=n.rowNames("teachers",e.teacherids,"short"),t+=" ",(t+=n.rowNames("classrooms",e.classroomids,"short"))==a})),1!=t.length?[3,2]:[4,this.showTTItemEditDlg(t[0].id)];case 1:return e.sent(),[2];case 2:return ASC.dieError("5490214653"),[2]}})})},r.prototype.checkUploaded=function(t){return x.__awaiter(this,void 0,void 0,function(){return x.__generator(this,function(e){return t=t||this.getDate(),[2,j.checkUploaded(this.dbi,t)]})})},r.prototype.showAbsentEditDlg=function(t,n){return void 0===n&&(n={}),x.__awaiter(this,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,this.checkUploaded(t?t.split(":")[0]:"")];case 1:return e.sent()?[2]:[4,Promise.resolve().then(function(){return require("./online/subst_dlg")})];case 2:return[4,e.sent().showSubstAbsentDlg(this.getYear(),"substonline_absents",t,{date:this.getDate(),online:this,row:{period:n.period,durationperiods:n.durationperiods,groupname:n.groupname},teacherids:n.teacherids,classids:n.classids,classroomids:n.classroomids})];case 3:return e.sent()&&this.refresh(),[2]}})})},r.prototype.showEventEditDlg=function(e){var t=e.split(":"),n=t[0],s=t[1];this.getDate()==n?this.jsc.ASC_action("event","subId="+s):ASC.dieError("1951357901")},r.prototype.showEventsDlg=function(){this.jsc.ASC_action("events","")},r.prototype.showAbsentDeleteDlg=function(i){return x.__awaiter(this,void 0,void 0,function(){var t,n,s;return x.__generator(this,function(e){switch(e.label){case 0:return t=k.client_req,[4,this.checkUploaded()];case 1:return e.sent()?[2]:(n=this.dbi.rowData("substonline_absents",i),s=t.ttls(2117),n&&"teachers"!=n.table&&(s=O.action_name("delete")+" - "+t.ls(1054)),[4,I.RDialog.showConfirm(s)]);case 2:return e.sent()?[4,M.removeAbsent(null,i)]:[3,4];case 3:e.sent(),this.refresh(),e.label=4;case 4:return[2]}})})},r.prototype.showDayNoteDlg=function(){return x.__awaiter(this,void 0,void 0,function(){var t,n,s;return x.__generator(this,function(e){switch(e.label){case 0:return t="substonline_dates",n=this.dbi.rowData(t,this.getDate()),[4,I.RDialog.showInput({id:this.getDate(),subst_note:n.subst_note},function(e){return A.createElement(I.RTextArea,{valueRef:I.subRef(e.stateRef,"subst_note"),style:{height:100,width:"100%"}})},{header:this.dbi.column(t,"subst_note").name()})];case 1:return(s=e.sent())?N.DBITools.rowChanges2write(n,s)?[4,ASC.blockUI(this.dbi.backend.updateRow(t,s))]:[3,3]:[2];case 2:e.sent(),this.refresh(),e.label=3;case 3:return[2]}})})},r.prototype.showDayDeleteDlg=function(){return x.__awaiter(this,void 0,void 0,function(){var t,n,s;return x.__generator(this,function(e){switch(e.label){case 0:return t=k.client_req,n=this.getDate(),s=t.ls(2741)+" ("+t.lib_date.date_format_date(n)+") - "+t.ls(1054),[4,I.RDialog.showConfirm(s)];case 1:return e.sent()?[4,M.deleteSubstDay(null,n,{log_module:"SubstOnline"})]:[3,3];case 2:e.sent(),this.refresh(),e.label=3;case 3:return[2]}})})},r.prototype.showTimetableDlg=function(s,i,r){return void 0===r&&(r={}),x.__awaiter(this,void 0,void 0,function(){var t,n=this;return x.__generator(this,function(e){switch(e.label){case 0:return i||(t=N.DBITools.splitItemsForCombo(this.dbi.tableData(s),this.getDate())[0],i=t&&t.id||""),[4,I.RDialog.show(C.SubstTimetableDlg,{table:s,id:i,date:this.getDate(),move_substid:r.move_substid,onGoToDate:function(e){return n.goToDate(e)},join_doubles:this.state.join_doubles})];case 1:return e.sent(),this.refresh(),[2]}})})},r.prototype.showPermanentTimetableDlg=function(t,n){return void 0===t&&(t=""),void 0===n&&(n=""),x.__awaiter(this,void 0,void 0,function(){return x.__generator(this,function(e){return this.jsc.ASC_action("timetable","table="+t+"&id="+n),[2]})})},r.prototype.showMoveSubstDlg=function(r){return x.__awaiter(this,void 0,void 0,function(){var t,n,s,i;return x.__generator(this,function(e){switch(e.label){case 0:return 0<(t=this.dbi.rowData(u,r)).origofids.length?(r=t.origofids[0],[4,ASC.blockUI(this.dbi.backend.rowData(u,r,T.SubstApp_maindbi_needed_columns))]):[3,2];case 1:t=e.sent(),e.label=2;case 2:return t?(s=n="",0<(i=T.subst_item_tableIds(t,"classes")).length&&(n="classes",s=i[0]),n&&s?[4,this.showTimetableDlg(n,s,{move_substid:r})]:[3,4]):[3,4];case 3:e.sent(),e.label=4;case 4:return[2]}})})},r.prototype.showNotifications=function(){return x.__awaiter(this,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../timeline/notifications")})];case 1:return e.sent().showGenericNotifications("substitution",ASC.ls(1003)),[2]}})})},r.prototype.showAbsentLessons=function(s){return x.__awaiter(this,void 0,void 0,function(){var t,n;return x.__generator(this,function(e){switch(e.label){case 0:return n=(t=I.RDialog).showComponent,[4,Promise.resolve().then(function(){return require("./online/absentlessons")})];case 1:return[4,n.apply(t,[e.sent().AbsentLessonsDlg,{online:this,absent:s}])];case 2:return e.sent(),[2]}})})},r.prototype.refresh=function(){this.jsc.ASC_action("refresh","")},r.prototype.goToDate=function(e){this.jsc.ASC_action("date","date="+e)},r.prototype.setState=function(e){"function"==typeof e&&(e=e(this.state)),this.state=x.__assign(x.__assign({},this.state),e),this.render()},r.prototype.setMode=function(e){this.setState({mode:e,selectedOtherId:""})},r.prototype.modeInfo=function(e){var t=0<=["absent_types","substitution_types","approbations"].indexOf(e);return{editable:t,sortable:!1,item_edit:t}},r.prototype.timetableMenu=function(e,t){var n=this;return[{text:O.action_name("timetable")+" + "+O.action_name("substitution"),icon:O.action_icon("timetable"),onclick:function(){return n.showTimetableDlg(e,t)}},{text:ASC.ls(8735),icon:O.action_icon("timetable"),onclick:function(){return n.showPermanentTimetableDlg(e,t)}}]},r.prototype.showFeedbackDlg=function(){barNewDialog({source:"/znamky/?jwgc=ZnamkyFeedbackDialog"})},r.prototype.clickSet_tcards_subst=function(a){return void 0===a&&(a=void 0),x.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r;return x.__generator(this,function(e){switch(e.label){case 0:return t=this.dbi,n=this.getDateRow(),s=n.id,i=t.rowData("global_settings","1"),r=i.subst_online.tcards_subst,void 0===a&&(a=!r,n.uploaded_int||(a=!n.tcards_subst)),[4,I.RDialog.showConfirm(A.createElement(A.Fragment,null,O.action_name(a?"activate":"deactivate"),k.client_req.localize(": {6724} - {1003}"),A.createElement("br",null),O.action_name("date"),": ",k.client_req.lib_date.date_format_date(s),A.createElement("br",null),A.createElement("br",null),k.client_req.ls(1054)))];case 1:return e.sent()?r==a?[3,3]:[4,ASC.blockUI(t.backend.updateRow("global_settings",{id:"1",subst_online:{tcards_subst:a}}))]:[2];case 2:e.sent(),e.label=3;case 3:return n.tcards_subst==a?[3,5]:[4,ASC.blockUI(M.setDateTcardsSubst(null,s,a))];case 4:e.sent(),e.label=5;case 5:return this.refresh(),[2]}})})},r);function r(e){this.jsc=e,this.substs=[],this.other={},this.debug=!1,this.subst_dtr=null,this.experimetal_features=!1,this.state=x.__assign({},n),this._first_render=!0,this.experimetal_features=ASC.asc&&0<=["ascpalo","democz","vassboskovice"].indexOf(ASC.edupage),this.app_d=e.app_d}function z(e){var t=this,n=e.online,s=n.state,i=n.dbi,r=s.mode,a=k.client_req,o=n.getDate(),l=ASC.getSchoolYear(o),c=n.modeInfo(s.mode),u=!(!c||!c.editable);I.useLockBodyScroll();var d=[];"officialtimetables"==s.mode&&s.app_data.tt_admin&&(d.length&&d.push([]),d.push({text:ASC.ls(1001),icon:n.dbi.table("officialtimetables").icon(),submenu:[{text:ASC.ls(1059),icon:"/global/pics/ui/verify_32.png",onclick:function(){n.jsc.ASC_action("tt_verify","id="+s.selectedOtherId)}}]})),n.getDateRow().uploaded_int&&(d.length&&d.push([]),d.push({text:"PC "+ASC.ls(1003),icon:"/global/pics/ui/subst_32.png",submenu:[{text:ASC.ls(3027),icon:"/customize/pics/gridedit.png",onclick:function(){n.jsc.ASC_action("showDB","")}}]})),"substs"==r&&(n.getDateRow().uploaded_int||!0!==n.other.needs_publish&&!n.getAbsents().length&&!n.getSubsts().length||(d.length&&d.push([]),d.push({text:ASC.ls(3988),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.ui.Dialog.areYouSureDlg(ASC.ls(3988))];case 1:return e.sent()?[4,ASC.blockUI(M.unpublishDay(null,n.getDate()))]:[3,3];case 2:e.sent(),n.refresh(),e.label=3;case 3:return[2]}})})}}))),d.length&&d.push([]);var m=i.rowData("global_settings","1").subst_online.tcards_subst;d.push({text:k.client_req.localize("{6724} - {1003} (beta)"),checked:m,onclick:function(){return n.clickSet_tcards_subst(!m)}}),d.length&&d.push([]);var p=i.rowData("user_at_settings",k.client_req.loggedUser).colorblind;d.push({text:k.client_req.ls(3149),submenu:[{text:k.client_req.ls(3150),checked:p,onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,i.backend.updateRow("user_at_settings",{id:k.client_req.loggedUser,colorblind:!p})];case 1:return e.sent(),n.refresh(),[2]}})})}}]});var b=[];("de"==ASC.school_country&&("2018-08-01"<=ASC.date_today()||"edupage15"==ASC.server)||ASC.ascdevelop||ASC.ascdebug)&&(b.push({text:"NRW - UntStat",onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../exports/de_nrw/weekstats")})];case 1:return[2,e.sent().showNRW_WeekStatsDlg(k.client_req.lib_date.date_week(o))]}})})}}),b.push({text:"Bayern - Statistik",onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../exports/de_by/bayern_weekstats")})];case 1:return[2,e.sent().showBayern_WeekStatsDlg(k.client_req.lib_date.date_week(o))]}})})}}));var h=[{text:a.ttls(2076)+" - "+a.ls(1929),onclick:function(){return n.jsc.ASC_action("print","type=substinfo_teachers")},icon:"/substitution/pics/subst_daily.png"},{text:a.ttls(2076)+" - "+a.ls(1930),onclick:function(){return n.jsc.ASC_action("print","type=substinfo_classes")},icon:"/global/pics/ui/student_32.png"},{text:a.ttls(2114),onclick:function(){return n.jsc.ASC_action("print","type=substitutionsummary")},icon:"/substitution/pics/missing2_128.png"},{text:a.ttls(2079),onclick:function(){return n.jsc.ASC_action("print","type=absentsummary")},icon:"/substitution/pics/parameters_32.png"},[],{text:a.ls(1641),onclick:function(){return n.jsc.ASC_action("print","")}},[],{text:"("+a.ls(1470)+") "+a.ttls(2076),onclick:function(){return n.jsc.ASC_action("print","type=substitution2teachers")},icon:"/substitution/pics/subst_daily.png"},{text:"("+a.ls(1470)+") "+a.ttls(2077),onclick:function(){return n.jsc.ASC_action("print","type=substitution2students")},icon:"/global/pics/ui/student_32.png"}],f=[{text:a.ls(1337),onclick:function(){return n.jsc.ASC_action("send","msgType=email")}},{text:a.ls(1346),onclick:function(){return n.jsc.ASC_action("send","msgType=sms")}}],g=n.getSubstsEx().filter(function(e){return!S(e)}).length;return A.createElement(I.AOUI,null,A.createElement(I.AOUI.RibbonMenu,{ref:function(e){return n.ribbonMenu=e}},A.createElement(I.AOUI.Ribbon,{title:ASC.ttls(3222),key:"main"},A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:"",icon:Z("previous_32"),onclick:function(){n.goToDate("prev")}}),A.createElement(I.AOUI.RibbonDiv,null,A.createElement(I.AOUI,null,A.createElement(I.AOUI.DateField,{style:"background-image: none; width:80px;text-align:center",value:n.getDate(),ref:function(e){return n.dateField=e},onchange:function(){n.goToDate(n.dateField.value)},highlightdates:n.other.date_renderers||[]})),A.createElement("br",null),A.createElement("div",{ref:function(e){return n.dateDay=e},style:{textAlign:"center",marginTop:"10px"}},ASC.ASC_date2str_day(n.getDate()))),A.createElement(I.AOUI.RibbonButton,{label:"",icon:Z("next_32"),onclick:function(){n.goToDate("next")}})),(1<i.tableData(w).length||s.buildingid)&&A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:s.buildingid?i.rowName(w,s.buildingid):i.table(w).name(),icon:i.table(w).icon(),menu:x.__spreadArrays([{text:ASC.ls(1349),checked:!s.buildingid,onclick:function(){n.setState({buildingid:""})}},[]],i.tableIds(w).map(function(e){return{text:i.rowName(w,e),checked:e==s.buildingid,onclick:function(){n.setState({buildingid:e})}}}))})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ttls(1995),icon:Z("patient_ok_32"),menu:[{text:ASC.ttls(3806),onclick:function(){n.showAbsentEditDlg("")}}]}),A.createElement(I.AOUI.RibbonButton,{label:g?ASC.ttls(3800)+"\n("+g+")":ASC.ls(1341),icon:g?Z("next_subs_32"):"/global/pics/ui/item_ok_32.svg",onclick:function(){n.selectNextSubst()}})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ttls(3798),icon:Z("tools_32"),menu:[{text:ASC.ls(1783),onclick:function(){n.jsc.ASC_action("generate","")},icon:Z("gener_32")},{text:ASC.ttls(3795),onclick:function(){n.showDayNoteDlg()},icon:"/substitution/pics/daily_remark_32.png"},{text:ASC.ttls(3794),onclick:function(){I.RDialog.showComponent(y.ChangeOtherLessonDlg,{app:n})},icon:"/global/pics/ui/modified_32.svg"},{text:ASC.ttls(3793),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return(t=n.getSelectedSubst())?[4,j.showSubstDeleteDlg(n.dbi,t.id,n.state.join_doubles)]:[3,2];case 1:e.sent()&&n.refresh(),e.label=2;case 2:return[2]}})})},icon:Z("del_32")},{text:ASC.ttls(3784),onclick:function(){n.showSubstEditDlg("",{addcard:!0})},icon:T.ICON_subst_addlesson},[],{text:ASC.ls(2741),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){return n.showDayDeleteDlg(),[2]})})},icon:"/global/pics/ui/delete2_32.png"}]}),A.createElement(I.AOUI.RibbonButton,{label:O.action_name("timetable"),icon:O.action_icon("timetable"),menu:x.__spreadArrays(["classes","teachers","classrooms","igroups"].filter(function(e){return 0<i.tableData(e).length}).map(function(e){var t=i.table(e);return{text:t.name(),icon:t.icon(),onclick:function(){return n.showTimetableDlg(e,"")}}}),[[],{text:ASC.ls(8735),onclick:function(){return n.showPermanentTimetableDlg()},icon:O.action_icon("timetable")}])})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1638),icon:Z("print_preview_32"),menu:h}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1590),icon:Z("email_32"),menu:f}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(4159),icon:"/global/pics/ui/notifications_32.png",onclick:function(){return n.showNotifications()}}),0<b.length&&A.createElement(I.AOUI.RibbonButton,{label:O.action_name("export"),icon:O.action_icon("export"),menu:b})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1989),icon:Z("home_32"),onclick:function(){window.open("/substitution/?date="+n.getDate(),"_blank")}})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1077),icon:Z("onlinehelp_32"),onclick:function(){window.open("https://help.asctimetables.com/text.php?id=1020&lang="+k.client_req.lang,"_blank")}}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1593),icon:Z("help_32"),onclick:function(){n.showFeedbackDlg()}})),A.createElement(I.AOUI.RibbonGroup,{right:!0},A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1347),icon:Z("refresh_32"),onclick:function(){n.refresh()}}))),A.createElement(I.AOUI.Ribbon,{title:ASC.ls(1637),key:"settings"},A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1748),icon:Z("back_32"),onclick:function(){n.ribbonMenu.select("main"),"substs"!=r&&n.setMode("substs")}})),A.createElement(I.AOUI.RibbonGroup,null,E.map(function(e){var t=n.dbi.table(e);return A.createElement(I.AOUI.RibbonButton,{key:e,label:t.name(),icon:t.icon(),selected:e==r,onclick:function(){n.setMode(e)},id:"mode_"+e})})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1257),icon:Z("add_32"),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../rpr/maindbi_ui")})];case 1:return[4,e.sent().showMainDbiItemDlg(l,r,"")];case 2:return e.sent(),n.refresh(),[2]}})})},mini:!0,enabled:u}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1053),icon:Z("edit_32"),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return(t=s.selectedOtherId)?[4,Promise.resolve().then(function(){return require("../rpr/maindbi_ui")})]:[3,3];case 1:return[4,e.sent().showMainDbiItemDlg(l,r,t)];case 2:e.sent(),n.refresh(),e.label=3;case 3:return[2]}})})},mini:!0,id:"other_edit",enabled:u||!(!c||!c.item_edit)}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1047),icon:Z("del_32"),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return(t=s.selectedOtherId)?[4,Promise.resolve().then(function(){return require("../rpr/maindbi_ui")})]:[3,3];case 1:return[4,e.sent().showMainDbiRemoveDlg(l,r,t)];case 2:e.sent(),n.refresh(),e.label=3;case 3:return[2]}})})},mini:!0,enabled:u})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ttls(3796),icon:Z("dayintimetable_32"),onclick:function(){n.jsc.ASC_action("days","")}}),A.createElement(I.AOUI.RibbonButton,{label:k.client_req.ls(6737),icon:Z("settings_basic_32"),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(Promise.resolve().then(function(){return require("./online/settings")}))];case 1:return[4,e.sent().showSubstSettingsCriteriaDlg()];case 2:return e.sent(),n.refresh(),[2]}})})}}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1989),icon:Z("home_32"),onclick:function(){return x.__awaiter(t,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(Promise.resolve().then(function(){return require("./viewerAdmin")}))];case 1:return e.sent().showSubstViewerAdminSettingsDlg(),[2]}})})}}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1601),icon:Z("settings_adv_32"),menu:d,id:"advanced"}))),A.createElement(I.AOUI.Ribbon,{title:ASC.ls(1077),key:"help"},A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1748),icon:Z("back_32"),onclick:function(){n.ribbonMenu.select("main"),"substs"!=r&&n.setMode("substs")}})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ttls(2797),icon:Z("register_32"),onclick:function(){n.purchase()}})),A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1077),icon:Z("onlinehelp_32"),onclick:function(){window.open("https://help.edupage.org/#921","_blank")}}),A.createElement(I.AOUI.RibbonButton,{label:ASC.ls(1593),icon:Z("help_32"),onclick:function(){n.jsc.ASC_action("feedback","")}})),n.jsc.asc_menu&&A.createElement(I.AOUI.RibbonGroup,null,A.createElement(I.AOUI.RibbonButton,{label:"ASC tools",icon:"/global/pics/ui/settings_adv_32.png",menu:x.__spreadArrays(n.jsc.asc_menu)})))))}function p(e){var t=e.subst,n=e.dbi,s=T.subst_item(t),i=n.tools.ttitem_popis(s);return A.createElement("div",null,A.createElement("span",null,i.period)," - ",i.class,", ",i.teacher," (",i.classroom,")")}function P(e){var t=this,i=e.online,n=i.state,r=i.getDate(),a=i.dbi,s=null;if("substs"==n.mode){var o=i.other.needs_regenerate;if(o){var l="Substitution needs to be regenerated. (There was probably some change in the timetable, Edupage database, etc.)";"de"==ASC.lang&&(l="Die Vertretung muss neu aufgebaut werden. (Scheinbar gab es im Stundenplan oder in der Edupage Datenbank VerĂ¤nderungen o.Ă¤.)"),"sk"!=ASC.lang&&"cz"!=ASC.lang||(l="Suplovanie je potrebnĂ© pregenerovaĹĄ. (Pravdepodobne doĹˇlo ku zmene rozvrhu, Edupage databĂˇzy a podobne...)"),s=A.createElement(A.Fragment,null,A.createElement(I.RButton,{label:ASC.ls(2790),icon:"/global/pics/ui/reload_32.png",onClick:function(){return x.__awaiter(t,void 0,void 0,function(){var t,n,s;return x.__generator(this,function(e){switch(e.label){case 0:return t={marginBottom:20},[4,I.RDialog.showMessage(A.createElement("div",{style:{overflow:"auto",flex:"1 1",minHeight:100}},A.createElement("h1",null,ASC.ls(2790)),A.createElement("div",null,A.createElement("b",null,ASC.ls(1920),":")),A.createElement("div",{style:{paddingLeft:15,maxHeight:600,overflow:"auto"}},0<o.remove_substids.length&&A.createElement("div",{style:t},A.createElement("div",null,O.action_name("delete"),":"),o.remove_substids.map(function(e){return A.createElement(p,{key:e,subst:a.rowData(u,e)||{},dbi:a})})),0<o.update_substs.length&&A.createElement("div",{style:t},A.createElement("div",null,ASC.ls(7722),":"),o.update_substs.map(function(e,t){return A.createElement(p,{key:""+t,subst:x.__assign(x.__assign({},a.rowData(u,e.id)||{}),e),dbi:a})})),0<o.add_substs.length&&A.createElement("div",{style:t},A.createElement("div",null,O.action_name("add"),":"),o.add_substs.map(function(e,t){return A.createElement(p,{key:""+t,subst:e,dbi:a})})))),{buttons:["ok","cancel"],width:500})];case 1:return e.sent()?(s=(n=ASC).blockUI,[4,Promise.resolve().then(function(){return require("./server/generator")})]):[3,4];case 2:return[4,s.apply(n,[e.sent().regenerateDay(null,r)])];case 3:e.sent(),i.refresh(),e.label=4;case 4:return[2]}})})}}),l)}else if(i.other.needs_publish){var c=!0===i.other.needs_publish?ASC.ls(2744):ASC.lsf(2827,{n:i.other.needs_publish});s=A.createElement(D,null,A.createElement("span",{style:{marginRight:"10px"}},c),A.createElement(I.RButton,{label:ASC.ls(1587),icon:"/global/pics/ui/item_ok_32.svg",onClick:function(){i.jsc.ASC_action("publish","")}}),i.other.needs_publish?A.createElement(I.RButton,{label:ASC.ls(1038),icon:"/global/pics/ui/item_bad_32.svg",onClick:function(){i.jsc.ASC_action("revert","")}}):null)}}return A.createElement(I.AnimatedCollapseDiv,{duration:.5,className:"info_top",style:{height:"32px"},collapsed:!s},s)}function F(e){var r=e.online;if("substs"!=r.state.mode)return null;var t=r.dbi,n=r.tt_dbi,s=[],i="",a=r.getDateRow();if(a.tt_num){i=ASC.ls(1001)+": "+t.rowName("officialtimetables",""+a.tt_num);for(var o=0,l=[["tt_term","terms"],["tt_week","weeks"],["tt_day","days"]];o<l.length;o++){var c=l[o],u=c[0],d=c[1];n.tableData(d).length<2||(i+=", "+n.rowName(d,a[u]))}s=a.subst_problems}var m=null,p=t.rowData("global_settings","1").subst_online.tcards_subst;return a.tcards_subst!=p?m=A.createElement(A.Fragment,null,A.createElement("br",null),ASC.ls(6724),": ",a.tcards_subst?ASC.ls(1671):ASC.ls(1686)," (",A.createElement("a",{style:{cursor:"pointer"},onClick:function(){return r.clickSet_tcards_subst(p)}},p?ASC.ls(1669):ASC.ls(1670)),")"):a.tcards_subst&&(m=ASC.ls(6724)),a.published_int&&(i+="\n("+ASC.ls(3279)+": "+new Date(1e3*a.published_int).toLocaleString()+")"),A.createElement("div",{className:"info"},0<s.length&&A.createElement(A.Fragment,null,ASC.ls(2025)+": ",s.map(function(e,t){var n={},s=null,i=ASC.ls(6370);return"warning"!=e.level&&(n={color:"red",fontWeight:"bold",fontSize:"150%"}),"unlinked"==e.type&&(s=function(){r.jsc.ASC_action("tt_verify","")},i=ASC.ls(1001)+" - "+ASC.ls(1059)),A.createElement(A.Fragment,null,0<t&&", ",A.createElement("span",{style:n},e.text,s&&A.createElement("span",{style:{cursor:"pointer",marginLeft:"5px",whiteSpace:"nowrap",color:"#808080",textDecoration:"underline"},onClick:s},i)))}),A.createElement("br",null)),i,m&&A.createElement(A.Fragment,null,", ",m),A.createElement("br",null),a.subst_note&&A.createElement("span",{onClick:function(){return r.showDayNoteDlg()},style:{cursor:"pointer"}},ASC.ttls(3795),": ",(""+a.subst_note).replace(/\n/g,"â†˛ ").replace(/\r/g,"")))}e.Online=i,e.KoliziaUpdater=function(v){return function(){try{var e=v.kolizia_d,t=v.subst_g;e.innerHTML="";for(var n=[],s=[],i=[],r=0;r<v.subst_g.kt_other.length;r++){var a=v.subst_g.kt_other[r];s.push(a);for(var o=0;o<a.kt.length;o++){var l="*** "+a.name+" *** "+a.kt[o];ASC.indexOf(n,l)<0&&n.push(l)}}var c={teacherids:"teachers",teacherid:"teachers",classroomids:"classrooms"};for(var u in c){var d=c[u],m="cv_"+u;if(v[m]){var p=v[m].value,b=t["combo_"+d];for(r=0;r<b.items.length;r++){if((a=b.items[r]).id==p){if(a.fo){var h=!0;if("classroomids"==u)for(o=0;o<i.length;o++)for(var f=i[o],g=0;g<f.kt.length;g++)0<=ASC.indexOf(a.kt,f.kt[g])&&(h=!1);h&&s.push(a)}a.fj&&i.push(a);for(o=0;o<a.kt.length;o++){l="*** "+a.name+" *** "+a.kt[o];ASC.indexOf(n,l)<0&&n.push(l)}}}}}var _=!1;0<i.length&&(_="/substitution/pics/plus_16.png"),s.length&&(_="/substitution/pics/no_16.png"),_&&(ASC.createChild(e,"img","","float:left; margin: 3px").src=_);for(r=0;r<n.length;r++)ASC.createText(e,n[r]),ASC.createChild(e,"br")}catch(e){alert(e)}}};var c,b=(c=A.Component,x.__extends(f,c),f.prototype.componentDidMount=function(){this.doUpdate()},f.prototype.componentDidUpdate=function(){this.doUpdate()},f.prototype.render=function(){return this.props.children},f.prototype.doUpdate=function(){var e=g.findDOMNode(this),t=e&&e.parentElement;t&&("TD"!=t.tagName&&ASC.dieError("7539815024",[t.tagName,t]),t.className=this.props.className)},f);function f(){return null!==c&&c.apply(this,arguments)||this}function L(e){return A.createElement(D,null,A.Children.map(e.children,function(e,t){return A.createElement(D,{key:""+t},0<t&&", ",e)}))}function G(e){var t=e.dbi,n=e.table,s=e.id,i=e.name_col,r="short"==i?"name":"short";return A.createElement("span",{style:e.style,title:t.rowName(n,s,r)},t.rowName(n,s,i))}function q(e){var t=e.dbi,n=e.table,s=e.origid,i=e.changes,r=e.name_col,a=s?i.find(function(e){return T.changeColumn2table(e.column)==n&&e.old==s}):void 0;return a?A.createElement(D,null,A.createElement(G,{dbi:t,table:n,id:s,name_col:r})," âž”  ",a.new?A.createElement(G,{dbi:t,table:n,id:a.new,name_col:r,style:{fontWeight:"bold"}}):A.createElement("span",null,"(X)")):A.createElement(G,{dbi:t,table:n,id:s,name_col:r})}function H(e){var n=e.dbi,s=e.table,t=e.origids,i=e.changes,r=e.name_col;return A.createElement(b,{className:i.some(function(e){return T.changeColumn2table(e.column)==s})?"change":""},A.createElement(L,null,x.__spreadArrays(t.map(function(e,t){return A.createElement(q,{key:""+t,dbi:n,table:s,origid:e,changes:i,name_col:r})}),i.filter(function(e){return T.changeColumn2table(e.column)==s&&t.indexOf(e.old)<0}).map(function(e,t){return A.createElement(D,{key:"a"+t},"+",A.createElement(G,{dbi:n,table:s,id:e.new,name_col:r,style:{fontWeight:"bold"}}))}))))}function V(e){var t=e.online,n=e.table,s=e.subst,i=t.naming_dbi,r="short",a=T.subst_item_tableIds(s,n),o=s.card||s.tcard;if(o)return"classes"==n&&s.tcard&&s.tcard.igroupid?A.createElement(G,{dbi:i,table:"igroups",id:s.tcard.igroupid,name_col:r}):A.createElement(D,null,A.createElement(H,{dbi:i,table:n,origids:a,changes:s.cancelled?[]:s.changes,name_col:r}),"classes"==n&&o.groupnames&&0<o.groupnames.length&&!N.DBITools.groupnamesIsEntireClass(o.groupnames)&&" "+i.tools.groupnames_names(o.groupnames));if(s.classroomsupervision){if("classes"==n)return A.createElement(D,null,"-");if("subjects"==n)return A.createElement(D,null,ASC.ttls(3294));if("teachers"==n)return A.createElement(H,{dbi:i,table:n,origids:a,changes:s.changes,name_col:r});if("classrooms"==n)return A.createElement(G,{dbi:i,table:n,id:s.classroomsupervision.classroomid,name_col:r})}return null}function W(e){var t=e.online,n=e.table,s=e.ttitem;if(!s)return A.createElement(A.Fragment,null,"Error1053608384");var i=t.naming_dbi,r="short",a=s.orig||s,o=T.substTTItem_tableIds(a,n);return"classroomsupervision"!=s.type?"classes"==n&&a.igroupid?A.createElement(G,{dbi:i,table:"igroups",id:a.igroupid,name_col:r}):A.createElement(D,null,A.createElement(H,{dbi:i,table:n,origids:o,changes:s.cancelled?[]:s.changes,name_col:r}),"classes"==n&&0<s.groupnames.length&&!N.DBITools.groupnamesIsEntireClass(s.groupnames)&&" "+i.tools.groupnames_names(s.groupnames)):"classes"==n?A.createElement(D,null,"-"):"subjects"==n?A.createElement(D,null,ASC.ttls(3294)):"teachers"==n?A.createElement(H,{dbi:i,table:n,origids:o,changes:s.changes,name_col:r}):"classrooms"==n?A.createElement(G,{dbi:i,table:n,id:a.classroomids[0],name_col:r}):null}function K(e){var t=e.row,n=0,s=0,i=ASC.getSchoolYear(t.datefrom||t.dateto||"2000-01-01"),r=k.client_req.schoolYear_turnOver(i);return t.datefrom&&(n=ASC.date_diff(t.datefrom,r)/365*100),t.dateto&&(s=ASC.date_diff(t.dateto,r)/365*100),A.createElement(D,null,A.createElement("div",{style:{backgroundColor:"rgba(0,0,0,0.2)",height:2,marginTop:-4,marginLeft:n+"%",marginRight:100-s+"%"}}),ASC.ASC_date2str(t.datefrom)+" - "+ASC.ASC_date2str(t.dateto))}function Y(e){var a=this,o=e.online,r=o.dbi,l=o.naming_dbi,c=o.state.join_doubles,t=1;window.innerWidth,t=.7;var n=o.getDateRow(),u=o.getTTItems(),s=o.getSubstsEx().map(function(e){var t=T.coreTTItemOfSubst(e),n=T.coreTTItemOfSubst(e,!0),s={id:e.id,stav:e.stav,subst:e,ttitem:T.findTTItemFromSubstId(u,e.id,e.cancelled),item_orig:T.coreTTItemOfSubst(e),item_new:T.coreTTItemOfSubst(e,!0),popis_orig:r.tools.ttitem_popis(t),popis_new:r.tools.ttitem_popis(n)};if(c&&e.join_duration){var i=e.join_duration-1;s.popis_orig.period+="-"+r.rowName("periods",N.DBITools.uniperiod_delta(t.uniperiod,i)),s.popis_new.period+="-"+r.rowName("periods",N.DBITools.uniperiod_delta(n.uniperiod,i))}return s}),i=o.state.buildingid;if(i){for(var d={classrooms:new Set,classes:new Set,igroups:new Set,teachers:new Set},m=0,p=r.tableData("classrooms");m<p.length;m++){(f=p[m]).buildingid==i&&d.classrooms.add(f.id)}for(var b=0,h=r.tableData("classes");b<h.length;b++){var f=h[b];d.classrooms.has(f.classroomid)&&(d.classes.add(f.id),f.teacherid&&d.teachers.add(f.teacherid))}for(var g=0,_=r.tableData("igroups");g<_.length;g++){f=_[g];d.classrooms.has(f.classroomid)&&d.igroups.add(f.id)}for(var v=0,y=r.tableData("teachers");v<y.length;v++){f=y[v];d.classrooms.has(f.classroomid)&&d.teachers.add(f.id)}var w=function(e,t){for(var n=0,s=t;n<s.length;n++){var i=s[n];if(d[e].has(i))return!0}return!1};s=s.filter(function(e){for(var t=0,n=[e.item_orig,e.item_new];t<n.length;t++){var s=n[t];if(w("classrooms",s.classroomids))return!0;if(w("classes",s.classids))return!0;if(s.igroupid&&d.igroups.has(s.igroupid))return!0;if(w("teachers",s.teacherids))return!0}return!1})}function E(e){return e.orig==e.new?A.createElement(D,null,e.orig):A.createElement(D,null,e.orig,"âž”",e.new)}var S=[{key:"stav",label:"",width:16,icons:U},{key:"periodorbreak",label:ASC.ttls(2096),width:34,sortable:!0,formatter:function(e){var t=e.row;return A.createElement(E,{orig:t.popis_orig.period,new:t.popis_new.period})}},{key:"absent",label:ASC.ttls(1995),width:100*t-6,sortable:!0,resizable:!0,formatter:function(e){var t=e.row.subst;return t.absent?A.createElement(D,null,t.absent.name):null},sortFunction:function(e,t){return R.compareLocaleStrings(e.subst.absent&&e.subst.absent.name,t.subst.absent&&t.subst.absent.name)}},{key:"classids",label:ASC.ls(1263),width:100*t-6,resizable:!0,formatter:function(e){return A.createElement(V,{online:o,table:e.row.item_orig.igroupid?"igroups":"classes",subst:e.row.subst})}},{key:"subjectid",label:ASC.ls(1299),width:170*t-6,resizable:!0,formatter:function(e){return A.createElement(V,{online:o,table:"subjects",subst:e.row.subst})}},{key:"substitution_typeid",width:100*t-6,label:ASC.ttls(1997),resizable:!0,formatter:function(e){return A.createElement(D,null,e.row.subst.cancelled?ASC.ttls(1476):o.naming_dbi.rowName("substitution_types",e.row.subst.substitution_typeid))}},{key:"substitute",label:ASC.ttls(2090),width:94,resizable:!0,formatter:function(e){var t=e.row.subst;if(t.absent){var n=T.absentGetTable(t.absent),s=T.absentGetId(t.absent);if("classrooms"==n)return A.createElement(D,null,"âž”");for(var i=0,r=t.changes;i<r.length;i++){var a=r[i];if(T.changeColumn2table(a.column)==n&&a.old==s)return A.createElement(D,null,o.naming_dbi.rowName(n,a.new))}if("teachers"==n&&t.cancel_teacher)return A.createElement(D,null,"-")}else if(t.changes.some(function(e){return"teachers"==T.changeColumn2table(e.column)}))return A.createElement(H,x.__assign({},{dbi:l,table:"teachers",origids:T.subst_item_tableIds(t,"teachers"),changes:t.changes,name_col:o.getTableNameCol("teachers")}));return null}},{key:"classroomids",label:ASC.ls(1197),width:100*t-6,resizable:!0,formatter:function(e){var t=e.row,n=t.subst,s=t.ttitem;if(n.absent){var i=T.absentGetTable(n.absent),r=T.absentGetId(n.absent);if("classrooms"==i&&s&&1==s.changes.filter(function(e){return T.changeColumn2table(e.column)==i}).length){var a=n.changes.find(function(e){return T.changeColumn2table(e.column)==i&&e.old==r});if(a)return A.createElement(G,{dbi:l,table:"classrooms",id:a.new,name_col:"short"})}}return A.createElement(W,{online:o,table:"classrooms",ttitem:s})}},{key:"note",label:ASC.ls(1579),width:95*t-6,resizable:!0,formatter:function(e){return A.createElement(D,null,e.row.subst.note)}}];if(s.find(function(e){return!(!e.subst.join_duration&&!e.subst.join_can)})){var C=o.state.join_doubles;S.splice(1,0,{key:"zgrc",width:0,label:" ",resizable:!1,align:"center",formatter:function(e){var t=e.row.subst,n="";return C?t.join_duration&&(n="/global/pics/ui/tree_plus.png"):t.join_can&&(n="/global/pics/ui/tree_minus.png"),n?A.createElement("img",{src:n,style:{cursor:"pointer",marginLeft:-4,marginRight:-4},onClick:function(){o.setState({join_doubles:!C}),function(e){barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstOnline."+e,eventLabel:""})}(C?"join_doubles_off":"join_doubles")},title:k.client_req.ls(9339)+" (beta)"}):null}})}return A.createElement(R.RDatatable,{scrolling:!0,columns:S,data:s,selectedIdRef:I.stateRef(o,"selectedSubstId"),dbi:r,fitWidth:!0,style:{width:"100%",height:"100%"},ref:function(e){return o.subst_dtr=e},rowClassNames:function(e){var t=e.subst,n=t.absent,s=[];return n&&"classrooms"==n.table&&s.push("absent_classroom"),n||s.push("changecard"),t.cancelled&&s.push("cancelled"),s},onRowClick:function(t){return x.__awaiter(a,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return n.uploaded_int?"nomatch"!=t.stav?[3,2]:[4,Promise.resolve().then(function(){return require("./pc_subst")})]:[3,2];case 1:e.sent().showSubstNoMatchDlg(o,t.subst),e.label=2;case 2:return[2]}})})},onRowDoubleClick:function(e){n.uploaded_int||o.showSubstEditDlg(e.id)},onRowContextMenu:function(e,t){if(t.preventDefault(),!o.getDateRow().uploaded_int){var n=e.subst,s=e.ttitem,i=o.state.join_doubles,r=[];T.substIsMovedDate(n)?(r.push({text:ASC.ttls(3194)+" - "+ASC.ls(1090),icon:T.ICON_subst_movelesson,onclick:function(){return o.showMoveSubstDlg(n.id)}}),r.push({text:ASC.ttls(3194)+" - "+ASC.ls(1038),icon:T.ICON_subst_movelesson,onclick:function(){return x.__awaiter(a,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.ui.Dialog.areYouSureDlg(ASC.ttls(3194)+" - "+ASC.ls(1038))];case 1:return e.sent()?[4,ASC.blockUI(M.cancelSubstMove(null,n.id,i))]:[3,3];case 2:e.sent(),o.refresh(),e.label=3;case 3:return[2]}})})}})):(r.push({text:ASC.ttls(1054),icon:O.action_icon("edit"),onclick:function(){o.showSubstEditDlg(n.id)}}),n.cancelled?r.push({text:ASC.ls(1859)+": "+ASC.ttls(1476),icon:O.action_icon("add"),onclick:function(){return x.__awaiter(a,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(M.uncancelSubstOnlineTTItem(null,s.id,i))];case 1:return e.sent(),o.refresh(),[2]}})})}}):r.push({text:ASC.ttls(1476),icon:O.action_icon("delete"),onclick:function(){return x.__awaiter(a,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(M.removeSubstOnlineTTItem(null,s.id,1<n.join_duration))];case 1:return e.sent(),o.refresh(),[2]}})})}}),n.absent||(r.push([]),r.push({text:ASC.ttls(3793),icon:Z("del_32"),onclick:function(){return x.__awaiter(a,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,j.showSubstDeleteDlg(o.dbi,n.id,i)];case 1:return e.sent()&&o.refresh(),[2]}})})}})),!n.card||n.cancelled||n.addcard||n.join_duration||(r.push([]),r.push({text:ASC.ls(6201),icon:O.action_icon("blank"),onclick:function(){o.jsc.ASC_action("subst_split","subId="+n.subId)}})),n.card&&!n.cancelled&&(r.push([]),r.push({text:ASC.ls(7441),icon:T.ICON_subst_movelesson,onclick:function(){return o.showMoveSubstDlg(n.id)}}))),n.kolizie_ignored.length?(r.push([]),r.push({text:ASC.ls(1038)+": "+ASC.ls(6675)+" ("+n.kolizie_ignored.length+")",icon:O.action_icon("blank"),onclick:function(){o.jsc.ASC_action("subst_kolizie_ignore","cancel=1&subId="+n.subId)}})):n.kolizie&&(r.push([]),r.push({text:ASC.ls(6675)+" ("+n.kolizie.length+")",icon:O.action_icon("blank"),onclick:function(){o.jsc.ASC_action("subst_kolizie_ignore","subId="+n.subId)}})),ASC.showContextMenu(r,t)}}})}function $(e){var i=this,r=e.online,s=e.table,t=s,n=r.dbi,a=[];a.push({key:"icon",label:"",width:16,singleIcon:n.table(t).icon()});function o(t){return x.__awaiter(i,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(r.dbi.backend.updateRow(s,t))];case 1:return e.sent(),r.refresh(),[2]}})})}switch(s){case"officialtimetables":a.push({key:"name",label:ASC.ls(1196),width:200}),a.push({key:"daterange",label:ASC.ls(1581),width:140,formatter:K}),a.push({key:"tools",label:"",width:80,formatter:function(s){return A.createElement("a",{style:{display:"inline-block"},onClick:function(e){var t=s.row.id,n=[];n.push({text:ASC.ls(6391)+": "+ASC.ttls(1501),onclick:function(){r.jsc.ASC_action("other_cmd","cmd=copy_subst_timeoff&id="+t)}}),ASC.showContextMenu(n,e,e.currentTarget),e.preventDefault()}},ASC.ls(1768))}});break;case"teachers":a.push({key:"firstname",label:ASC.ls(1191),width:110}),a.push({key:"lastname",label:ASC.ls(1192),width:110}),a.push({key:"short",label:ASC.ls(3783),width:80}),a.push({key:"subst_hidden",label:ASC.ls(1003),width:50,align:"center",formatter:function(e){var t=!!e.row.subst_hidden;return A.createElement("img",{src:t?"/substitution/pics/subst_hidden.png":"/substitution/pics/subst_allowed.png",style:{cursor:"pointer"},onClick:function(){return o({id:e.row.id,subst_hidden:!t})}})}}),a.push({key:"subst_timeoff",label:ASC.ttls(1471),width:80,align:"center",formatter:function(e){var t=e.row,n=r.getDateRow().tt_num,s=t.subst_tt_timeoff_vt[n];return s&&" "==d.timeOff_get(s,-1,-1,-1,-1,function(e,t){return 0<="0OD".indexOf(e)?e:t})&&(s=null),A.createElement("span",{style:{cursor:"pointer",display:"inline-block"},onClick:function(){return x.__awaiter(i,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,d.showSubstTimeOffDlg(t.id,r.getDate())];case 1:return e.sent()&&r.refresh(),[2]}})})}},s?A.createElement(d.MiniTimeOff,{dbi:r.tt_dbi,timeoff:s}):A.createElement("img",{src:"/substitution/pics/sluzba.png",style:{margin:0}}))}}),a.push({key:"approbationids",label:ASC.ttls(1053),width:150,formatter:function(e){var t=e.row,n=t.approbationids||[];return A.createElement("span",{style:{cursor:"pointer",paddingRight:5},onClick:function(){return x.__awaiter(i,void 0,void 0,function(){return x.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../rpr/vyber.js")})];case 1:return[4,e.sent().showDBIVyberDlg(r.dbi,"approbations",n)];case 2:return(n=e.sent())&&o({id:t.id,approbationids:n}),[2]}})})}},r.dbi.rowNames("approbations",n,"short")||"-")}});for(var l=0,c=["contract","de_contract_verfugung"];l<c.length;l++){var u=c[l];n.column("teachers",u)&&a.push({key:u,label:n.column("teachers",u).name(),width:40,align:"center"})}break;case"subjects":a.push({key:"name",label:ASC.ls(1196),width:200}),a.push({key:"short",label:ASC.ls(3783),width:100}),a.push({key:"subst_join_forbidden",label:ASC.ttls(2107),width:50,align:"center",formatter:function(e){var t=e.row,n=!!t.subst_join_forbidden;return A.createElement("img",{src:n?"/substitution/pics/join_forbidden_16.png":"/substitution/pics/join_allowed_16.png",style:{cursor:"pointer",margin:0},onClick:function(){return o({id:t.id,subst_join_forbidden:!n})}})}});break;case"substitution_types":a.push({key:"name",label:ASC.ls(1196),width:200}),a.push({key:"short",label:ASC.ls(3783),width:100}),a.push({key:"default_for",label:ASC.ls(6439),width:200,formatter:m.DBIColumnFormatter});break;case"approbations":a.push({key:"name",label:ASC.ls(1196),width:200}),a.push({key:"short",label:ASC.ls(3783),width:80}),a.push({key:"subjectids",label:ASC.ls(1008),width:200,formatter:m.DBIColumnFormatter}),a.push({key:"teacherids",label:ASC.ls(1005),width:300,formatter:m.DBIColumnFormatter});break;default:a.push({key:"name",label:ASC.ls(1196),width:200}),a.push({key:"short",label:ASC.ls(3783),width:100})}return A.createElement(R.RDatatable,{scrolling:!0,columns:a,data:n.tableData(t),selectedIdRef:I.stateRef(r,"selectedOtherId"),dbi:n,dbi_table:s,onRowDoubleClick:function(n){return x.__awaiter(i,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return r.modeInfo(s).editable?(t=n.id,[4,Promise.resolve().then(function(){return require("../rpr/maindbi_ui")})]):[2];case 1:return[4,e.sent().showMainDbiItemDlg(r.getYear(),s,t)];case 2:return e.sent(),r.refresh(),[2]}})})},style:{width:"100%",height:"100%"}})}function Z(e){return"/timetable/pics/app/office/"+e+".png"}e.init=function(n){return x.__awaiter(this,void 0,void 0,function(){var t;return x.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.loadTTLang()];case 1:return e.sent(),t=new i(n),n.online=t,wndResize(),t.refresh(),[2]}})})},e._hotswap=[z,P,F]}),ASC.setModuleSourceFunc("/substitution/subst.js",function(e,require,t){e.__esModule=!0;var f=require("tslib"),T=require("../rpr/dbi"),n=require("../dashboard/dbi_events");function s(e){return"types"==e.substring(e.length-5)?e.substring(0,e.length-1):"es"==e.substring(e.length-2)?e.substring(0,e.length-2):e.substring(0,e.length-1)}function i(e,t){void 0===t&&(t=!1);var n=l(e),s=e[n];if(t){s=f.__assign({},s);for(var i=function(t){var e=t.column,n=s[e];Array.isArray(n)?(n=n.filter(function(e){return e!=t.old}),t.new&&n.push(t.new)):n=t.new||"",s[e]=n},r=0,a=e.changes||[];r<a.length;r++){i(a[r])}}var o=T.DBITools.getUniPeriod(s);return{type:n,uniperiod:o,endtime:"starttime"==T.DBITools.typeOfUniPeriod(o)&&s.endtime||"",subjectid:s.subjectid||"",classids:s.classids||[],teacherids:s.teacherids||(s.teacherid?[s.teacherid]:[]),classroomids:s.classroomids||(s.classroomid?[s.classroomid]:[]),igroupid:s.igroupid||"",groupnames:s.groupnames||[]}}function _(e,t){switch(t){case"classes":return e.classids||[];case"teachers":return e.teacherids||[];case"classrooms":return e.classroomids||[];case"subjects":return e.subjectid?[e.subjectid]:[];case"igroups":return e.igroupid?[e.igroupid]:[]}return[]}function v(e,t){if(t.period){var n=parseInt(t.period),s=n+(t.durationperiods||1)-1;switch(T.DBITools.typeOfUniPeriod(e.uniperiod)){case"period":var i=parseInt(e.uniperiod);if(i+(e.durationperiods||1)-1<n)return!1;if(s<i)return!1;break;case"break":var r=parseInt(e.uniperiod.substr(1)),a=t.exclude_breaks||"",o=0<=a.indexOf("b")?1:0,l=0<=a.indexOf("i"),c=0<=a.indexOf("a")?1:0;if(r<n+o)return!1;if(1+s-c<r)return!1;if(n<r&&r<=s&&l)return!1;break;default:return!1}}return!0}function r(e,t){switch(t.table){case"teachers":if(e.teacherids.indexOf(t.teacherid)<0)return!1;break;case"classrooms":if(e.classroomids.indexOf(t.classroomid)<0)return!1;break;case"classes":if(e.classids.indexOf(t.classid)<0)return!1;break;case"groups":if(e.classids.indexOf(t.classid)<0)return!1;if(0<=e.groupnames.indexOf(t.groupname));else if(!(0<=e.groupnames.indexOf("")&&t.split_entireclass))return!1}return!!v(e,t)}function a(r,a,o){for(var l=null,e=function(t){if(a.classids.indexOf(t)<0)return"continue";var e=!1;if(T.groupnamesIsOverlap(r.groupnames,a.groupnames)&&(e=!0),!e&&o){var n=o.tableData("groups"),s=n.find(function(e){return e.classid==t&&0<=r.groupnames.indexOf(e.name)}),i=n.find(function(e){return e.classid==t&&0<=a.groupnames.indexOf(e.name)});s&&i&&s.ascttdivision!=i.ascttdivision&&(e=!0)}e&&(l?l.indexOf(t)<0&&l.push(t):l=[t])},t=0,n=r.classids;t<n.length;t++){e(n[t])}return l}function l(e){return ASC.boolVal(e.card)?"card":ASC.boolVal(e.tcard)?"tcard":ASC.boolVal(e.classroomsupervision)?"classroomsupervision":void ASC.dieError("7424907584")}function y(e){if(!e)return"";var t=e.table;return"groups"==t&&(t="classes"),t}function w(e){switch(y(e)){case"classes":return e.classid;case"teachers":return e.teacherid;case"classrooms":return e.classroomid}return""}function o(e,t,n){void 0===n&&(n=!1);for(var s=0,i=e;s<i.length;s++){var r=i[s];if((!r.cancelled||n)&&0<=r.substids.indexOf(t))return r}return null}function I(e){if(!e)return-1;var t=60*parseInt(e.substr(0,2))+parseInt(e.substr(3,2));return 8<=e.length&&(t+=parseInt(e.substr(6,2))/60),t}function k(e){if(e<0)return"";var t=e%60,n=(e-t)/60;return(n<10?"0":"")+n+":"+(t<10?"0":"")+t}function c(e,t){if(0==e.length)return t;for(var n=e,s=0,i=t;s<i.length;s++){for(var r=i[s],a=!1,o=0,l=n;o<l.length;o++){var c=l[o];if(c.column===r.column&&(c.old===r.old&&c.new===r.new)){a=!0;break}}a||(n==e&&(n=f.__spreadArrays(n)),n.push(r))}return n}function g(e,t,n,s){var i="subst_ttitems"==t?"subst_substitutions":"substonline_substitutions";if(n.subjectid!=s.subjectid)return!1;if(!T.idsArrayMatch(n.classids,s.classids))return!1;if(!T.idsArrayMatch(n.groupnames,s.groupnames))return!1;if(n.igroupid!=s.igroupid)return!1;if(!T.idsArrayMatch(n.teacherids,s.teacherids))return!1;if(!T.idsArrayMatch(n.classroomids,s.classroomids))return!1;if(n.type!=s.type)return!1;if(n.cancelled!=s.cancelled)return!1;if(n.added!=s.added)return!1;if("period"!=T.DBITools.typeOfUniPeriod(n.uniperiod))return!1;if(s.uniperiod!=""+(parseInt(n.uniperiod)+1))return!1;var r=n.orig,a=s.orig;if(r){if(!a)return!1;if(r.subjectid!=a.subjectid)return!1;if(!T.idsArrayMatch(r.teacherids,a.teacherids))return!1;if(r.igroupid!=a.igroupid)return!1;if(!T.idsArrayMatch(r.classids,a.classids))return!1;if(!T.idsArrayMatch(r.groupnames,a.groupnames))return!1;if(!T.idsArrayMatch(r.classroomids,a.classroomids))return!1}else if(a)return!1;if(n.origsubstid){if(!s.origsubstid)return!1;if(n.origsubstid.split(":")[0]!=s.origsubstid.split(":")[0])return!1}if(n.origofids.length!=s.origofids.length)return!1;var o=n.origofids.length;if(1<o)return!1;if(1==o&&n.origofids[0].split(":")[0]!=s.origofids[0].split(":")[0])return!1;if(n.substids.length!=s.substids.length)return!1;if(1==n.substids.length){var l=e.rowData(i,n.substids[0]),c=e.rowData(i,s.substids[0]);if(l.note!=c.note)return!1;if(l.substitution_typeid!=c.substitution_typeid)return!1}else if(1<n.substids.length)return!1;return!0}function u(c,e,t,n){void 0===n&&(n={});for(var u=n.table||"substonline_ttitems",s=[],i=c.tableFilterData(u,{date:e}),d=new Map,r=0,a=c.tableIds("periods");r<a.length;r++){var o=a[r];d.set(parseInt(o),[])}for(var l=0,m=i;l<m.length;l++){var p=m[l],b=f.__assign({},p);s.push(b);o=parseInt(b.uniperiod);d.has(o)&&d.get(o).push(b)}if(d.forEach(function(e,t){var n=d.get(t+1);if(n)for(var s=0,i=e;s<i.length;s++)for(var r=i[s],a=0,o=n;a<o.length;a++){var l=o[a];if(g(c,u,r,l)){r.join_nextid=l.id,l.join_previd=r.id,l.join_substid2prev=new Map,1==l.substids.length&&l.join_substid2prev.set(l.substids[0],r.substids[0]);break}}}),t){var h=new Map;d.forEach(function(e){for(var t=0,n=e;t<n.length;t++){var s=n[t];if(s.join_previd){var i=h.get(s.join_previd);i.durationperiods++,i.join_ttitemids.push(s.id),h.set(s.id,i),1==s.substids.length&&i.join_substid2first.set(s.substids[0],i.substids[0])}else s.join_nextid&&(s.durationperiods=1,s.join_ttitemids=[],s.join_substid2first=new Map,h.set(s.id,s))}}),s=s.filter(function(e){return!e.join_previd})}return s}e.ICON_subst_ok="/global/pics/ui/item_ok_32.svg",e.ICON_subst_kolizia="/global/pics/ui/item_bad_32.svg",e.ICON_subst_spojenie="/substitution/pics/plus_32.svg",e.ICON_subst_kolizia_ignored="/substitution/pics/no_ignored_32.svg",e.ICON_subst_changelesson="/global/pics/ui/modified_32.svg",e.ICON_subst_addlesson="/global/pics/ui/add_32.svg",e.ICON_subst_movelesson="/substitution/pics/subst_move_32.png",e.SubstApp_maindbi_needed_tables=["periods","breaks","dayparts","classes","classrooms","teachers","subjects","igroups","buildings","substonline_dates","substonline_absents","substonline_substitutions","substonline_ttitems","substonline_teacher_month","teacher_beeps","absent_types","substitution_types","officialtimetables","approbations",n.TABLE_events,n.TABLE_event_types,"global_settings","user_at_settings"],e.SubstApp_maindbi_needed_columns=f.__spreadArrays(["name","short","firstname","lastname","subname","cb_hidden","subst_hidden","date","month","dateto","table","teacherid","classid","classroomid","buildingid","igroupid","groupname","absent_typeid","longtime_datefrom","longtime_dateto","period","durationperiods","break","daypart","allday","uniperiod","exclude_breaks","split_entireclass","default_for","note","card","tcard","classroomsupervision","substitution_typeid","origid","origofids","origsubstid","orig_err","added","kolizie_ignored","absent","addcard","addtcard","substing","sv_substing","de_plusminus","de_subst_plusminus_typ","cancelled","cancel_teacher","text","changes","starttime","endtime","subst_dbid","subst_note","subst_problems","published_int","uploaded_int","is_holiday","is_online","tcards_subst","subst_tt_timeoff_vt","orig","substids","type","ttmatchfail","tt_num","tt_day","tt_week","tt_term","subst_hidden","datefrom","dateto","approbationids","contract","de_contract_verfugung","subjectids","teacherids","subst_join_forbidden","grade","gradefrom","gradeto","subst_online","subst_online_criteria","colorblind"],n.eventMainColumns,n.eventTypeMainColumns),e.SubstApp_ttdbi_needed_tables=["terms","weeks","days","periods","classroomsupervisions","lessons","groups","classes","subjects","teachers","classrooms"],e.SubstApp_ttdbi_needed_columns=["name","short","classids","teacherids","classid","ascttdivision"],e.SubstApp_substdbi_needed_tables=["classes","teachers","classrooms","subjects","absent_types","substitution_types"],e.SubstApp_substdbi_needed_columns=["name","short"],e.subst_period=function(e){return e?""!=(t=ASC.strVal(e.period))?t:""!=(t=ASC.strVal(e.break))?"b"+t:""!=(t=ASC.strVal(e.daypart))?t:5==(t=ASC.strVal(e.starttime)).length?t.substr(0,2)+"-"+t.substr(3):"":"";var t},e.subst_item=function(e){return e.card||e.classroomsupervision||e.tcard},e.subst_item_tableIds=function(e,t){return _(i(e),t)},e.removeEs=s,e.blankSubstTTItem_Core=function(){return{type:"",uniperiod:"",endtime:"",subjectid:"",classids:[],teacherids:[],classroomids:[],igroupid:"",groupnames:[]}},(e.coreTTItemOfSubst=i).needed_part=T.typed({subst_substitutions:["card","tcard","classroomsupervision","changes"]}),e.substTTItem_tableIds=_,e.substTTItem_filter_match=function(e,t,n){switch(t){case"teachers":return 0<=e.teacherids.indexOf(n);case"classes":return 0<=e.classids.indexOf(n);case"classrooms":return 0<=e.classroomids.indexOf(n);case"igroups":return e.igroupid==n}return!1},e.substTTItem_absent_match_time=v,(e.substTTItem_absent_match=r).needed_part=T.typed({subst_absents:["table","teacherid","classroomid","classid","groupname","period","durationperiods"]}),e.susbtTTItemPopis=function(e,t,n){if("classroomsupervision"==e.type)return ASC.ls(1723)+" "+t.rowNames("classrooms",e.classroomids,n)+" "+t.rowNames("teachers",e.teacherids,n);var s=t.rowName("subjects",e.subjectid,n);s+=" ",s+=t.rowNames("classes",e.classids,n);var i=e.groupnames;return i&&i.length&&!T.DBITools.groupnamesIsEntireClass(i)&&(s+=" ("+t.tools.groupnames_names(i)+")"),s+=" ",s+=t.rowNames("teachers",e.teacherids,n),s+=" ",s+=t.rowNames("classrooms",e.classroomids,n)},e.substTTItemMovable=function(e){return"classroomsupervision"!=e.type&&"period"==T.DBITools.typeOfUniPeriod(e.uniperiod)},e.isSubstAdd=function(e){return!(!e.addcard&&!e.addtcard)},e.idsArrayMatch=T.idsArrayMatch,e.idsArrayMatchI=T.idsArrayMatchI,e.idsArrayDiff=T.idsArrayDiff,e.idsArrayIntersect=T.idsArrayIntersect,e.idsIsOverlap=T.idsIsOverlap,e.idsIsSubArray=T.idsIsSubArray,e.groupnamesIsOverlap=T.groupnamesIsOverlap,(e.ttitem_isClassColision=a).needed_part=T.typed({substonline_ttitems:["classids","groupnames"]}),a.ttdbi={needed_part:T.typed({groups:["classid","name","ascttdivision"]})},e.subst_item_type=l,e.subst_isTargetAbsent=function(e){if(!e.absent)return!1;var t=y(e.absent);return e.classroomsupervision?"classrooms"==t:"classes"==t||"igroups"==t},e.absentGetTable=y,e.absentGetId=w,e.findAbsent=function(e,t,n,s){void 0===s&&(s={});for(var i=0,r=e;i<r.length;i++){var a=r[i];if(y(a)==t&&w(a)==n){if("groups"==a.table&&s.groupnames)if(0<=s.groupnames.indexOf(a.groupname));else if(!T.DBITools.groupnamesIsEntireClass(s.groupnames)||!a.split_entireclass)continue;if(a.period){var o=parseInt(a.period),l=o+(a.durationperiods||1)-1;if(s.period){if(parseInt(s.period)<o)continue;if(parseInt(s.period)>l)continue}if(s.break){if(parseInt(s.break)<o)continue;if(parseInt(s.break)>1+l)continue}if(s.daypart)continue;if(s.starttime)continue}return a}}return null},(e.findTTItemFromSubstId=o).needed_part=T.typed({subst_ttitems:["cancelled","substids"]}),e.findCollisions=function(e,t,n,s,i){void 0===i&&(i={});for(var r=[],a=0,o=["teachers","classrooms","classes","igroups"];a<o.length;a++)for(var l=o[a],c=0,u=_(t,l);c<u.length;c++){for(var d=u[c],m=0,p=n;m<p.length;m++){var b=p[m];b.date==e&&(_(b,l).indexOf(d)<0||i.ignore_substid&&0<=b.substids.indexOf(i.ignore_substid)||b.uniperiod==t.uniperiod&&r.push({table:l,id:d,ttitem:b}))}for(var h=0,f=s;h<f.length;h++){var g=f[h];y(g)==l&&w(g)==d&&v(t,g)&&r.push({table:l,id:d,absent:g})}}return r},e.getDefault_substitution_typeid=function(e,t){void 0===t&&(t="normal");for(var n=0,s=e.tableData("substitution_types");n<s.length;n++){var i=s[n];if(i.default_for==t)return i.id}return""},e.changeColumn2table=function(e){switch(e){case"period":return"periods";case"subjectid":return"subjects";case"teacherids":case"teacherid":return"teachers";case"classids":return"classes";case"classroomids":case"classroomid":return"classrooms";case"igroupid":return"igroups"}return""},e.coreOfTTItem=function(e){return{type:e.type,uniperiod:e.uniperiod,endtime:"starttime"==T.DBITools.typeOfUniPeriod(e.uniperiod)?e.endtime:"",subjectid:e.subjectid,classids:e.classids,teacherids:e.teacherids,classroomids:e.classroomids,igroupid:e.igroupid,groupnames:e.groupnames}},e.time2int=I,e.int2time=k,e.dp_fixTime=function(e,t,n,s){for(var c=new Map,u=function(e){var t=c.get(e);return t||(t={starttime:"",endtime:"",cbs:[]},c.set(e,t)),t},d=null!=e.tt_day?""+e.tt_day:"",i=0,r=n.tableData("periods");i<r.length;i++){var a=(h=r[i]).id;(A=u(a)).starttime=h.starttime,A.endtime=h.endtime}for(var o=0,l=n.tableData("dayparts");o<l.length;o++){var m=l[o];a=m.id;(A=u(a)).starttime=m.starttime,A.endtime=m.endtime}if(s){for(var p=0,b=s.tableData("periods");p<b.length;p++){var h;a=(h=b[p]).id;(A=u(a)).starttime=h.starttime,A.endtime=h.endtime}for(var f=0,g=s.tableData("breaks");f<g.length;f++){var _=g[f];a="b"+_.id;(A=u(a)).starttime=_.starttime,A.endtime=_.endtime}for(var v=0,y=s.tableData("custombells");v<y.length;v++){var w=y[v];a=w.period;w.break&&(a="b"+w.break),(A=c.get(a))&&A.cbs.push(w)}}function E(e,t){if(a=c.get(e)){if(0<a.cbs.length)for(var n=0<=t.classids.length?t.classids[0]:"",s=0,i=a.cbs;s<i.length;s++){var r=i[s];if(!r.day||r.day==d){if(0<r.classids.length){if(!n)continue;if(r.classids.indexOf(n)<0)continue}return T.unpartial(r)}}return a}var a=u(e);if("b"==e[0]){var o=c.get(""+(parseInt(e.substr(1))-1)),l=c.get(e.substr(1));l&&(a.endtime=l.starttime,a.starttime=o?o.endtime:k(I(a.endtime)-5))}return a}for(var S=0,C=t;S<C.length;S++){var x=C[S];if(!x.starttime||!x.endtime){a=x.uniperiod||T.DBITools.getUniPeriod(x);if("starttime"!=T.DBITools.typeOfUniPeriod(a)){var A=E(a,x);x.starttime=A.starttime,x.durationperiods&&1<x.durationperiods&&(A=E(""+(parseInt(a)+x.durationperiods),x)),x.endtime=A.endtime}else x.starttime=a.replace("-",":")}}},e.substItem2substAddCardItem=function(e){var t=i(e,!0);return{id:e.id,date:e.date,subId:e.subId,uniperiod:t.uniperiod,endtime:t.endtime,subjectid:t.subjectid,teacherids:t.teacherids,classids:t.classids,groupnames:t.groupnames,igroupid:t.igroupid,classroomids:t.classroomids,substitution_typeid:e.substitution_typeid,note:e.note,origid:e.origid}},e.substIsAddCard=function(e){return e.addcard||e.addtcard},e.substIsIgnored=function(e){return!(!e.absent||"classes"!=y(e.absent))},e.substIsMovedDate=function(e){for(var t=f.__spreadArrays([e.origid],e.origofids||[]),n=e.id.split(":")[0],s=0,i=t;s<i.length;s++){var r=i[s];if(r&&r.split(":")[0]!=n)return!0}return!1},e.mergeSubstChanges=c,e.substChangesEquals=function(e,t){return e.length==t.length&&c(e,t).length==e.length},e.substBasicChanges=function(e){var t=[],n=e.absent;return n&&t.push({column:s(y(n))+"ids",old:w(n)}),t},g.needed_part=T.typed({subst_ttitems:["date","uniperiod","orig","subjectid","teacherids","classids","groupnames","igroupid","substids","classroomids","origsubstid","origofids"],subst_substitutions:["note","substitution_typeid"]}),(e.buildSubstOnlineTTItemsEx=u).npp=T.neededPartProvider(function(){return[g,{subst_ttitems:["date","substids"]}]}),e.substOnlineNeededPartProvider=function(r){return function(){var e,t=T.neededPartProvider(r)(),n=[],s={subst_dates:"substonline_dates",subst_absents:"substonline_absents",subst_substitutions:"substonline_substitutions",subst_ttitems:"substonline_ttitems"};for(var i in t)n.push(((e={})[s[i]||i]=t[i],e));return T.DBITools.mergeNeededParts.apply(T.DBITools,n)}}}),ASC.setModuleSourceFunc("/dashboard/dbi_events.js",function(e,require,t){e.__esModule=!0;var l=require("tslib"),c=require("../rpr/dbi");function u(e,t){if("boolean"==typeof t.ctevent)return t.ctevent;var n=e.rowData("event_types",t.typ);return!(!n||!n.ctevent&&!n.d_ctevent)}function n(e,t){if(u(e,t)){for(var n=l.__spreadArrays(t.teacherids),s=0,i=t.classids;s<i.length;s++){var r=i[s],a=e.rowData("classes",r),o=(a=a&&c.DBITools.rowApplyChanges(a,t.date))?a.teacherid:"";o&&n.indexOf(o)<0&&n.push(o)}return n}return t.teacherids}function d(e,t){for(var n=[],s=0,i=t.classids;s<i.length;s++){var r=i[s],a=e.rowData("classes",r),o=(a=a&&c.DBITools.rowApplyChanges(a,t.date))?a.teacherid:"";o?n.push(l.__assign(l.__assign({},t),{classids:[r],teacherids:[o]})):n.push(l.__assign(l.__assign({},t),{classids:[r],teacherids:[]}))}return n}function s(e,t){for(var n=[],s=0,i=t;s<i.length;s++){var r=i[s];if(u(e,r))for(var a=0,o=d(e,r);a<o.length;a++){var l=o[a];n.push(l)}else n.push(r)}return n}function i(e,t){if("boolean"==typeof t.ttcancel)return t.ttcancel;var n=e.rowData("event_types",t.typ);return!(!n||!n.ttcancel&&!n.d_ttcancel)}function r(e,t){if(0<t.classids.length)return!1;var n=e.rowData("event_types",t.typ);return!!n&&n.noclassallclasses}function a(e,t){var n=e.rowData("event_types",t.typ);return!!n&&(n.ttcancel&&n.noclassallclasses&&0==t.classids.length&&(n.allday||t.allday))}function o(e,t){var n=e.rowData("event_types",t.typ);return!!n&&(!(!n.attachevent&&"testing"!=n.id&&"testing"!=n.categoryid)&&!i(e,t))}function m(e,t){return t.subjectid==e.subjectid&&(!!c.idsIsOverlap(t.classids,e.classids)&&(!(!c.DBITools.groupnamesIsEntireClass(e.groupnames)&&!c.idsIsOverlap(t.groupnames,e.groupnames))&&(!e.period||t.uniperiod==e.period)))}function p(e,t){if(t.allday&&!i(e,t))return!1;var n=e.rowData("event_types",t.typ);return n?n.attendance||n.lesson||!1:(ASC.logProblem("0667782150"),!1)}function b(e,t){var n=e.rowData("event_types",t.typ);return n||console.log("event typ error",t),n&&n.attendance&&t.date>new Date(e.req.isAscDevelop()?"2020-02-01":"2020-03-01").toISOString()}function h(e,t){if(t.privacy)return t.privacy;var n=e.rowData("event_types",t.typ);return n?n.privacy:""}function f(e,t){var n="???";if(t){var s=e.rowData("event_types",t.typ);s&&(n=s.name),t.name&&(n+=": "+t.name)}return n}e.TABLE_events="events",e.eventMainColumns=["date","subId","typ","name","subjectid","classids","groupnames","teacherids","classroomids","period","durationperiods","starttime","endtime","allday"],e.TABLE_event_types="event_types",e.eventTypeMainColumns=["name","color","ctevent","d_ctevent"],e.event_tableIds=function(e,t,n){switch(void 0===n&&(n={}),t){case"classes":return e.classids;case"teachers":if(n.expand_ctevent){var s=n.dbi;if(u(s,e)){for(var i=[],r=0,a=e.classids;r<a.length;r++){var o=a[r],l=s.rowData("classes",o);l&&(n.date&&(l=c.DBITools.rowApplyChanges(l,n.date)),l.teacherid&&i.indexOf(l.teacherid)<0&&i.push(l.teacherid))}return i}}return e.teacherids;case"classrooms":return e.classroomids;case"subjects":return e.subjectid?[e.subjectid]:[]}return[]},(e.isClassTeacherEvent=u).needed_part=c.typed({events:["ctevent"],event_types:["ctevent","d_ctevent"]}),(e.eventTeacherids=n).npp=c.neededPartProvider(function(){return[u,{events:["teacherids","classids"],classes:["teacherid","changes"]}]}),(e.splitClassTeacherEvent=d).needed_part=c.typed({classes:["teacherid","changes"],events:["classids"]}),(e.splitClassTeacherEvents=s).needed_part=c.DBITools.mergeNeededParts(u,d),(e.isTTCancelEvent=i).needed_part=c.typed({events:["typ","ttcancel"],event_types:["ttcancel","d_ttcancel"]}),(e.isAllClassesEvent=r).needed_part=c.typed({events:["typ","classids"],event_types:["noclassallclasses"]}),(e.isEventCancelDay=a).needed_part=c.typed({events:["typ","classids","allday"],event_types:["ttcancel","noclassallclasses","allday"]}),(e.isAttachEvent=o).npp=c.neededPartProvider(function(){return[{events:["typ"],event_types:["attachevent","categoryid"]},i]}),(e.attachEventMatch=m).needed_part=c.typed({dailyplan:["subjectid","classids","groupnames","uniperiod"],events:["subjectid","classids","groupnames","period"]}),(e.eventCanAddStudentsAbsents=p).needed_part=c.DBITools.mergeNeededParts(i,{event_types:["attendance","lesson"]}),(e.eventHasSaConfirm=b).needed_part=c.typed({event_types:["attendance"]}),(e.eventPrivacy=h).needed_part=c.typed({events:["privacy"],event_types:["privacy"]}),(e.eventName=f).needed_part=c.typed({events:["typ"],event_types:["name"]}),e.eventTypeOrCategory=function(e,t){return 0<=t.indexOf(e.id)||0<=t.indexOf(e.categoryid)||0<=t.indexOf(e.templateid)}}),ASC.setModuleSourceFunc("/timetable/timeoff_r.js",function(f,require,e){f.__esModule=!0;var E=require("tslib"),S=require("react"),C=require("../asc/asc_react"),a=S.Fragment,g=require("../asc/edurequest"),_=require("./server/timeoff"),v=[[[" "]]];function y(e,t,n,s,i,r){void 0===r&&(r=null),r=r||function(e,t){return"0"==e||"0"==t?"0":"?"==e||"?"==t?"?":e};var a=e;if(t<0)return l=y(e,0,n,s,i,r);var o=a[t<a.length?t:a.length-1];if(n<0){var l=y(e,t,0,s,i,r);for(n=1;n<o.length;n++)l=r(l,y(e,t,n,s,i,r));return l}var c=o[n<o.length?n:o.length-1];if(s<0){l=y(e,t,n,0,i,r);for(s=1;s<c.length;s++)l=r(l,y(e,t,n,s,i,r));return l}var u=c[s<c.length?s:c.length-1];if(i<0){l=y(e,t,n,s,0,r);for(i=1;i<u.length;i++)l=r(l,y(e,t,n,s,i,r));return l}return u.charAt(i<u.length?i:u.length-1)}function x(e,t,n,s,i,r,a){if(o=e.length,t<0){if(1<o){for(t=0;t<o;t++)e=x(e,t,n,s,i,r);return e}t=0}if(o=e[t].length,n<0){if(1<(o=e[t].length)){for(n=0;n<o;n++)e=x(e,t,n,s,i,r);return e}n=0}if(o=e[t][n].length,s<0){if(1<(o=e[t][n].length)){for(s=0;s<o;s++)e=x(e,t,n,s,i,r);return e}s=0}else a&&u(e[t][n],ASC.count(a.days));if(i<0){var o=e[t][n][s].length;for(i=0;i<o;i++)e=x(e,t,n,s,i,r);return e}var l=(e=ASC.clone(e))[t][n][s],c=l.substr(0,i)+r+l.substring(i+1);return e[t][n][s]=c,e}function u(e,t){for(;e.length<t;)e.push(ASC.clone(e[e.length-1]))}function o(e){var t=e.tools.tableIntIdRange("periods");return{nTerms:e.tableData("terms").length||1,nWeeks:e.tableData("weeks").length||1,nDays:e.tableData("days").length||1,nPeriods:t[1]+1,hodinyOd:t[0],hodinyDo:t[1]}}function A(e,t){e=ASC.clone(e);var n=o(t);u(e,n.nTerms);for(var s=0;s<e.length;s++){u(e[s],n.nWeeks);for(var i=0;i<e[s].length;i++){u(e[s][i],n.nDays);for(var r=0;r<e[s][i].length;r++){var a=".";for(0<e[s][i][r].length&&(a=e[s][i][r].substr(e[s][i][r].length-1));e[s][i][r].length<n.nPeriods;)e[s][i][r]+=a}}}return ASC.clone(e)}function T(e){return function e(t){for(var n=0;n<t.length;n++)Array.isArray(t[n])&&e(t[n]);for(;1<t.length&&JSON.stringify(t[t.length-1])==JSON.stringify(t[t.length-2]);)t.splice(t.length-1)}(e=ASC.clone(e)),e}function n(e){for(var t=0,n=e.icons;t<n.length;t++){var s=n[t];if(s.d==e.value)return s.img?S.createElement("img",{style:{width:24,height:24,verticalAlign:"middle"},src:s.img}):null}return null}function b(t){return S.createElement("td",{style:{border:"1px solid #e0e0e0",textAlign:"center",verticalAlign:"middle",backgroundColor:t.obsadene?"#8a8a9e":"",position:"relative",cursor:"pointer"},onMouseDown:function(e){e.preventDefault(),t.onToggle(2==e.button)},onContextMenu:function(e){return e.preventDefault()}},S.createElement(n,{value:t.value,icons:t.icons}),t.overlay)}function I(l){function a(e,t,n){void 0===n&&(n=!1);for(var s=y(p,Math.max(u,0),Math.max(d,0),Math.max(e,0),Math.max(t,0)),i=l.icons,r=0,a=0;a<i.length;a++){i[a].d==s&&(r=a)}var o=n?r-1:r+1;o>=i.length&&(o=0),o<0&&(o=i.length-1),l.timeoffRef.write(x(p,u,d,e,t,i[o].d))}var e=l.tt_dbi,o=e.tableData("periods"),c=e.tableData("days"),u=l.term,d=l.week,m=l.overlay,n={width:100/(o.length+1)+"%",textAlign:"center",padding:"10px 0px",fontWeight:"normal"},p=l.timeoffRef.read();return S.createElement("table",{style:{width:"100%",backgroundColor:"#ffffff",borderCollapse:"collapse"}},S.createElement("thead",null,S.createElement("tr",null,S.createElement("th",null),o.map(function(t){return S.createElement("th",{key:t.id,style:E.__assign(E.__assign({},n),{fontSize:"15px"}),onMouseDown:function(e){e.preventDefault(),a(-1,parseInt(t.id),2==e.button)},onContextMenu:function(e){return e.preventDefault()}},t.short)}))),S.createElement("tbody",{style:{fontSize:"20px"}},c.map(function(i,r){return S.createElement("tr",{key:i.id},S.createElement("th",{style:E.__assign({},n),onMouseDown:function(e){e.preventDefault(),a(parseInt(i.id),-1,2==e.button)},onContextMenu:function(e){return e.preventDefault()}},i.short),o.map(function(e,t){var n=parseInt(i.id),s=parseInt(e.id);return S.createElement(b,{key:e.id,last_x:t+1>=o.length,last_y:r+1>=c.length,value:y(p,Math.max(u,0),Math.max(d,0),n,s),icons:l.icons,onToggle:function(e){return a(n,s,e)},obsadene:l.obsadene&&"1"==y(l.obsadene,Math.max(u,0),Math.max(d,0),n,s),overlay:m?m({term:u,week:d,day:n,period:s}):void 0})}))})))}function k(e){var t=g.client_req;return S.createElement("div",{style:{marginTop:20}},S.createElement("span",{style:{marginRight:10}},ASC.ttls(1119)),e.icons.filter(function(e){return!!e.name}).map(function(e){return S.createElement(a,{key:e.d},S.createElement("img",{src:e.img,style:{marginRight:10,verticalAlign:"middle",width:24,height:24}}),S.createElement("span",{style:{marginRight:30}},t.localize(e.name)))}),S.createElement("div",{style:{marginTop:6}},ASC.ttls(1123)),S.createElement("div",{style:{marginTop:6}},ASC.ttls(3548)))}function D(t){var n=t.tt_dbi;if(n.tableData(t.table).length<=1)return null;var e=t.valueRef.read();return S.createElement("div",{style:{display:"inline-block",width:180,marginLeft:15,verticalAlign:"top"}},S.createElement("label",null,S.createElement("input",{type:"checkbox",checked:e<0,onChange:function(){return t.valueRef.write(e<0?0:-1)}}),t.text_rovnako),S.createElement("br",null),S.createElement(C.AnimatedCollapseDiv,{collapsed:e<0},S.createElement(C.RComboBox,{valueRef:C.castRef(t.valueRef,function(e){return""+e},function(e){return parseInt(e)}),items:n.tableIds(t.table).map(function(e){return{value:e,name:n.rowName(t.table,e)}}),style:{width:"100%"}})))}function R(n){var e=0,t=n.tt_dbi.tableData("terms").length-1,s=n.termRef.read();s<0&&(e=t=s);var i=0,r=n.tt_dbi.tableData("weeks").length-1,a=n.weekRef.read();return a<0&&(i=r=a),S.createElement("div",null,C.rangeFromTo(e,t).map(function(t){return C.rangeFromTo(i,r).map(function(e){return S.createElement("span",{key:t+":"+e,style:{display:"inline-block",borderWidth:1,borderStyle:"solid",borderColor:t==s&&e==a?"black":"transparent",padding:2,marginRight:5,cursor:"pointer"},onClick:function(){n.termRef.write(t),n.weekRef.write(e)}},S.createElement(p,{dbi:n.tt_dbi,timeoff:n.timeoff,t:t,w:e}))})}))}function w(e){var t=e.tt_dbi,n=e.icons,s=e.table,i=e.id,r=C.castRef(e.valueRef,function(e){return A(e,t)},function(e){return T(e)}),a=C.useStateValueRef(-1),o=C.useStateValueRef(-1),l=[a.read(),o.read()],c=l[0],u=l[1],d=A([[["0"]]],t);if(s&&i)for(var m=0,p=t.tableData("cards");m<p.length;m++){var b=p[m];if(b.period){var h=t.rowData("lessons",b.lessonid);if(("subjects"!=s||h.subjectid==i)&&!("teachers"==s&&h.teacherids.indexOf(i)<0||"classes"==s&&h.classids.indexOf(i)<0||"classrooms"==s&&b.classroomids.indexOf(i)<0))for(var f=parseInt(b.period),g=f+((h.durationperiods||1)-1),_=0;_<b.days.length;_++)if("1"==b.days[_])for(var v=0;v<b.weeks.length;v++)if("1"==b.weeks[v]&&!(0<=u&&v!=u))for(var y=0;y<h.terms.length;y++)if("1"==h.terms[y]&&!(0<=c&&y!=c))for(var w=f;w<=g;w++)d=x(d,y,v,_,w,"1")}}return S.useEffect(function(){var e=T(r.read());if(c<0&&1<e.length&&a.write(0),u<0)for(var t=0;t<e.length;t++)if(1<e[t].length){o.write(0);break}}),S.createElement("div",null,S.createElement(I,{timeoffRef:r,tt_dbi:t,icons:n,term:c,week:u,obsadene:d,overlay:e.overlay}),S.createElement(C.AnimatedCollapseDiv,{collapsed:!(0<=c||0<=u)},S.createElement("div",{style:{marginTop:3,textAlign:"right"}},S.createElement(R,E.__assign({},{timeoff:r.read(),tt_dbi:t,termRef:a,weekRef:o})))),S.createElement(k,{icons:n}),S.createElement("div",{style:{display:"inline-block",width:150}}),S.createElement(D,{valueRef:a,table:"terms",tt_dbi:t,text_rovnako:ASC.ttls(3675)}),S.createElement(D,{valueRef:o,table:"weeks",tt_dbi:t,text_rovnako:ASC.ttls(3674)}))}f.timeOff_get=y,f.timeOff_set=x,f.timeOff_fix=A,f.timeOff_compress=T,f.timeOff2str=function(e){e=T(e);for(var t="",n=0;n<e.length;n++){0<n&&(t+="|");for(var s=0;s<e[n].length;s++){0<s&&(t+=";");for(var i=0;i<e[n][s].length;i++)0<i&&(t+=","),t+=e[n][s][i]}}return t},f.substTimeOff_Icons=[{d:"D",img:"/substitution/pics/must_be_32.svg",name:"{tt:1471}"},{d:"O",img:"/global/pics/ui/time_32.svg",name:"{tt:2529}"},{d:"0",img:"/global/pics/ui/item_bad_32.svg",name:"{tt:1472}"}],f.showSubstTimeOffDlg=function p(b,h){return E.__awaiter(this,void 0,void 0,function(){var t,n,u,s,d,i,r,a,o,l,c,m;return E.__generator(this,function(e){switch(e.label){case 0:return t=g.client_req,n=t.getSchoolYear(h),[4,ASC.blockUI(t.maindbi(n,{tables:["teachers","substonline_dates"],columns:["firstname","lastname","tt_num","subst_tt_timeoff"],vt_filter:{date:h}}))];case 1:return u=e.sent(),[4,ASC.blockUI(t.timetabledbi("date:"+h,{tables:["days","weeks","terms","periods","lessons","cards"],columns:["name","short","lessonid","terms","weeks","days","period","durationperiods","teacherids"]}))];case 2:return s=e.sent(),(d=s.dbid)?[3,4]:[4,C.RDialog.showMessage(S.createElement(S.Fragment,null,ASC.ls(7244)),{srcFunction:p})];case 3:return e.sent(),[2,!1];case 4:return[4,ASC.loadTTLang()];case 5:for(e.sent(),i=A(i=u.rowData("teachers",b).subst_tt_timeoff[d]||v,s),(r=[]).push({d:"."}),a=0,o=f.substTimeOff_Icons;a<o.length;a++)l=o[a],r.push(E.__assign(E.__assign({},l),{name:t.localize(l.name)}));return c={timeoff:i},[4,C.RDialog.showInput(c,function(e){var c=e.state,t=e.stateRef;return S.createElement(S.Fragment,null,S.createElement(w,{valueRef:C.subRef(t,"timeoff"),tt_dbi:s,icons:r,table:"teachers",id:b,overlay:function(e){for(var t=e.term,n=e.week,s=e.day,i=e.period,r=0,a=0,o=u.tableData("teachers");a<o.length;a++){var l=o[a];"D"==y(l.id==b?c.timeoff:l.subst_tt_timeoff[d]||v,t,n,s,i)&&r++}return r?S.createElement("div",{style:{position:"absolute",right:3,bottom:3,pointerEvents:"none",color:"#000",fontSize:10}},r):null}}))},{header:ASC.ttls(1471)+" - "+u.rowName("teachers",b),width:600})];case 6:return(m=e.sent())?(i=T(m.timeoff),[4,ASC.blockUI(_.setTeacherSubstTimeOff(null,n,b,d,i))]):[2,!1];case 7:return e.sent(),[2,!0]}})})},f.TimeOffInput=w;var l=8,c=3;function d(e){var t="#ffffff";switch(y(e.timeoff,e.t,e.w,e.d,e.h)){case"1":t="#00ff00";break;case"?":t="#0000ff";break;case"0":t="#ff0000";break;case"O":t="#8080ff";break;case"D":t="#0000ff"}return S.createElement("div",{style:{height:c-1,backgroundColor:t,width:l-1,borderTop:e.firstRow?"1px solid black":void 0,borderRight:"1px solid black",borderBottom:"1px solid black",borderLeft:e.firstCell?"1px solid black":void 0}})}function m(e){for(var t=e.struct,n=e.firstRow,s=t.hodinyDo-t.hodinyOd+1,i=[],r=t.hodinyOd;r<=t.hodinyDo;r++)i.push(S.createElement(d,E.__assign({},E.__assign(E.__assign({},e),{h:r,firstCell:r==t.hodinyOd,key:""+r}))));return S.createElement("div",{style:{display:"flex",flexFlow:"row",width:l*s-1,height:c+(n?1:0),boxSizing:"border-box"}},i)}function p(e){for(var t=e.dbi,n=A(e.timeoff||v,t),s=o(t),i=[],r=0;r<s.nDays;r++)i.push(S.createElement(m,{timeoff:n,struct:s,t:void 0===e.t?-1:e.t,w:void 0===e.w?-1:e.w,d:r,firstRow:0==r,key:""+r}));return S.createElement(a,null,i)}f.MiniTimeOff=p}),ASC.setModuleSourceFunc("/timetable/server/timeoff.js",function(e,require,t){t.implementRpc(["setTeacherSubstTimeOff"])}),ASC.setModuleSourceFunc("/substitution/online/rightpanel.js",function(e,require,t){e.__esModule=!0;var Z=require("tslib"),J=require("react"),T=J.Fragment,X=require("../../asc/asc_react"),Q=require("../subst"),ee=require("../server/commands"),te=require("../../rpr/dbi"),ne=require("../../asc/actions"),se=require("./timetable"),W=require("./combo"),K=require("../../asc/edurequest"),Y=require("../server/settings"),ie=require("../../timetable/ttitem"),re=require("../../asc/asc_react2"),$=require("../../rpr/dbi_react"),ae=[{id:"date",name:"{1465}"},{id:"week",name:"{tt:3855}"},{id:"month",name:"{tt:3854}"},{id:"year",name:"{1578}"}];function oe(e){var t=e.tv,n=t.ttitem,s=t.naming_dbi,i=t.online,r=X.useReq();if(!n)return null;var a=Z.__assign(Z.__assign({},n),n.orig||{}),o="",l=s.tools.ttitem_popis(a,"short");"."!=(o=l.period).substr(o.length-1)&&(o+="."),o+=" ",o+=l.subject,o+=" ",o+=s.rowNames("teachers",a.teacherids,1<a.teacherids.length?"short":""),o+=" ",o+=l.class,"classroomsupervision"==n.type&&(o=l.period,o+=" ",o+=l.classroom,o+=" ",o+=" "+s.rowNames("teachers",a.teacherids));var c="";if(n.changes)for(var u=0,d=n.changes;u<d.length;u++){var m=d[u];if(m.new){""!=c&&(c+=" ");var p=Q.changeColumn2table(m.column);if(!p)throw ASC.dieError("9589868469");c+=s.rowName(p,m.new,"teachers"==p?r.sort_name_col:"short")}}return""!=c&&(o+=" -> "+c),J.createElement("div",{style:{textAlign:"center",color:"#00156e",paddingTop:4,fontSize:11,fontWeight:"bold",cursor:"default",flex:"0 0 auto",position:"relative"},title:"",onClick:function(){i&&i.showTTItemEditDlg(n.id)}},o)}function le(e){var t=e.tv,n=t.ttitem,s=t.combo_items,i=t.table,r=t.sel_item;return n&&i?J.createElement(J.Fragment,null,s.map(function(e){return J.createElement(m,{key:e.id,tv:t,table:i,id:e.id,item:e,sel:!!r&&e.id==r.id})})):null}function ce(e){var r=e.tv,a=r.dbi,t=r.ttitem,n=r.table;if(!t)return null;var s=Z.__assign(Z.__assign({},t),t.orig||{}),o=[t.uniperiod];if(1<t.durationperiods)for(var i=1;i<t.durationperiods;i++)o.push(te.DBITools.uniperiod_delta(t.uniperiod,i));var l=r.tlr;l.clear();for(var c=0,u=a.tableIds("periods");c<u.length;c++){var d=u[c];l.addItem("main",{uniperiod:d})}return a.rowData("periods",t.uniperiod)||l.addItem("main",{uniperiod:t.uniperiod,endtime:t.endtime}),l.render(),J.createElement(J.Fragment,null,J.createElement("div",{style:{height:l.qSize,position:"relative"}},r.kriteriaCols.map(function(e,t){return J.createElement(X.RTextBox,{x1:r.nameWidth+t*ue,y1:0,x2:r.nameWidth+(t+1)*ue,y2:l.qSize,key:""+t,text:"teachers"==n?e.name[0]:"",title:e.name,hAlign:"center",vAlign:"center"})}),l.renderOrderItems().map(function(e,t){var n=e.data.uniperiod,s=l.item2box(e,r.ttOffset);if(n){var i=["period"];return 0<=o.indexOf(n)&&i.push("sel"),J.createElement(X.RTextBox,Z.__assign({},s,{key:n,style:{position:"absolute",textAlign:"center",color:"#000000",fontSize:10,fontWeight:"bold",paddingTop:2,paddingBottom:2,backgroundColor:o.includes(n)?"#ffff00":void 0},className:i.join(" "),text:a.tools.uniperiodName(n,"short"),hAlign:"center",vAlign:"center"}))}return null})),0<s.classids.length&&J.createElement(J.Fragment,null,J.createElement("div",{className:"row",style:{height:0,borderBottom:"1px solid #c5bdc5"}}),s.classids.map(function(e,t){return J.createElement(m,{key:""+t,tv:r,table:"classes",id:e,isHeader:!0})})))}function m(e){var f=e.tv,g=e.isHeader,_=e.table,v=e.id,y=e.item,t=e.sel,w=f.ttitems,E=f.absents,n=f.online,S=f.dbi,s=f.date,C=f.ttitem,i=f.onRowDoubleClick,x=f.onRowPeriodClick,r=f.colorblind,a=X.useReq(),o=f.stats_mode,l=f.stats_dbi,A=[C.uniperiod];if(1<C.durationperiods)for(var c=1;c<C.durationperiods;c++)A.push(te.DBITools.uniperiod_delta(C.uniperiod,c));var u=["row"],d=[];e.sel&&u.push("sel"),y&&(y.ft||y.frh?d.push("#0000ff"):y.fu&&d.push("#00ff00"),y.fp&&d.push("#f5ca70"));var m=!1,p="#000000";return y&&(m=y.cb_hidden||y.subst_hidden||y.out,y.fd&&(p="#00ffff"),m&&(p="#888"),y.fx&&(p="#ff0000")),J.createElement("div",{className:u.join(" "),style:{height:f.rowHeight,position:"relative",borderBottom:"1px solid #c5bdc5",backgroundColor:t?"#33ae66":void 0,backgroundImage:t&&r?"url(/global/pics/ui/textures/w_h.png)":void 0},onClick:y?function(){return f.setSel_item(y)}:null,onDoubleClick:function(){!g&&i&&i(y.id)}},J.createElement("div",{title:S.rowName(_,v,a.sort_name_col),style:{position:"absolute",left:0,top:0,bottom:0,paddingLeft:2,paddingRight:2,display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",fontSize:10,fontWeight:m?"normal":"bold",overflow:"hidden",whiteSpace:"nowrap",cursor:"default",width:f.nameWidth,boxSizing:"border-box",color:p,textDecoration:m?"line-through":void 0},onContextMenu:function(e){if(e.preventDefault(),n){var t=Z.__spreadArrays(n.timetableMenu(_,v));ASC.showContextMenu(t,e,{header:S.rowName(_,v,a.sort_name_col)})}}},S.rowName(e.table,e.id,"short"),J.createElement(b,{farby:d}),g&&J.createElement(h,{nameWidth:f.nameWidth,setNameWidth:f.setNameWidth})),f.kriteriaCols.map(function(e,t){return J.createElement("div",{key:e.id,style:{position:"absolute",boxSizing:"border-box",top:0,bottom:0,left:f.nameWidth+t*ue,width:ue,borderLeft:"1px solid #c5bdc5",display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",color:"#808080"}},"teachers"==_&&e.render({stats_dbi:l,date:s,teacherid:v,stats_mode:o}))}),function(){var o=f.tlr;o.clear();for(var e=new Set,t=0,n=w;t<n.length;t++){var s=n[t];if(ie.ttitemFilterMatch(te.unpartial(s),_,v)||s.orig&&ie.ttitemFilterMatch(te.unpartial(s.orig),_,v)){for(var i=s.uniperiod,r=s.durationperiods,a=0;a<(r||1);a++){var l=te.DBITools.uniperiod_delta(i,a);0<=A.indexOf(l)&&e.add(l)}var c="classroomsupervision"==s.type,u={uniperiod:i,ttitem:s,endtime:s.endtime,durationperiods:s.durationperiods,type:c?"classroomsupervision":"",classids:s.orig?s.orig.classids:s.classids};o.addItem(c?"supervision":"main",u)}}if(C.uniperiod)if(0==e.size){u={uniperiod:C.uniperiod,endtime:C.endtime,durationperiods:C.durationperiods};o.addItem("b"==C.uniperiod[0]?"supervision":"main",u)}else for(var d=0,m=A;d<m.length;d++){i=m[d];if(!e.has(i)){u={uniperiod:i,endtime:C.endtime};o.addItem("b"==C.uniperiod[0]?"supervision":"main",u)}}for(var p=0,b=E;p<b.length;p++){var h=b[p];Q.absentGetTable(h)==_&&Q.absentGetId(h)==v&&o.addItem("autobottom",{uniperiod:te.DBITools.getUniPeriod(h)||"ad",durationperiods:h.durationperiods,absent:h,classids:"classes"==_?[v]:[]})}return o.items.sort(function(e,t){var n=e.data.ttitem,s=t.data.ttitem;return n?s?n.added?-1:s.added?1:n.cancelled?1:s.cancelled?-1:s.changes.length-n.changes.length:-1:1}),o.render(),J.createElement("div",{style:{position:"absolute",left:f.ttOffset,top:0,bottom:0}},S.tableIds("periods").map(function(e){var t=o.data2t({uniperiod:e}),n=o.t2p(t.t1),s=o.t2p(t.t2);return J.createElement(T,{key:e},J.createElement(X.RBox,{x1:n,y1:0,x2:n+1,y2:o.qSize,style:{backgroundColor:"#c5bdc5"}}),J.createElement(X.RBox,{x1:s,y1:0,x2:s+1,y2:o.qSize,style:{backgroundColor:"#c5bdc5"}}))}),o.renderOrderItems().map(function(e,t){var n=e.data,s=n.ttitem,i=n.absent,r=n.uniperiod,a=o.item2box(e,0,-1);return i?J.createElement(I,Z.__assign({},a,{key:t+"",tv:f,absent:i})):J.createElement(k,Z.__assign({},a,{key:t+"",tv:f,table:_,id:v,item_uniperiod:C.uniperiod,ttitem:s,je_sel_subst:s?s.id==C.id||te.idsIsOverlap(s.substids,C.substids):0<=A.indexOf(r),selFn:e&&e.data.uniperiod==C.uniperiod&&!g&&x?function(e){f.setSel_item(y),x(v,e)}:null}))}))}())}function I(e){var t,n=e.absent,s=e.tv,i=s.dbi,r=K.client_req.ls(1622),a=[];a.push(Z.__assign(Z.__assign({},ne.action_menu("details")),{onclick:function(){return se.showAbsentInfo(i,n)}})),a.push(Z.__assign(Z.__assign({},ne.action_menu("edit")),{onclick:function(){return s.online.showAbsentEditDlg(n.id)}})),t=function(e){ASC.showContextMenu(a,e,{})};return J.createElement(X.RBox,{x1:e.x1,x2:e.x2,y1:e.y1,y2:e.y2,className:["cell","chyba_cast"].join(" "),title:r||void 0,style:{borderBottomWidth:1,overflow:"visible"},onClick:function(e){e.preventDefault(),ASC.hideContextMenu()},onContextMenu:function(e){e.preventDefault(),ASC.hideContextMenu(),t(e)}})}function k(e){var t=this,n=e.tv,i=e.ttitem,s=e.table,r=e.id,a=e.item_uniperiod,o=n.online,l=n.date,c=n.absents,u=n.ttitem,d=n.dbi,m=n.tt_dbi,p=n.refresh,b=d.req,h=["cell"],f="",g=null,_="",v=Z.__assign(Z.__assign({},u),u.orig||{});if(e.je_sel_subst&&h.push("sel"),i){var y=!1,w=!1,E=!1,S=!1;if("classes"==s){for(var C=0,x=i.changes;C<x.length;C++){var A=x[C],T=Q.changeColumn2table(A.column);"teachers"!=T&&"classes"!=T||(E=!0)}if(u&&0==i.changes.length&&"period"==te.DBITools.typeOfUniPeriod(i.uniperiod)&&"period"==te.DBITools.typeOfUniPeriod(a)&&parseInt(i.uniperiod)>parseInt(a)&&(u.durationperiods||1)==(i.durationperiods||1)){var I=Z.__assign(Z.__assign({},i),{uniperiod:a});0==se.getSubstTTItemKolizie(d,m,I,Z.__spreadArrays([u.id],u.join_ttitemids||[])).length&&(g={text:ASC.ttls(3195),onclick:function(){return Z.__awaiter(t,void 0,void 0,function(){var t,n,s;return Z.__generator(this,function(e){switch(e.label){case 0:return t=d.tools.ttitem_popis(u.cancelled?u.orig:u),(n=d.tools.ttitem_popis(i)).period+=" -> "+d.tools.ttitem_popis(I).period,s=function(e){return[e.period,e.subject,e.class,e.teacher].join(", ")},barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstOnline.suggested_move_view",eventLabel:""}),[4,X.RDialog.showConfirm(J.createElement(J.Fragment,null,J.createElement(re.DlgHeader,{title:b.ttls(3195),icon:"/substitution/pics/subst_move_64.png",small:!0}),J.createElement("div",null,J.createElement("h2",null,b.ttls(1476)+":"),s(t),J.createElement(X.VGap,{height:20}),J.createElement("h2",null,b.ttls(3194)+":"),s(n),J.createElement(X.VGap,{height:20}))),{buttons:[{label:b.ttls(3194),type:"green",action:"move"},"cancel"],footer:J.createElement(X.RButton,{label:ne.action_name("help"),fa_icon:ne.action_fa_icon("help"),onClick:function(){return window.open("https://help.asctimetables.com/text.php?id=638","_blank")}}),width:500})];case 1:return e.sent()?(barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstOnline.suggested_move_op",eventLabel:""}),u.cancelled?[3,3]:[4,ASC.blockUI(ee.removeSubstOnlineTTItem(null,u.id,1<u.durationperiods))]):[3,5];case 2:e.sent(),e.label=3;case 3:return[4,ASC.blockUI(ee.updateSubstTTItem(null,i.id,{uniperiod:a},{},1<i.durationperiods))];case 4:e.sent(),p(),e.label=5;case 5:return[2]}})})}})}}else{for(var k=0,D=i.substids;k<D.length;k++){var R=D[k],N=d.rowData("substonline_substitutions",R);N.absent&&"classes"==Q.absentGetTable(N.absent)&&(w=!0);for(var O=0,B=N.changes;O<B.length;O++){A=B[O];if(Q.changeColumn2table(A.column)==s&&A.new==r&&A.old!=r){E=!0;break}}}for(var j=0,M=c;j<M.length;j++){var U=M[j];Q.absentGetTable(U)==s&&Q.absentGetId(U)==r&&Q.substTTItem_absent_match_time(i,U)&&(y=!0)}if(ie.ttitemUniperiodMatchSimple(te.unpartial(i),a)&&te.idsIsOverlap(v.classids,i.classids)){S=!0;for(var z=0,P=[v.subjectid,i.subjectid];z<P.length;z++){var F=P[z],L=d.rowData("subjects",F);L&&L.subst_join_forbidden&&(S=!1)}}}if(ie.ttitemFilterMatch(te.unpartial(i),s,r))h.push("uci"),E||i.added?h.push("subst"):S&&h.push("spoj");else if(i.orig&&ie.ttitemFilterMatch(te.unpartial(i.orig),s,r))if(i.cancelled&&0<i.origofids.length){h.push("class_cancelled");var G=i.origofids[0],q=G.split(":")[0],H=void 0;if(q!=l)H=b.lib_date.date_format_date(q,!1),_=l<q?"down":"up";else{var V=d.rowData("substonline_ttitems",G);H=d.tools.uniperiodName(V.uniperiod),V&&(_=parseInt(V.uniperiod)<parseInt(i.uniperiod)?"left":"right")}f=b.lsf(7442,{date:H})}else"classes"==s||y||i.cancelled&&!w?h.push("cancelled"):h.push("mal_ucit");1<te.idsArrayUnique(i.teacherids).length&&h.push("teamteaching"),g&&h.push("move_sipocka");var W=function(e){var t=d.rowName("subjects",e.subjectid,"short");return t+=" ",t+=d.rowNames("classes",e.classids,"short"),0<e.groupnames.length&&!te.DBITools.groupnamesIsEntireClass(e.groupnames)&&(t+=" ("+d.tools.groupnames_names(e.groupnames)+")"),t+=" ",t+=d.rowNames("teachers",e.teacherids,"short"),t+=" ",t+=d.rowNames("classrooms",e.classroomids,"short")};i.cancelled?i.orig&&(f=b.ttls(1476)+": "+W(i.orig)):f=W(te.unpartial(i))}var K=null,Y=null,$=[];return g&&$.push(g),i&&($.push(Z.__assign(Z.__assign({},ne.action_menu("details")),{onclick:function(){se.showTTItemInfo(d,i)}})),$.push({text:ASC.ttls(3196),onclick:function(){return o.showTTItemEditDlg(i.id)}})),0<$.length&&(Y=function(e){return ASC.showContextMenu($,e)},g&&(K=Y)),e.selFn&&(K=e.selFn,Y=Y||K),J.createElement(X.RBox,{x1:e.x1,x2:e.x2,y1:e.y1,y2:e.y2,className:h.join(" "),title:f||void 0,style:{cursor:e.selFn?"pointer":"",borderBottomWidth:1,overflow:"visible",backgroundImage:_?"none":void 0},onClick:function(e){e.preventDefault(),ASC.hideContextMenu(),K&&K(e)},onContextMenu:function(e){e.preventDefault(),ASC.hideContextMenu(),Y&&Y(e)}},_&&J.createElement("i",{className:"fa fa-arrow-"+_,style:{position:"absolute",left:1,top:1,fontSize:12,color:"red",textShadow:"rgba(0,0,0,0.5) 0px 1px"}}))}function b(e){var t=e.farby;if(0==t.length)return null;var n={position:"absolute",right:0,top:0,bottom:0,width:2};if(1==t.length)return J.createElement("div",{className:"pruzok",style:Z.__assign(Z.__assign({},n),{backgroundColor:t[0]})});function s(e){return e/t.length*100+"%"}return J.createElement("div",{style:Z.__assign(Z.__assign({},n),{background:"linear-gradient(to bottom,"+t.map(function(e,t){return e+" "+s(t)+","+e+" "+s(t+1)}).join(",")+")"})})}function h(e){var t=X.useStateAsValueRef([e.nameWidth,e.setNameWidth]),n=X.useMouseResize(t,{axis:"x",min:20,max:150});return J.createElement("div",{style:{position:"absolute",top:0,right:0,bottom:0,width:3,cursor:"ew-resize"},onMouseDown:n})}function v(e,t,n,s){var i=e.req;return"date"==t?e.rowData("substonline_teacher_date",n+":"+s):"week"==t?e.rowData("substonline_teacher_week",i.lib_date.date_week(n)+":"+s):"month"==t?e.rowData("substonline_teacher_month",n.substr(0,7)+":"+s):e.rowData("substonline_teacher_year",i.getSchoolYear(n)+":"+s)}e.TeachersPanelHeader=oe;var ue=25;function de(e){var t=[],n=e.table("substonline_teacher_month");if(n)for(var s=function(l){var e=n.column(l);if("int"!=e.type())return"continue";t.push({id:"sc_"+l,name:e.name(),render:function(e){var t=e.stats_dbi,n=e.date,s=e.teacherid,i=v(t,e.stats_mode,n,s),r=i?i[l]:0;if("de_plusminus"!=l)return r;var a="#00b050",o="normal";return 3==r&&(a="#c55a11",o="bold"),3<r&&(a="red",o="bold"),J.createElement("span",{style:{color:a,fontWeight:o}},r)}})},i=0,r=n.columns();i<r.length;i++){s(r[i])}return t}function n(e){var t,m=this,n=e.online,p=e.dbi,s=e.tt_dbi,i=e.date,r=e.table,a=e.topid,o=e.ttitemid,l=e.onRowSelect,c=e.onRowDoubleClick,u=e.onRowPeriodClick,b=e.uiSettings,d=e.join_doubles,h=p.req,f=!!p.rowData("substonline_dates",i).uploaded_int,g=J.useMemo(function(){return Q.buildSubstOnlineTTItemsEx(p,i,d)},[p,i,d]),_=o?g.find(function(e){return e.id==o}):null,v=J.useMemo(function(){return r?W.substTTItemComboItems({table:r,ttitem:_,dbi:p,tt_dbi:s,remove_ttitemids:Z.__spreadArrays([_.id],_.join_ttitemids||[]),topid:a}):[]},[r,_,p,s,a]),y=J.useState("month"),w=y[0],E=y[1],S=J.useState(null),C=S[0],x=S[1],A=C?C.id:"";J.useEffect(function(){l&&l(A)},[A]),J.useEffect(function(){x(v[0]||null)},[i,o,a]);for(var T=X.useClientWidth(),I=T[0],k=T[1],D=h.isApp()?30:19,R=X.useLocalState("SubstOnline.TeachersView.nameWidth",33,{where:"localStorage"}),N=R[0],O=R[1],B=b.kriteria_cols,j=N,M=[],U=0,z=de(p);U<z.length;U++){var P=z[U];B.indexOf(P.id)<0||(M.push(P),j+=ue)}var F=se.TTLR_TProvider_uni(b.grid_mode,p,{tt_dbi:s}),L=new se.TimetableLayoutRenderer(I-j-25,2+D,F.minT,F.maxT);L.data2t=function(e){return F.t(e)},L.qSide=7,L.gap=-1;var G=$.useMainDBI("month"!=w?h.getSchoolYear(i):null,{needed_part:(t={},t["substonline_teacher_"+w]=["absent","cancelled","substing","sv_substing","de_plusminus"],t),vt_filter:{date:i}})||p,q=n?n.naming_dbi:new te.MergeDBI(p,s),H=(p.rowData("global_settings","1")||{}).colorblind,V={online:n,date:i,req:h,dbi:p,stats_dbi:G,tt_dbi:s,naming_dbi:q,table:r,ttitem:_,combo_items:v,onRowDoubleClick:c,onRowPeriodClick:u,uiSettings:b,join_doubles:d,ttitems:g,absents:p.tableFilterData("substonline_absents",{date:i}),stats_mode:w,setStats_mode:E,sel_item:C,setSel_item:x,rowHeight:D,nameWidth:N,setNameWidth:O,ttOffset:j,tlr:L,kriteriaCols:M,colorblind:H,refresh:function(){n&&n.refresh()}};return J.createElement(X.RScopedStyle,{ref:k,style:{display:"flex",flexDirection:"column",flex:"1 1 0px",position:"relative"},rules:{".cell":{position:"absolute",border:"1px solid #c5bdc5",borderBottomWidth:0,top:-1,bottom:0},".cell.sel":{backgroundColor:"#ffff00",backgroundImage:H?"url(/global/pics/ui/textures/b_v.png)":void 0},".header .cell.sel:before":{position:"absolute",left:-2,top:-2,right:-2,bottom:-1,content:'" "',border:"2px solid black",zIndex:2},".cell.teamteaching":{backgroundImage:"url(/substitution/pics/teamteaching.png)",backgroundRepeat:"no-repeat",backgroundPosition:"top 1px right 1px"},".cell.move_sipocka":{backgroundImage:"url(/substitution/pics/move_sipocka.png)",backgroundRepeat:"no-repeat",backgroundPosition:"center"},".cell.uci, .cell.uci.mal_ucit":{backgroundColor:"#fec2c2"},".cell.mal_ucit":{backgroundColor:"#00ffff",backgroundImage:H?"url(/global/pics/ui/textures/b_d1.png)":void 0},".cell.spoj":{backgroundColor:"#bffc07",backgroundImage:H?"url(/global/pics/ui/textures/b_dots.png)":void 0},".cell.chyba_cast":{backgroundColor:"#7b7b7b",backgroundImage:H?"url(/global/pics/ui/textures/w_d2.png)":void 0},".cell.class_cancelled, .cell.cancelled":{background:"url(/substitution/pics/no_11.png) no-repeat left top",backgroundColor:"#c0c0c0"},".cell.subst":{backgroundColor:"#ff0000",backgroundImage:H?"url(/global/pics/ui/textures/w_chess.png)":void 0},".cell.subst.mal_ucit":{boxShadow:"0px 0px 0px 2px #00ffff inset"}}},!f&&_&&J.createElement(J.Fragment,null,J.createElement(oe,{tv:V}),J.createElement("div",{className:"tt",style:{flex:"1",display:"flex",flexDirection:"column",paddingLeft:4,paddingRight:4,backgroundColor:"#FFFFFF"}},J.createElement("div",{className:"header",style:{flex:"0 0 auto",overflow:"hidden"}},J.createElement(ce,{tv:V})),J.createElement("div",{style:{borderTop:"1px solid #000000",flex:"1 1 0px",overflowX:"hidden",overflowY:"auto"}},J.createElement(le,{tv:V})),J.createElement(me,{tv:V,stats_mode:w}))),0<v.length&&J.createElement(pe,{style:{position:"absolute",left:1,top:3},fa_icon:"caret-down",title:ne.action_name("customize"),onClick:function(e){for(var s=[],t=function(t){s.push({text:t.name,checked:t.id==b.grid_mode,onclick:function(){return Z.__awaiter(m,void 0,void 0,function(){return Z.__generator(this,function(e){switch(e.label){case 0:return[4,Y.updateSubstOnlineUISettings(null,{grid_mode:t.id})];case 1:return e.sent(),V.refresh(),[2]}})})}})},n=0,i=se.gridModes;n<i.length;n++){t(i[n])}s.push([]);for(var r=b.kriteria_cols,a=function(t){var n=0<=r.indexOf(t.id);s.push({text:t.name,checked:n,onclick:function(){return Z.__awaiter(m,void 0,void 0,function(){return Z.__generator(this,function(e){switch(e.label){case 0:return[4,Y.updateSubstOnlineUISettings(null,{kriteria_cols:n?r.filter(function(e){return e!=t.id}):Z.__spreadArrays(r,[t.id])})];case 1:return e.sent(),V.refresh(),[2]}})})}})},o=0,l=de(p);o<l.length;o++){a(l[o])}s.push([]);for(var c=function(e){s.push({text:K.client_req.localize(e.name),checked:e.id==V.stats_mode,onclick:function(){return V.setStats_mode(e.id)}})},u=0,d=ae;u<d.length;u++){c(d[u])}ASC.showContextMenu(s,e,e.currentTarget),e.preventDefault(),e.stopPropagation()}}))}function me(e){var t=e.tv,n=e.stats_mode,s=t.date,i=t.dbi,r=t.stats_dbi,a=t.naming_dbi,o=t.sel_item,l=t.ttitem,c=t.table||"teachers",u=o&&o.id,d=i.req,m=null;if(l&&o){var p={display:"inline-block",width:"110px",verticalAlign:"top",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},b=function(e){var t=e.b;return J.createElement("span",{style:Z.__assign(Z.__assign({},p),{color:t<0?"#800000":t?"#000080":"#808080"}),title:e.name},e.name)},h=function(e){var t=i.column("global_settings","subst_online_criteria",e);return t?t.name():e},f=null;"teachers"==c&&(f=i.rowData("teacher_beeps",s+":"+u));var g="teachers"==c?v(r,n,s,u):null,_=function(e){var t=i.column("substonline_teacher_month",e);return t?J.createElement(J.Fragment,null,J.createElement(b,{name:t.name()+":",b:1}),g&&g[e]||0):null};m=J.createElement(J.Fragment,null,J.createElement("div",{style:{height:"20px"}}),J.createElement("div",null,J.createElement("span",{style:Z.__assign(Z.__assign({},p),{fontWeight:"bold"})},ASC.ttls(2071)),J.createElement("span",{style:Z.__assign(Z.__assign({},p),{fontWeight:"bold"})},a.rowName(c,u,d.sort_name_col))),J.createElement("div",{style:{height:"5px"}}),"teachers"==c&&J.createElement(J.Fragment,null,J.createElement("div",{style:{flex:"1 1 50px"}},J.createElement(b,{name:h("assign"),b:o.fa}),J.createElement(b,{name:h("teachesclass"),b:o.fu}),J.createElement(b,{name:h("classteacher"),b:o.ft}),J.createElement(b,{name:h("approbation"),b:o.fp}),J.createElement(b,{name:h("join"),b:o.fj}),J.createElement(b,{name:ASC.ttls(2153),b:-o.fx}),J.createElement(b,{name:h("duty"),b:o.fd}),f&&J.createElement("span",{style:{display:"block",marginTop:"5px"}},f.text),d.isAscDevelop()&&J.createElement("span",{style:{color:"#a0a0a0",marginTop:5}},"p=",o.priorita," fa=",o.fa," fq=",o.fq)),J.createElement("div",{style:{height:50}},J.createElement("div",{style:{borderBottom:"1px solid #282873"}},"month"==n?ASC.ttls(2197):K.client_req.localize("{1011} - "+K.client_req.localize(ae.find(function(e){return e.id==n}).name))),_("substing"),J.createElement(T,null,J.createElement(X.HGap,{width:20}),_("sv_substing")),J.createElement("br",null),_("absent"),J.createElement(X.HGap,{width:20}),_("cancelled"),J.createElement("br",null),_("de_plusminus"))))}return J.createElement("div",{className:"info",style:{flex:"0 0 200px",height:"200px",display:"flex",flexDirection:"column"}},m)}function pe(e){var t=X.useHover(),n=t[0],s=t[1];return J.createElement("i",Z.__assign({},s,{className:"fa fa-"+e.fa_icon,style:Z.__assign({fontSize:12,color:"#c0c0c0",backgroundColor:n?"#e0e0e0":void 0,padding:"3px 7px",cursor:"pointer"},e.style),title:e.title,onClick:e.onClick}))}(e.TeachersView=n).npp=te.neededPartProvider(function(){return[W.substTTItemComboItems,{global_settings:["colorblind"]}]}),e.MenuIcon=pe}),ASC.setModuleSourceFunc("/substitution/server/commands.js",function(e,require,t){t.implementRpc(["publishDay","unpublishDay","removeSubstOnlineTTItem","uncancelSubstOnlineTTItem","updateSubstTTItem","updateSubstSubstitution","updateupdateSubstSubstitutionAddCard","addSubstSubstitution","removeSubstSubstitution","absentEditWrite","removeAbsent","cancelSubstMove","deleteSubstDay","getAbsentLessons","setDateTcardsSubst"])}),ASC.setModuleSourceFunc("/substitution/online/timetable.js",function(a,require,e){a.__esModule=!0;var te=require("tslib"),ne=require("react"),se=require("../../rpr/dbi"),ie=require("../../asc/edurequest"),re=require("../../asc/svg"),ae=require("../subst"),I=require("../server/commands"),oe=require("../../asc/asc_react"),k=require("../../asc/actions"),o=require("./leftpanel"),D=require("../../timetable/ttitem"),F=require("../../asc/asc_react2"),le=require("../../dashboard/dbi_events"),ce=require("../../timetable/timeoff_r"),L=require("../../asc/lib_date"),G=require("../../rpr/dbi_react"),m=require("./combo"),ue=require("../../timetable/ttview_components"),de="substonline_absents",q="substonline_ttitems",me="substonline_dates",R="#fec2c2",N="#00ffff",O="#ff0000",B="#C0C0C0",j="#c0c0c0",M="#ff0000",U="#8080ff",pe="#40ff40",be="#0000FF",he="#00FFFF",fe="{tt:3194}",ge="{7856}",_e="{3894}";a.gridModes=[{id:"periods",name:ASC.ls(6399)},{id:"time",name:ASC.ls(1345)}];var H={subjects:["name","short","cb_hidden"],teachers:["short","firstname","lastname","approbationids","cb_hidden","classroomid","subst_tt_timeoff_vt"],classes:["changes","name","short","teacherid","classroomid"],classrooms:["name","short","cb_hidden","classids"],igroups:["changes","name","short","teacherid","classroomid"],approbations:["name","short","subjectids","teacherids"],periods:["name","short","period","starttime","endtime"],dayparts:["name","short","daypart","starttime","endtime"],timetables:["changes","name"],tcards:["subjectid","teacherids","classids","classroomids","igroupid","groupnames","period","durationperiods","daypart","starttime","endtime"],events:["date","subId","name","typ","subjectid","teacherids","classids","classroomids","groupnames","period","durationperiods","daypart","starttime","endtime","allday","ctevent","ttcancel"],absent_types:["name","short"],event_types:["name","allday","ctevent","d_ctevent","noclassallclasses","ttcancel"],substonline_dates:["date","tt_num","tt_day","tt_week","tt_term","tcards_subst","is_online","uploaded_int"],substonline_absents:["date","subId","name","absent_typeid","teacherid","classid","classroomid","groupname","table","period","durationperiods","allday","split_entireclass"],substonline_substitutions:["date","subId","absent","card","tcard","classroomsupervision","changes","addcard","addtcard","origid","origofids","cancelled"],substonline_ttitems:["date","subId","type","changes","subjectid","teacherids","classids","classroomids","igroupid","groupnames","endtime","uniperiod","origofids","orig","origsubstid","added","cancelled","substids"]},V={groups:["classid","name","ascttdivision"],periods:["name","period","starttime","endtime"],breaks:["name","break","starttime","endtime"],custombells:["period","break","day","classids","starttime","endtime"]};function ve(e,t){if(0==e.teacherids.length&&e.orig&&1==e.orig.teacherids.length){var n=e.orig.teacherids;t.teacherids=n,e.teacherids=n}e.starttime&&(e.starttime=void 0,e.endtime=void 0)}function T(r,a,o,l,e,t){var c=0,u=1,d=function(e,t){return t?u:c},m=new D.TTItemTimeProvider(r);function n(e){var t={t1:c,t2:u};if(e.starttime&&e.endtime||!e.date||((e=te.__assign({},e)).uniperiod||(e.uniperiod=se.DBITools.getUniPeriod(e)),e.classids||(e.classids=e.classid?[e.classid]:[]),m.setDate(r.rowData(o,e.date),a),m.fill(se.unpartial(e),se.unpartial(e))),l)e.starttime&&(t.t1=ae.time2int(e.starttime)),e.endtime&&(t.t2=ae.time2int(e.endtime));else{var n=e.period,s="";if(e.uniperiod){var i=se.DBITools.typeOfUniPeriod(e.uniperiod);"period"==i&&(n=e.uniperiod),"break"==i&&(s=e.uniperiod.substr(1))}n?(t.t1=parseInt(n),t.t2=t.t1+(e.durationperiods||1)):s?(t.t1=parseInt(s)-.25,t.t2=parseInt(s)+.25):(e.starttime&&(t.t1=d(e.starttime,!1)),e.endtime&&(t.t2=d(e.endtime,!0)))}return isNaN(t.t1)||isNaN(t.t2),t}var p=r.tableData("periods"),s={starttime:"08:00",endtime:"12:00"};if(c=n(p[0]||s).t1,u=n(p[p.length-1]||s).t2,l)c-=15,u+=15;else{var b=p.map(function(e){return{t1:ae.time2int(e.starttime),t2:ae.time2int(e.endtime)}}),h=parseInt((p[0]||{id:"0"}).id);d=function(e,t){for(var n=0;n<p.length;n++){var s=p[n];if(e<s.starttime)return h+n;if(!(e>s.endtime)){var i=b[n],r=ae.time2int(e)-i.t1;return h+n+r/Math.max(i.t2-i.t1,1)}}return p.length}}var i=new f(e,t,c,u);return i.data2t=function(e){return n(e.ttitem||e.absent||e.event||e)},i}function i(e){var t=e.dlg,n=e.dbi,s=e.table,i=e.id,r=t.table==s&&t.id==i;return ne.createElement("a",{title:n.rowName(s,i),onClick:function(){return t.setItem(s,i)},style:{color:"#000000",textDecoration:r?"underline":"",cursor:r?"inherit":"pointer"}},n.rowName(s,i,"short"))}function W(e){var n=e.dlg,s=e.dbi,t=e.move_ttitem;return ne.createElement(F.DlgHeader,{title:ne.createElement(oe.Fragment,null,ASC.ls(7441),": ",s.tools.ttitem_popis(t,"short").subject," ",t.classids.map(function(e,t){return ne.createElement(oe.Fragment,{key:""+t},ne.createElement(i,{dlg:n,dbi:s,table:"classes",id:e})," ")})," ",t.teacherids.map(function(e,t){return ne.createElement(oe.Fragment,{key:""+t},ne.createElement(i,{dlg:n,dbi:s,table:"teachers",id:e})," ")})," ",t.classroomids.map(function(e,t){return ne.createElement(oe.Fragment,{key:""+t},ne.createElement(i,{dlg:n,dbi:s,table:"classrooms",id:e})," ")})," ",ne.createElement("span",{style:{fontSize:12}},"(",ne.createElement("a",{style:{cursor:"pointer"},onClick:function(){return n.cancelMove()}},ASC.ls(1038)),")")),icon:"/substitution/pics/subst_move_64.png",right:ne.createElement(oe.RButton,{type:"",label:ASC.ls(1333),fa_icon:"question-circle",onClick:function(){return window.open("http://help.edupage.org/text.php?id=1870","_blank")}})})}function K(e){var t=oe.useReq();return ne.createElement("div",{style:{marginTop:5}},ASC.ls(6698)+": ",[[pe,fe],[be,ge],[he,_e],["#808080",t.ls(1895)]].map(function(e,t){return ne.createElement(oe.Fragment,{key:""+t},ne.createElement("span",{style:{display:"inline-block",height:"10px",width:"10px",border:["2px",3==t?"dotted":"solid",e[0]].join(" "),verticalAlign:"middle",marginLeft:20}})," - "+ie.client_req.localize(e[1]))}))}function Y(e){for(var t=oe.useClientSize(),n=t[0],s=t[1],i=t[2],r=ne.useState(null),a=r[0],o=r[1],l=e.dbi,c=e.tt_dbi,u=e.move_ttitem,d=e.grid_mode,m=e.dlg,p=e.join_doubles,b=l.req,h=n-55-1,f=s-50-1,g=new Map,_=[],v=e.datefrom;v<=e.dateto;v=ASC.date_delta(v,1))ASC.timezone_isWeekend(v)||_.push(v);function y(e){return{y1:Math.round(e*f/_.length),y2:Math.round((e+1)*f/_.length)}}var w=T(l,c,"substonline_dates","time"==d,h,50),E=_.map(function(e,t){return te.__assign(te.__assign({date:e},y(t)),{row:l.rowData("substonline_dates",e)})}),S={dbi:l,tt_dbi:c,date:_[0],table:e.table,id:e.id,tlr:w,width:n,height:s,gap:2,gap_row:6,dayWidth:55,periodHeight:50,row2y:y,nRows:_.length,show_events:e.show_events,join_doubles:p,dlg:e.dlg,setHoverMove:o},C={x1:55,x2:55+h,y1:50,y2:50+f},x={x1:C.x1,x2:C.x2+1,y1:C.y1,y2:C.y2+1},A={x1:C.x1,x2:C.x2,y1:0,y2:50};return ne.createElement("div",{ref:i,style:te.__assign({position:"relative",backgroundColor:"#ffffff"},e.style)},ne.createElement(ue.TTView_Periods,{dbi:l,periodsBox:A,tlr:w,showTime:"time"==d}),ne.createElement(ue.TTView_OuterLines,{outerBox:x}),ne.createElement(oe.RBox,{x1:0,x2:55,y1:50,y2:s},E.map(function(e){if(!e.row)return null;var t={x1:0,x2:55,y1:e.y1,y2:e.y2},n=[];m&&m.onGoToDate&&n.push({text:ASC.ttls(3812),onclick:function(){m.close(),m.onGoToDate(e.date)}});var s="",i="";return e.row.is_online?(s="/global/pics/ui/item_warning_16.png",i=ASC.ls(1645)):e.row.uploaded_int&&(s="/substitution/pics/uploaded_32.png",i=ASC.ls(2740)),ne.createElement(ue.TTView_Header,{key:e.date,box:t,text:ne.createElement(ne.Fragment,null,ASC.ASC_date2str_day(e.date),ne.createElement("span",{style:{fontSize:10}},ASC.ASC_date2str(e.date,!1))),icon:s,icon_tooltip:i,onClick:function(e){n.length&&(ASC.showContextMenu(n,e),e.preventDefault())},style:e.date<b.timezone_date()?{color:"#c0c0c0"}:void 0,splitLineTop:0<e.y1})})),ne.createElement(oe.RBox,te.__assign({},C,{style:{overflow:"visible"}}),E.map(function(e){return e.row?ne.createElement(P,te.__assign({},{key:e.date,tvs:te.__assign(te.__assign({},S),{date:e.date}),je_upload:!!e.row.uploaded_int,ttWidth:h,y1:e.y1,y2:e.y2,ttitems_center:g,gap_row:6})):null}),ne.createElement(z,{dbi:l,ttWidth:h,ttHeight:f,move_ttitem:u,hoverMove:a,ttitems_center:g,show_moves:e.show_moves})))}function z(e){var t=e.ttWidth,n=e.ttHeight,s=e.move_ttitem,i=e.hoverMove,r=e.ttitems_center,a=e.dbi,o="url(#tien)",l=[];if(e.show_moves)for(var c=0,u=a.tableData(q);c<u.length;c++){var d=u[c];if(d.origofids.length){var m=r.get(d.id);if(m)for(var p=0,b=d.origofids;p<b.length;p++){var h=b[p],f=a.rowData(q,h);if(f){var g=r.get(f.id);g&&l.push(ne.createElement("g",{stroke:s?"rgba(255,255,255,0.5)":"#ffffff",filter:o,strokeWidth:"3",strokeLinecap:"round",key:""+l.length},ne.createElement(re.RSvgArrow,{p1:m,p2:g,head_size:20,typ:"forward"})))}}}}if(s&&i){var _=r.get(s.id);_&&l.push(ne.createElement("g",{stroke:i.color,filter:o,strokeWidth:"3",strokeLinecap:"round",key:""+l.length},ne.createElement(re.RSvgArrow,{p1:_,p2:i.center,head_size:20,typ:i.typ})))}return ne.createElement("svg",{width:t+40+10,height:n+40+20,style:{pointerEvents:"none",position:"absolute",left:-40,top:-40,zIndex:10}},ne.createElement("defs",null,ne.createElement("filter",{id:"tien"},ne.createElement("feGaussianBlur",{in:"SourceAlpha",stdDeviation:"3"}),ne.createElement("feOffset",{dx:"2",dy:"2",result:"offsetblur"}),ne.createElement("feMerge",null,ne.createElement("feMergeNode",null),ne.createElement("feMergeNode",{in:"SourceGraphic"})))),ne.createElement("g",{transform:"translate(40 40)"},l))}function p(e,t,n,s){void 0===s&&(s=[]);var i=[];if(0<e.tableData("periods").length&&"period"==se.DBITools.typeOfUniPeriod(n.uniperiod)){var r=!1;e.rowData("periods",n.uniperiod)||(r=!0),1<n.durationperiods&&!e.rowData("periods",se.DBITools.uniperiod_delta(n.uniperiod,n.durationperiods-1))&&(r=!0),r&&i.push({out:r})}var a=e.rowData("substonline_dates",n.date);if(a&&a.tt_num&&"period"==se.DBITools.typeOfUniPeriod(n.uniperiod))for(var o=parseInt(n.uniperiod),l=o+(n.durationperiods||1)-1,c=0,u=n.teacherids;c<u.length;c++){var d=u[c],m=e.rowData("teachers",d);if(m){var p=(m.subst_tt_timeoff||m.subst_tt_timeoff_vt||{})[a.tt_num];if(p)for(var b=o;b<=l;b++)"0"==ce.timeOff_get(p,a.tt_term,a.tt_week,a.tt_day,b)&&i.push({table:"teachers",id:d,subst_timeoff:!0})}}for(var h=function(e){return!!se.idsIsOverlap(e.classids,n.classids)&&!!D.ttitemUniperiodMatchSimple(se.unpartial(n),e.uniperiod)},f=0,g=e.tableFilterData("substonline_ttitems",{date:n.date});f<g.length;f++){var _=g[f];if(!(0<=s.indexOf(_.id))){if(n.durationperiods){if(!D.ttitemUniperiodMatchSimple(se.unpartial(n),_.uniperiod))continue}else if(_.uniperiod!=n.uniperiod)continue;for(var v=0,y=ae.ttitem_isClassColision(_,n,t)||[];v<y.length;v++){var w=y[v];i.push({item:_,table:"classes",id:w})}for(var E=0,S=se.idsArrayIntersect(_.teacherids,n.teacherids);E<S.length;E++){d=S[E];i.push({item:_,table:"teachers",id:d,join:h(_),subjectid:_.subjectid})}if("classroomsupervision"!==n.type)for(var C=0,x=se.idsArrayIntersect(_.classroomids,n.classroomids);C<x.length;C++){var A=x[C];i.push({item:_,table:"classrooms",id:A,join:se.idsIsOverlap(_.teacherids,n.teacherids)&&h(_)})}}}for(var T=0,I=e.tableFilterData("substonline_absents",{date:n.date});T<I.length;T++){var k=I[T];ae.substTTItem_absent_match(n,k)&&i.push({absent:k,table:ae.absentGetTable(k),id:ae.absentGetId(k)})}return i}function E(e,t,n,s){void 0===s&&(s=!1);for(var i=0,r=e;i<r.length;i++){var a=r[i];if(a.table==t&&a.id==n){if(s&&a.join)continue;return!0}}return!1}function ye(e,t,n){for(var s=[],i=0,r=p(e,t,n,[]);i<r.length;i++){for(var a=r[i],o=!1,l=0,c=s;l<c.length;l++){var u=c[l];a.absent&&u.absent==a.absent&&(o=!0),a.item&&u.item==a.item&&(o=!0)}o||s.push(a)}return s}function we(e,t){var n=se.DBITools.getUniPeriod(e)||"ad";if(n!=(se.DBITools.getUniPeriod(t)||"ad"))return!1;switch(se.DBITools.typeOfUniPeriod(n)){case"period":if((e.durationperiods||1)!=(t.durationperiods||1))return!1;break;case"starttime":if(e.endtime!=t.endtime)return!1}return!0}function P(l){var c=l.tvs,e=l.ttWidth,u=l.y1,t=l.y2,n=l.gap_row,d=l.ttitems_center,s=l.remove_ttitemids,i=l.editing_ttitems,b=c.date,h=c.dbi,f=c.tt_dbi,g=c.table,_=c.id,r=c.dlg,a=c.show_events,o=c.join_doubles,v=(r||{}).moveTTItem,m=t-u,y=c.tlr;y.clear(),y.qSize=m-n;for(var p=0,w=ae.buildSubstOnlineTTItemsEx(h,b,o);p<w.length;p++){var E=w[p];if(!(s&&0<=s.indexOf(E.id))){var S=!1;if(ae.substTTItem_filter_match(E,g,_)&&(S=!0),E.orig&&!E.added&&ae.substTTItem_filter_match(E.orig,g,_)&&(S=!0),S){var C="main";"classroomsupervision"==E.type?C="supervision":E.cancelled&&(C="autobottom"),y.addItem(C,{ttitem:E})}}}if(i)for(var x=0,A=i;x<A.length;x++){E=A[x];y.addItem("classroomsupervision"==E.type?"supervision":"main",{ttitem:E,editing:!0})}var T=[];if(a)for(var I=0,k=h.tableFilterData("events",{date:b});I<k.length;I++){var D=k[I];le.event_tableIds(D,g,{expand_ctevent:!0,dbi:h}).indexOf(_)<0&&!le.isEventCancelDay(h,D)||T.push(D)}for(var R=new Set,N=0,O=h.tableFilterData(de,{date:b});N<O.length;N++){var B=O[N];if(ae.absentGetTable(B)==g&&ae.absentGetId(B)==_){for(var j=null,M=0,U=T;M<U.length;M++){var z=U[M];if(we(z,B)){j=z,R.add(j.id);break}}y.addItem("bottom",{absent:B,event:j})}}for(var P=0,F=T;P<F.length;P++){var L=F[P];R.has(L.id)||y.addItem(le.isEventCancelDay(h,L)?"autotop":"top",{event:L})}if("teachers"==g){var G=h.rowData("teachers",_),q=h.rowData(me,b);if(G&&q){var H=(G.subst_tt_timeoff||G.subst_tt_timeoff_vt)[q.tt_num];if(H)for(var V=0,W=h.tableIds("periods");V<W.length;V++){var K=W[V],Y=ce.timeOff_get(H,q.tt_term,q.tt_week,q.tt_day,parseInt(K))||" ";"."==(Y=Y.trim())&&(Y=""),Y&&y.addItem("autobottom",{uniperiod:K,teacher_timeoff:Y})}}}var $=new Map;if(v&&"period"==se.DBITools.typeOfUniPeriod(v.uniperiod))for(var Z=function(e){if(b==v.date&&e==v.uniperiod)return"continue";var t=te.__assign(te.__assign({},v),{date:b,uniperiod:e}),n={date:b,uniperiod:e};ve(t,n);function s(e){if("classrooms"==g)return e;for(var t=e.filter(function(e){return"classrooms"!=e.table}),n=0,s=e;n<s.length;n++){var i=s[n];if("classrooms"==i.table){for(var r=!1,a=0,o=t;a<o.length;a++){var l=o[a];i.item&&l.item==i.item&&(r=!0)}r||(c=!0)}}return t}var c=!1,i=s(ye(h,f,t));if(0==i.length){var r=y.data2t(te.__assign(te.__assign({},t),n));y.addItem("overlay",{move:{typ:"forward",color:pe,name:ie.client_req.localize(fe),moves:[{orig:v,moved:t}],changeClassroom:c}},{t1:r.t1,t2:r.t2})}else for(var a=0,o=i;a<o.length;a++){var l=o[a].item;if(l&&(l.uniperiod==e&&ae.substTTItem_filter_match(l,g,_)&&ae.substTTItemMovable(l))){var u=c;c=!1;var d={date:v.date,uniperiod:v.uniperiod},m=te.__assign(te.__assign({},l),d);ve(m,d);var p=s(ye(h,f,m));1==p.length&&p[0].item&&p[0].item.id==v.id&&(1==i.length&&i[0].item.id==l.id?(u&&(c=!0),$.set(l.id,{color:be,typ:"bidi",name:ie.client_req.localize(ge),moves:[{orig:v,moved:t},{orig:l,moved:te.__assign(te.__assign({},l),d)}],changeClassroom:c})):$.set(l.id,{color:he,typ:"back",name:ie.client_req.localize(_e),moves:[{orig:v,cancel:!0},{orig:l,moved:te.__assign(te.__assign({},l),d)}],changeClassroom:c}))}}},J=0,X=h.tableIds("periods");J<X.length;J++){Z(K=X[J])}y.render();var Q=y.renderOrderItems(),ee=Q.filter(function(e){return e.data.move});return ne.createElement(oe.RBox,{x1:0,x2:e,y1:u,y2:t,style:{overflow:"visible"}},ne.createElement(ue.TTView_Lines,{dbi:h,rowHeight:m,tlr:y}),Q.map(function(e,t){var n=y.item2box(e);if(e.data.ttitem){d&&d.set(e.data.ttitem.id,new re.CPoint((e.p1+e.p2)/2,u+(e.q1+e.q2)/2));var s=$.get(e.data.ttitem.id);return ne.createElement(oe.Fragment,{key:""+t},ne.createElement(Ae,{box:n,ttitem:e.data.ttitem,je_upload:l.je_upload,tvs:c,side:"bottom"==e.part,editing:e.data.editing}),s&&ne.createElement(Se,{box:n,move:te.__assign(te.__assign({},s),{center:Ee(n,u)}),tvs:c}))}if(e.data.move){for(var i=1e5,r=0,a=ee;r<a.length;r++){var o=a[r];o.p1<=e.p1||o.q1>=e.q2||o.q2<=e.q1||(i=Math.min(i,y.item2box(o).x1))}return ne.createElement(Se,{key:""+t,box:n,move:te.__assign(te.__assign({},e.data.move),{center:Ee(n,u)}),tvs:c,cut_x:i})}return e.data.absent?ne.createElement(Ce,{key:""+t,box:n,absent:e.data.absent,tvs:c,event:e.data.event}):e.data.event?ne.createElement(xe,{key:""+t,box:n,event:e.data.event,tvs:c}):e.data.teacher_timeoff?ne.createElement(Te,{key:""+t,box:n,teacher_timeoff:e.data.teacher_timeoff}):null}))}function Ee(e,t){return void 0===t&&(t=0),new re.CPoint((e.x1+e.x2)/2,(e.y1+e.y2)/2+t)}function h(e){var i=e.dbi,r=e.tt_dbi,t=e.move,a=e.classroomRef,o=e.ignore_ttitemids,l=i.req,c=t.orig,n=t.moved,u=t.cancel,d=c;n&&(d=te.__assign(te.__assign({},d),n));function s(e){var t=e.date,n=e.uniperiod,s=i.tools.uniperiodName(n,"short",d);return d.date==c.date&&!u||(s=l.lib_date.date_format_day(t,!1,!0)+" "+s),s}return ne.createElement("div",null,ne.createElement("b",null,i.rowName("subjects",d.subjectid)),ne.createElement(oe.VGap,{height:10}),s(c),u||ne.createElement(ne.Fragment,null,ne.createElement("img",{src:"/global/pics/ui/replace_32.svg",style:{verticalAlign:"middle",height:16,padding:"0px 5px"}}),s(d)),u&&ne.createElement(ne.Fragment,null,ne.createElement(oe.VGap,{height:10}),ne.createElement("img",{src:k.action_icon("delete"),style:{height:16,verticalAlign:"middle",marginRight:5}}),l.ttls(1476)),!u&&a&&function(){var t=a.read(),e=p(i,r,te.__assign(te.__assign({},d),{classroomids:t?[t]:[]}),o),n=m.substTTItemComboItems({table:"classrooms",dbi:i,tt_dbi:r,ttitem:d,topid:d.classroomids[0],remove_ttitemids:o});t&&!n.find(function(e){return e.id==t})&&a.write("");var s=E(e,"classrooms",t);return!t&&0<c.classroomids.length&&(s=!0),ne.createElement(ne.Fragment,null,ne.createElement(oe.VGap,{height:10}),ne.createElement(oe.RLabel,{text:i.tools.itemName("classrooms")+":"}),ne.createElement(oe.RComboBox,{valueRef:a,items:n.map(function(e){return{value:e.id,name:i.rowName("classrooms",e.id),classname:e.className}})}),s&&ne.createElement("img",{src:"/global/pics/ui/item_bad_32.svg",style:{height:16,verticalAlign:"middle",marginLeft:5},title:l.ttls(3447)}))}())}function Se(e){var t=this,l=e.move,c=e.tvs,n=e.box,s=e.cut_x,i=l.color,u=l.changeClassroom,d=c.dbi,m=c.tt_dbi,p=c.join_doubles,r=ne.useState(!1),a=r[0],b=r[1],o=void 0!==s&&n.x2>s;return o&&(n=te.__assign(te.__assign({},n),{x2:s-4})),ne.createElement(oe.RBox,te.__assign({},n,{onClick:function(){return te.__awaiter(t,void 0,void 0,function(){var t,s,n,i,r,a,o=this;return te.__generator(this,function(e){switch(e.label){case 0:b(!0),c.setHoverMove(l),e.label=1;case 1:for(e.trys.push([1,,3,4]),t={moves_classroomid:l.moves.map(function(e){return e.orig.classroomids[0]||""})},s=[],n=0,i=l.moves;n<i.length;n++)r=i[n],s.push(r.orig.id);return[4,oe.RDialog.showInput(t,function(e){e.state;var n=e.stateRef;return c.setHoverMove(l),ne.createElement(ne.Fragment,null,ne.createElement(F.DlgHeader,{title:l.name,icon:"/substitution/pics/subst_move_64.png",small:!0}),ne.createElement(F.RJoin,{children:l.moves.map(function(e,t){return ne.createElement(h,{dbi:d,tt_dbi:m,move:e,classroomRef:u?oe.indexRef(oe.subRef(n,"moves_classroomid"),t):null,ignore_ttitemids:s})}),glue:ne.createElement(F.SeparatorLine,null)}))},{width:400,buttons:[{label:l.name,action:"ok",type:"default"},"cancel"]})];case 2:return(a=e.sent())&&ASC.blockUI(function(){return te.__awaiter(o,void 0,void 0,function(){var t,n,s,i;return te.__generator(this,function(e){switch(e.label){case 0:t=0,e.label=1;case 1:return t<l.moves.length?(n=l.moves[t],s=a.moves_classroomid[t],n.cancel?[4,I.removeSubstOnlineTTItem(null,n.orig.id,p)]:[3,3]):[3,6];case 2:return e.sent(),[3,5];case 3:return[4,I.updateSubstTTItem(null,n.orig.id,{date:n.moved.date,uniperiod:n.moved.uniperiod,teacherids:n.moved.teacherids,classroomids:u?s?[s]:[]:void 0},{},p)];case 4:i=e.sent(),0==t&&c.dlg.setMoveTTItemid(i),e.label=5;case 5:return t++,[3,1];case 6:return[2]}})})}),[3,4];case 3:return b(!1),c.setHoverMove(null),[7];case 4:return[2]}})})},onMouseEnter:function(){return c.setHoverMove(l)},onMouseLeave:function(){a||c.setHoverMove(null)},style:{borderWidth:3,borderStyle:u?"dashed":"solid",borderColor:i,borderRightWidth:o?0:void 0}}))}function Ce(e){var n=e.absent,t=e.tvs,s=e.event,i=t.dbi,r=i.rowName("absent_types",n.absent_typeid);return r=r||ASC.ls(1846),"classes"==ae.absentGetTable(n)&&n.groupname&&(r+=" ("+n.groupname+")"),s&&(r+=", "+o.eventName(i,s)),ne.createElement(oe.RTextBox,te.__assign({},e.box,{text:r,title:r,hAlign:"center",vAlign:"center",style:{background:s?a.BACKGROUND_event_absent:a.BACKGROUND_absent,borderRadius:3,color:"#ffffff",textShadow:"0px 0px 1px #000000",padding:2,cursor:"pointer"},onClick:function(e){e.preventDefault();var t=[];t.push(te.__assign(te.__assign({},k.action_menu("details")),{onclick:function(){return d(i,n)}})),s&&(t.push([]),t.push({text:i.tools.itemName("events"),icon:i.table("events").icon(),onclick:function(){return l(i,s)}})),ASC.showContextMenu(t,e)}}))}function xe(e){var n=e.event,s=e.tvs.dbi,t=o.eventName(s,n);return ne.createElement(oe.RTextBox,te.__assign({},e.box,{text:t,title:t,hAlign:"center",vAlign:"center",style:{backgroundColor:a.BACKGROUND_event,borderRadius:3,color:"#00000",padding:2,whiteSpace:"nowrap",cursor:"pointer"},onClick:function(e){e.preventDefault();var t=[];t.push(te.__assign(te.__assign({},k.action_menu("details")),{onclick:function(){return l(s,n)}})),ASC.showContextMenu(t,e)}}))}function Ae(e){var o,t,l=this,c=e.ttitem,n=e.tvs,s=e.box,i=e.side,u=e.je_upload,d=n.dbi,m=n.table,p=n.id,b=n.dlg,h=(b||{}).moveTTItem,f=c,r="#c0c0c0",a="",g=!1,_=!1,v=e.editing||!1;if(a=ae.susbtTTItemPopis(f,d,"short"),h&&f.id==h.id&&(g=!0),o=ae.substTTItem_filter_match(f,m,p),t=!(!f.added&&f.orig)||ae.substTTItem_filter_match(f.orig,m,p),o?(r=t?R:O,"classes"==m&&f.orig&&!se.idsArrayMatch(f.teacherids,f.orig.teacherids)&&(r=O)):t&&("teachers"!=m||v?(r=j,_=!0):r=N),f.cancelled)if(f.origofids&&f.origofids.length){r=B;var y=d.rowData("substonline_ttitems",f.origofids[0]);a=ASC.ttls(3194),y&&(a=y.date!=f.date?ASC.ttls(3194)+": "+ASC.ASC_date2str(f.date,!1)+" -> "+ASC.ASC_date2str(y.date,!1):ASC.ttls(3194)+": "+d.rowName("periods",f.uniperiod,"short")+" -> "+d.rowName("periods",y.uniperiod,"short"))}else r=j,_=!0,a=ASC.ls(2322)+": "+ae.susbtTTItemPopis(f.orig,d,"short");g&&(r=M),v&&(r=_?j:U);var w="",E="",S="",C="",x=null,A="#000000";o?x=f:f&&f.orig&&(x=f.orig,A="#808080"),o||t||!g||(r="#ff8080",A="#808080"),x&&(w="classroomsupervision"==x.type?ASC.ls(1723):d.rowName("subjects",x.subjectid,"short"),"classes"==m?C=d.rowNames("teachers",x.teacherids,"short"):f.classids&&(C=d.rowNames("classes",x.classids,"short")),f.groupnames&&!se.DBITools.groupnamesIsEntireClass(x.groupnames)&&(E=d.tools.groupnames_names(x.groupnames)),"classroomsupervision"==x.type&&(S=d.rowNames("classrooms",x.classroomids,"short")));var T="";return"classroomsupervision"==f.type&&(T="1px solid black"),ne.createElement(oe.Fragment,null,ne.createElement(oe.RTextBox,te.__assign({},s,{text:w,hAlign:"center",vAlign:"center",style:{backgroundColor:r,color:A,padding:1,fontSize:i?void 0:18,borderRadius:3,cursor:"pointer",border:T},title:a,onClick:function(e){e.preventDefault();var t=[];if(t.push(te.__assign(te.__assign({},k.action_menu("details")),{onclick:function(){return $(d,c)}})),b){o&&!u&&(ae.substTTItemMovable(f)&&(t.push([]),t.push({text:ASC.ls(7441),icon:ae.ICON_subst_movelesson,onclick:function(){b.setMoveTTItemid(f.id)}})),t.push([]),t.push({text:ASC.ttls(1476),icon:k.action_icon("delete"),onclick:function(){return te.__awaiter(l,void 0,void 0,function(){return te.__generator(this,function(e){switch(e.label){case 0:return confirm(ASC.ttls(1476)+"\n"+ASC.ls(1054))?[4,ASC.blockUI(I.removeSubstOnlineTTItem(null,f.id,1<f.durationperiods))]:[3,2];case 1:e.sent(),h&&f.id==h.id&&b.cancelMove(),e.label=2;case 2:return[2]}})})}}));var i=[];if(f){var r=f;!o&&f.orig&&(r=f.orig);for(var n=function(t){"classes"!=t&&i.push([]);for(var e=function(e){i.push({icon:d.table(t).icon(),text:d.rowName(t,e),checked:t==m&&e==p,onclick:function(){return b.setItem(t,e)}})},n=0,s=ae.substTTItem_tableIds(r,t);n<s.length;n++){e(s[n])}},s=0,a=["classes","teachers","classrooms"];s<a.length;s++){n(a[s])}}i.length&&(t.push([]),t.push({text:ASC.ls(1489),icon:k.action_icon("timetable"),submenu:i}))}t.length&&ASC.showContextMenu(t,e)}})),!i&&ne.createElement(ne.Fragment,null,E&&ne.createElement(oe.RTextBox,te.__assign({},e.box,{text:E,hAlign:"left",vAlign:"top",style:{color:A,paddingLeft:3,paddingTop:1,fontSize:10,pointerEvents:"none"}})),S&&ne.createElement(oe.RTextBox,te.__assign({},e.box,{text:S,hAlign:"right",vAlign:"top",style:{color:A,paddingRight:3,paddingTop:1,fontSize:10,pointerEvents:"none"}})),C&&ne.createElement(oe.RTextBox,te.__assign({},e.box,{text:C,hAlign:"left",vAlign:"bottom",style:{color:A,paddingLeft:3,paddingBottom:1,fontSize:10,pointerEvents:"none"}}))),_&&ne.createElement("img",{src:"/substitution/pics/no_11.png",style:{position:"absolute",left:s.x1,top:s.y1,pointerEvents:"none"}}),(g||v)&&ne.createElement(ue.TTView_CellSelect,{box:s}))}function Te(e){for(var t=e.box,n=e.teacher_timeoff,s="",i="",r=0,a=ce.substTimeOff_Icons;r<a.length;r++){var o=a[r];o.d==n&&(s=o.img,i=ie.client_req.localize(o.name))}return ne.createElement(oe.RBox,te.__assign({},t,{style:{backgroundColor:"#e0e0e0",borderRadius:3,display:"flex",justifyContent:"center",alignItems:"center"},title:i}),ne.createElement("img",{src:s,style:{height:Math.min(t.y2-t.y1-2,16)}}))}a.SubstTimetableDlg=function(e){var t=ne.useRef(),n=oe.useReq(),s=e.join_doubles,i=e.onGoToDate,r=ne.useState({table:e.table,id:e.id}),a=r[0],o=a.table,l=a.id,c=r[1],u=n.lib_date.date_week(e.date),d=ne.useState(n.lib_date.week_start(u)),m=d[0],p=d[1],b=ne.useState(n.lib_date.week_end(u)),h=b[0],f=b[1],g=ne.useState(""),_=g[0],v=g[1],y=oe.useStateValueRef(!0),w=y.read(),E=oe.useStateValueRef("periods"),S=E.read();ne.useEffect(function(){return barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstTimetableDlg.open",eventLabel:""})},[]);for(var C=G.useMainDBI(n.getSchoolYear(h),{needed_part:H,vt_filter:{datefrom:m,dateto:h}}),x="",A=0,T=C.tableData("substonline_dates");A<T.length;A++){var I=T[A];if(I.date>=m&&I.date<=h&&I.tt_num){x=I.tt_num;break}}var k=G.useTTDBI(x,{needed_part:V}),D=ne.useRef(!0);if(D.current&&!C.mock&&(D.current=!1,e.move_substid))for(var R=0,N=C.tableData(q);R<N.length;R++){var O=N[R];if(0<=O.substids.indexOf(e.move_substid)&&!O.cancelled){v(O.id);break}}var B=null;if(_)if(s){var j=_.split(":")[0],M=ae.buildSubstOnlineTTItemsEx(C,j,s,{table:"substonline_ttitems"});B=M.find(function(e){return e.id==_})}else B=C.rowData(q,_);function U(e){void 0===e&&(e=!1);var t=se.DBITools.splitItemsForCombo(C.tableData(o),m).map(function(e){return e.id});if(t.length){var n=t.indexOf(l)+(e?t.length-1:1);n%=t.length,c({table:o,id:t[n]})}}B&&ve(te.__assign({},B),{});var z={close:function(){return t.current.confirmClose()},onGoToDate:i,table:o,id:l,setItem:function(e,t){return c({table:e,id:t})},moveTTItem:B,setMoveTTItemid:v,cancelMove:function(){v(""),f(L.date_delta(m,6))}},P=ne.createElement(oe.Fragment,null,ne.createElement("i",{className:"fa fa-arrow-circle-left",style:{cursor:"pointer",marginLeft:0},onClick:function(){return U(!0)},onMouseDown:function(e){return e.preventDefault()}}),ne.createElement("i",{className:"fa fa-arrow-circle-right",style:{cursor:"pointer",marginLeft:5,marginRight:10},onClick:function(){return U(!1)},onMouseDown:function(e){return e.preventDefault()}}),C.table(o).itemName()," ",C.rowName(o,l),ne.createElement("i",{className:"fa fa-caret-down",style:{cursor:"pointer",marginLeft:10},onClick:function(e){return ASC.showContextMenu(se.DBITools.splitItemsForCombo(C.tableData(o),m).map(function(e){return{text:C.rowName(o,e.id,ie.client_req.sort_name_col),checked:l==e.id,onclick:function(){return c({table:o,id:e.id})},style:e.cb_hidden?"color: #c0c0c0":""}}),e)}}));return ne.createElement(oe.RDialog,{ref:t,header:ASC.ls(1001)+" + "+ASC.ls(1003),width:800,height:600,buttons:["close"],backgroundColor:"#ffffff",footer:ne.createElement(oe.Fragment,null,oe.rangeFromTo(0,1).map(function(t){return ne.createElement(oe.RButton,{key:""+t,label:0==t?"<< "+ASC.ls(1729):ASC.ls(1729)+" >>",onClick:function(){var e=0==t?-7:7;B?0==t?p(L.date_delta(m,e)):f(L.date_delta(h,e)):(p(L.date_delta(m,e)),f(L.date_delta(h,e)))}})}),ne.createElement("span",{style:{width:10,display:"inline-block"}}),ne.createElement("span",null,ASC.ls(1691),": "),ne.createElement(oe.RComboBox,{valueRef:E,items:[{value:"periods",name:ASC.ls(6399)},{value:"time",name:ASC.ls(1345)}]}),ne.createElement("span",{style:{width:10,display:"inline-block"}}),ne.createElement("span",null,ASC.ls(1489),": "),ne.createElement(oe.RCheckBox,{label:ASC.ls(1844),valueRef:y})),allowMaximizeBtn:!0},ne.createElement("div",{style:{display:"flex",width:"100%",height:"100%",flexDirection:"column"}},B?ne.createElement(W,{dlg:z,dbi:C,move_ttitem:B}):ne.createElement(F.DlgHeader,{title:P,icon:"/global/pics/ui/timetables_48.svg"}),ne.createElement(Y,{style:{flex:"1"},datefrom:m,dateto:h,dbi:C,tt_dbi:k,table:o,id:l,show_moves:!0,show_events:w,move_ttitem:B,grid_mode:S,join_doubles:s,dlg:z}),B&&ne.createElement(K,null)))},a.makeTLR=T,a.TimetableView_Periods=function(e){var t=e.tlr,n=e.dbi,s=e.onPeriodClick,i=e.periodHeight;t.clear(),t.qSize=i;for(var r=t,a=0,o=n.tableData("periods");a<o.length;a++){var l=o[a];r.addItem("main",l)}return r.render(),ne.createElement(oe.Fragment,null,r.items.map(function(e){var t=e.data,n=r.item2box(e);return ne.createElement(oe.Fragment,{key:t.id},ne.createElement(oe.RTextBox,te.__assign({},n,{text:t.short,hAlign:"center",vAlign:"center",style:{fontSize:18,cursor:s?"pointer":void 0},onClick:s?function(){return s(t.id)}:void 0})),ne.createElement(oe.RTextBox,te.__assign({},n,{text:ASC.ASC_time2str(t.starttime,{ajSekundy:!1})+" - "+ASC.ASC_time2str(t.endtime,{ajSekundy:!1}),hAlign:"center",vAlign:"bottom",style:{fontSize:10,whiteSpace:"nowrap",pointerEvents:"none"}})))}))},(a.getSubstTTItemKolizie=p).npp=ae.substOnlineNeededPartProvider(function(){return[ae.substTTItem_absent_match,{periods:[],teachers:["subst_tt_timeoff"],substonline_dates:["tt_num","tt_term","tt_week","tt_day"],substonline_ttitems:["uniperiod","teacherids","classids","groupnames","classroomids"],substonline_absents:[]}]}),p.ttdbi={npp:se.neededPartProvider(function(){return[ae.ttitem_isClassColision.ttdbi]})},a.jeSubstKoliziaRow=E,a.jeSubstKolizaAbsent=function(e,t,n){for(var s=0,i=e;s<i.length;s++){var r=i[s];if(r.table==t&&r.id==n&&r.absent)return!0}return!1},a.BACKGROUND_absent="#7b7b7b",a.BACKGROUND_event="#d0ffd0",a.BACKGROUND_event_absent="repeating-linear-gradient(-45deg, #87A587, #87A587 5px, #7b7b7b 5px, #7b7b7b 10px)";var f=(t.prototype.clear=function(){this.items.length=0},t.prototype.addItem=function(e,t,n){void 0===n&&(n={});var s=n.t1,i=n.t2;if(void 0===s||void 0===i){var r=this.data2t(t);s=r.t1,i=r.t2}(isNaN(s)||isNaN(i))&&ASC.dieError("0685305852"),this.items.push({data:t,part:e,t1:s,t2:i,slices:n.slices||"",order:n.order,r1:0,r2:0,p1:0,p2:0,q1:0,q2:0})},t.prototype.t2p=function(e){var t=(e-this.tMin)/(this.tMax-this.tMin)*(this.pSize+this.gap);return(t=Math.round(t))<0&&(t=0),t>this.pSize&&(t=this.pSize),"number"==typeof t&&!isNaN(t)||ASC.dieError("5985426422"),t},t.prototype.p2t=function(e){return this.tMin+e/this.pSize*(this.tMax-this.tMin)},t.prototype.item2box=function(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=0),{x1:e.p1+t,x2:e.p2+t,y1:e.q1+n,y2:e.q2+n}},t.prototype.initSpan=function(e,t){if(void 0===t&&(t=!0),t){this.rSpan=[];for(var n=0;n<this.rSize;n++)this.rSpan.push(!1)}for(var s=0,i=e;s<i.length;s++){var r=i[s];for(n=r.r1;n+1<r.r2;n++)this.rSpan[n]=!0}},t.prototype.partItems=function(t){return this.items.filter(function(e){return e.part==t})},t.prototype.renderPart=function(v){var y=this.partItems(v);this.initSpan(y);for(var w,E=this.gap,S=[],e=0;e<this.rSize;e++)S.push([]);for(var t=function(t){for(w=t;C.rSpan[w];)w++;w++;var i=y.filter(function(e){return e.r1>=t&&e.r1<w});if(0==i.length)return"continue";var r=0,a=C.qSize;if("main"==v||"supervision"==v)for(var e=t;e<w;e++)r=Math.max(r,C.r2qSideTop[e]),a=Math.min(a,C.r2qSideBottom[e]);if("supervision"==v||"supervisionside"==v){var n=a-r;a=Math.round(r+.75*n),r=Math.round(r+.25*n)}if("main"==v&&!i.find(function(e){return!e.slices})){for(var o=!0,l=i[0].slices.length,s=function(t){var n=t.slices;if(n.length!=l&&(o=!1),i.find(function(e){return e!=t&&function(e,t){for(var n=0;n<e.length;n++)if("1"==e[n]&&"1"==t[n])return!0;return!1}(e.slices,n)})&&(o=!1),!o)return"break";for(var e=0;e<n.length;){var s=n.indexOf("1",e);if(s<0)break;(e=n.indexOf("0",s))<0&&(e=n.length),t.q1=Math.round(r+s*(a-r+E)/l),t.q2=Math.round(r+e*(a-r+E)/l-E)}},c=0,u=i;c<u.length&&"break"!==s(p=u[c]);c++);if(o)return"continue"}"top"!=v&&"bottom"!=v||i.sort(function(e,t){return t.t2-t.t1-(e.t2-e.t1)}),"main"==v&&i.sort(function(e,t){return e.order-t.order});for(var d=0,m=i;d<m.length;d++){for(var p=m[d],b=0;;){var h=!1;for(e=p.r1;e<p.r2;e++)S[e][b]&&(h=!0);if(!h)break;b++}for(e=p.r1;e<p.r2;e++)S[e][b]=p}var f=1;for(e=t;e<w;e++)f=Math.max(f,S[e].length);for("top"==v&&(a=f*(C.qSide+E)-E),"bottom"==v&&(r=C.qSize-(f*(C.qSide+E)-E)),e=t;e<w;e++)for(var g=0;g<S[e].length;g++)if((p=S[e][g])&&p.r1==e){var _=g;"bottom"==v&&(_=f-g-1),p.q1=Math.round(r+_*(a-r+E)/f),p.q2=Math.round(r+(_+1)*(a-r+E)/f-E)}},C=this,n=0;n<this.rSize;n=w)t(n);if("top"==v)for(var s=0,i=y;s<i.length;s++)for(e=(o=i[s]).r1;e<o.r2;e++)this.r2qSideTop[e]=Math.max(this.r2qSideTop[e],o.q2+E);if("bottom"==v)for(var r=0,a=y;r<a.length;r++){var o;for(e=(o=a[r]).r1;e<o.r2;e++)this.r2qSideBottom[e]=Math.min(this.r2qSideBottom[e],o.q1-E)}},t.prototype.render=function(){for(var t=this,e=new Set,n=0,s=this.items;n<s.length;n++){var i=s[n];e.add(i.t1),e.add(i.t2)}this.r2t=[],e.forEach(function(e){return t.r2t.push(e)}),this.r2t.sort(function(e,t){return e-t}),this.rSize=this.r2t.length,this.t2r=new Map,this.r2qSideTop=[],this.r2qSideBottom=[];for(var r=0;r<this.rSize;r++)this.t2r.set(this.r2t[r],r),this.r2qSideTop.push(0),this.r2qSideBottom.push(this.qSize);for(var a=0,o=this.items;a<o.length;a++)(i=o[a]).r1=this.t2r.get(i.t1),i.r2=this.t2r.get(i.t2),"supervisionside"==i.part&&(i.r2=i.r1+1,this.rSize=Math.max(this.rSize,i.r2));var l=te.__spreadArrays(this.partItems("autotop"),this.partItems("autobottom"));if(0<l.length){for(var c=[],u=0,d=this.items;u<d.length;u++)if("main"==(i=d[u]).part||"supervision"==i.part)for(r=i.r1;r<i.r2;r++)c[r]=!0;for(var m=0,p=l;m<p.length;m++){var b=(i=p[m]).part;for(i.part="main",r=i.r1;r<i.r2;r++)if(c[r]){i.part="autotop"==b?"top":"bottom";break}}}for(var h=0,f=this.items;h<f.length;h++)if((i=f[h]).p1=this.t2p(i.t1),i.p2=this.t2p(i.t2)-this.gap,"supervisionside"==i.part){var g=this.t2p((i.t1+i.t2)/2),_=this.qSide,v=this.pSize,y=g-_/2;y=Math.max(y,0),y=Math.min(y,v-_),i.p1=y,i.p2=y+_}this.renderPart("top"),this.renderPart("bottom"),this.renderPart("main"),this.renderPart("supervision"),this.renderPart("supervisionside");for(var w=0,E=this.partItems("overlay");w<E.length;w++)(i=E[w]).q1=0,i.q2=this.qSize},t.prototype.renderOrderItems=function(){return te.__spreadArrays(this.partItems("top"),this.partItems("bottom"),this.partItems("main"),this.partItems("supervision"),this.partItems("supervisionside"),this.partItems("overlay"))},t);function t(e,t,n,s){this.pSize=e,this.qSize=t,this.tMin=n,this.tMax=s,this.items=[],this.gap=1,this.qSide=14,this.data2t=null,this.rSize=0,this.t2r=null,this.r2t=null,this.r2qSideTop=null,this.r2qSideBottom=null,this.rSpan=null}function s(e,t){for(var r=b(e,t),i=1,a=1,o=[0],l=[0],n=0,s=e.tableData("periods");n<s.length;n++){var c=s[n],u=parseInt(c.id);i=Math.min(i,u),a=Math.max(a,u+1);var d=ae.time2int(c.starttime),m=ae.time2int(c.endtime);o[u]=d,l[u]=m}if(r.maxT>l[l.length-1]){u=l.length;o[u]=l[l.length-1],l[u]=r.maxT,a=Math.max(a,u+1)}function p(e,t){for(var n=0;n<o.length;n++)if(!(e>l[n])){if(e<o[n])return n;var s=l[n]-o[n];return 0<s?(e-o[n])/s+n:n}return t?a:i}return{minT:i,maxT:a,t:function(e){var t=e.uniperiod;if(t)switch(se.DBITools.typeOfUniPeriod(t)){case"period":var n=parseInt(t);return"classroomsupervision"==e.type?{t1:n+.25,t2:n+.75}:{t1:n,t2:n+(e.durationperiods||1)};case"break":var s=parseInt(t.substr(1));return{t1:s-.25,t2:s+.25}}var i=r.t(e);return{t1:p(i.t1,!1),t2:p(i.t2,!0)}}}}function b(e,t){var c=e.table("periods"),u=e.table("breaks"),d=e.table("dayparts");return{minT:420,maxT:1080,t:function(e){var t=e.uniperiod;if(t)switch(se.DBITools.typeOfUniPeriod(t)){case"period":var n=null;if(r=c.rowData(t))return 2<=e.durationperiods&&(n=c.rowData(parseInt(t)+e.durationperiods-1+"")),{t1:ae.time2int(r.starttime),t2:ae.time2int((n||r).endtime)};break;case"break":var s=t.substr(1),i=u.rowData(s);if(i)return{t1:ae.time2int(i.starttime),t2:ae.time2int(i.endtime)};var r=c.rowData(s),a=c.rowData(""+(parseInt(s)-1));if(r&&a)return{t1:ae.time2int(a.endtime),t2:ae.time2int(r.starttime)};break;case"daypart":var o=d.rowData(t);if(o)return{t1:ae.time2int(o.starttime),t2:ae.time2int(o.endtime)};break;case"starttime":var l=ae.time2int(t);return{t1:l,t2:e.endtime?ae.time2int(e.endtime):l+5}}return{t1:0,t2:0}}}}function c(e){var t=e.label,n=e.text,s=e.orig_text;return ne.createElement(oe.Fragment,null,ne.createElement("span",{style:{display:"inline-block",width:120,fontWeight:"bold",color:"#808080"}},t),ne.createElement("div",{style:{marginLeft:50,fontSize:18}},s&&n!=s&&ne.createElement(oe.Fragment,null,s," ",ne.createElement("i",{className:"fa fa-arrow-right"})," "),n||s&&"(x)"),ne.createElement("div",{style:{height:15}}))}function u(e,t){oe.RDialog.showMessage(e,{width:400,header:k.action_name("details"),srcFunction:t,buttons:["close"]})}function $(o,l){return te.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a;return te.__generator(this,function(e){return t="name",n=o.tools.ttitem_popis(l,t),s=ASC.ls(1843),"/global/pics/ui/zoom_64.png",i="",l.cancelled&&(i=ASC.ls(2322),n=o.tools.ttitem_popis(l.orig,t),l.origofids.length&&(1==l.origofids.length?i+=" - "+ASC.lsf(7442,{date:ASC.ASC_date2str(l.origofids[0].split(":")[0])}):i+=" - split to "+l.origofids.length)),r=l.orig?o.tools.ttitem_popis(te.__assign(te.__assign({},l.orig),{durationperiods:l.durationperiods}),t):n,a=ASC.ls(1345),u(ne.createElement(oe.Fragment,null,ne.createElement(F.DlgHeader,{title:s,icon:"/global/pics/ui/zoom_64.png",small:!0}),i&&ne.createElement("h3",null,i,":"),ne.createElement(c,{label:a,text:n.period,orig_text:r.period}),ne.createElement(c,{label:ASC.ls(1299),text:n.subject,orig_text:r.subject}),ne.createElement(c,{label:ASC.ls(1263),text:n.class,orig_text:r.class}),ne.createElement(c,{label:ASC.ls(1300),text:n.teacher,orig_text:r.teacher}),ne.createElement(c,{label:ASC.ls(1197),text:n.classroom,orig_text:r.classroom})),$),[2]})})}function l(e,t){var n=e.table("events"),s=se.DBITools.getUniPeriod(t);u(ne.createElement(oe.Fragment,null,ne.createElement(F.DlgHeader,{title:n.itemName(),icon:n.icon(),small:!0}),ne.createElement(c,{label:e.tools.columnName("events","typ"),text:e.rowName("event_types",t.typ)}),t.name&&ne.createElement(c,{label:e.tools.columnName("events","name"),text:t.name}),ne.createElement(c,{label:e.tools.uniperiodLabel(s,t),text:e.tools.uniperiodName(s,void 0,t)}),t.subjectid&&ne.createElement(c,{label:e.tools.itemName("subjects"),text:e.rowName("subjects",t.subjectid)}),0<t.classids.length&&ne.createElement(c,{label:e.tools.itemName("classes",t.classids.length),text:e.rowNames("classes",t.classids)+" "+e.tools.groupnames_names(t.groupnames)}),0<t.teacherids.length&&ne.createElement(c,{label:e.tools.itemName("teachers",t.teacherids.length),text:e.rowNames("teachers",t.teacherids)}),0<t.classroomids.length&&ne.createElement(c,{label:e.tools.itemName("classrooms",t.classroomids.length),text:e.rowNames("classrooms",t.classroomids)})),l)}function d(e,t){var n=e.table(de),s=se.DBITools.getUniPeriod(t),i=ae.absentGetTable(t),r=ae.absentGetId(t);u(ne.createElement(oe.Fragment,null,ne.createElement(F.DlgHeader,{title:n.itemName(),icon:n.icon(),small:!0}),ne.createElement(c,{label:e.tools.itemName(i),text:e.rowName(i,r)+("classes"==i&&t.groupname?" "+t.groupname:"")}),ne.createElement(c,{label:e.tools.uniperiodLabel(s,t),text:e.tools.uniperiodName(s,void 0,t)}),t.absent_typeid&&ne.createElement(c,{label:e.tools.itemName("absent_types"),text:e.rowName("absent_types",t.absent_typeid)})),l)}a.TimetableLayoutRenderer=f,a.TTLR_TProvider_periods=s,a.TTLR_TProvider_time=b,a.TTLR_TProvider_uni=function(e,t,n){return"time"==e?b(t):s(t,n)},a.showTTItemInfo=$,a.showEventInfo=l,a.showAbsentInfo=d,a.SubstDlgTimetableView=function(e){var c=e.dbi,t=e.tt_dbi,n=e.date,s=e.items,o=e.remove_ttitemids,l=e.editing_ttitems,i=e.onPeriodClick,u=e.kolizie,r=e.join_doubles,a=oe.useClientSize(),d=a[0],m=a[1],p=a[2],b=d-80-1,h=m-40-1,f=T(c,t,"substonline_dates",!1,b,40);function g(e){return{y1:Math.round(e*h/s.length),y2:Math.round((e+1)*h/s.length)}}f.gap=1,f.pSize=b;var _={dbi:c,tt_dbi:t,date:n,table:"",id:"",tlr:f,width:d,height:m,gap:1,gap_row:4,dayWidth:80,periodHeight:40,row2y:g,nRows:s.length,show_events:!0,join_doubles:r},v={x1:80,x2:80+b,y1:40,y2:40+h},y={x1:v.x1,x2:v.x2+1,y1:v.y1,y2:v.y2+1},w={x1:v.x1,x2:v.x2,y1:0,y2:40};return ne.createElement("div",{ref:p,style:te.__assign({position:"relative",backgroundColor:"#ffffff"},e.style||{})},ne.createElement(ue.TTView_OuterLines,{outerBox:y}),ne.createElement(ue.TTView_Periods,{periodsBox:w,dbi:c,tlr:f,onPeriodClick:i}),ne.createElement(oe.RBox,{x1:0,x2:80,y1:40,y2:m},s.map(function(e,t){var n=e.table,s=e.id,i=g(t),r=i.y1,a=i.y2,o="",l="";return u&&E(u,n,s)&&(l=E(u,n,s,!0)?(o=ae.ICON_subst_kolizia,ASC.ttls(3447)):(o=ae.ICON_subst_spojenie,ASC.ttls(1535))),ne.createElement(ue.TTView_Object,{key:n+":"+s,box:{x1:0,x2:80,y1:r,y2:a},dbi:c,table:n,id:s,splitLineTop:0<t,showTable:!0,icon:o,icon_tooltip:l})})),ne.createElement(oe.RBox,te.__assign({},v,{style:{overflow:"visible"}}),s.map(function(e,t){var n=e.table,s=e.id,i=g(t),r=i.y1,a=i.y2;return ne.createElement(P,te.__assign({},{key:n+":"+s,tvs:te.__assign(te.__assign({},_),{table:n,id:s}),ttWidth:b,y1:r,y2:a,gap_row:4,remove_ttitemids:o,editing_ttitems:l}))})))},a._hotswap=[h]}),ASC.setModuleSourceFunc("/asc/svg.js",function(e,require,t){e.__esModule=!0;var s=require("tslib"),d=require("react"),m=require("./asc_react");function C(e,t){return void 0===t&&(t=null),$j(function(e,t){void 0===t&&(t=null);t=t||document;return t.createElementNS("http://www.w3.org/2000/svg",e)}(e,t))}function x(e){return e.get(0).getBBox()}var A=1,n=(i.prototype.Padded=function(e){var t=C("g",this.page_document).appendTo(this.$page);t.attr("transform","translate("+e+" "+e+")");var n=new i(t);return n.width=this.width-2*e,n.height=this.height-2*e,n},i.prototype.SvgEl=function(e,t){var n=C(e,this.page_document);return t&&n.appendTo(t),n},i.prototype.Line=function(e,t,n,s,i){return this.SvgEl("line",this.$page).attr({x1:e,y1:t,x2:n,y2:s,"stroke-width":i*this.extraScale})},i.prototype.LineP=function(e,t,n){return this.Line(e.x,e.y,t.x,t.y,n)},i.prototype.CurvedLine=function(e,t,n){var s=t.sub(e).rotate(Math.PI/2).mul(.1),i=e.midPointTo(t,.2).add(s),r=e.midPointTo(t,.8).add(s);return this.SvgEl("path",this.$page).attr({d:"M"+e.svgStr()+" C "+i.svgStr()+","+r.svgStr()+","+t.svgStr(),"stroke-width":n*this.extraScale,fill:"none"})},i.prototype.Arrow=function(e,t,n,s,i){var r=this;void 0===i&&(i="forward");var a=Math.PI/6,o=function(e,t){return r.LineP(e,t,s)},l=a,c=-a,u=0;o=function(e,t){return r.CurvedLine(e,t,s)},u=-.4;var d=t.sub(e).normalized().mul(n),m=o(e,t);return"forward"!=i&&"bidi"!=i||(m=m.add(o(t.sub(d.rotate(l+u)),t)).add(o(t,t.sub(d.rotate(c+u)))).attr("stroke-linecap","round")),"back"!=i&&"bidi"!=i||(m=m.add(o(e.add(d.rotate(l-u)),e)).add(o(e,e.add(d.rotate(c-u)))).attr("stroke-linecap","round")),m.css({"pointer-events":"none"}),this.Group(m)},i.prototype.Group=function(e){return this.SvgEl("g",this.$page).append(e)},i.prototype.Line_swap=function(e,t,n,s,i,r){return e?this.Line(n,t,i,s,r):this.Line(t,n,s,i,r)},i.prototype.FixFont=function(e){return 0<=["arial","courier","times new roman"].indexOf(e.toLowerCase())?e:e+",Arial"},i.prototype.Rect=function(e,t,n){var s=C("rect",this.page_document).attr({x:e.x1,y:e.y1,width:e.width(),height:e.height(),style:"fill:"+t}).appendTo(this.$page);return 0<n?s.attr("stroke-width",n*this.extraScale):s.attr("stroke","none"),s},i.prototype.TextBox=function(e,t,n,s,i,r){void 0===s&&(s=0),void 0===i&&(i=0),void 0===r&&(r={}),t=Math.min(t,e.height());var a=C("text",this.page_document).attr({"font-size":t,"text-rendering":"geometricPrecision","text-anchor":s<0?"start":0<s?"end":"middle","dominant-baseline":i<0?"text-before-edge":0<i?"text-after-edge":"central"}).appendTo(this.$page).css("pointer-events","none").css("white-space","pre").text(n);r.bold&&a.css("font-weight","bold"),r.italic&&a.css("font-style","italic"),r.underline&&a.css("text-decoration","underline"),r.font&&a.css("font-family",this.FixFont(r.font));var o=a[0];t>e.height()&&(t=e.height(),a.attr("font-size",t));var l=e.width(),c=e.height(),u=1,d=o.getComputedTextLength();if(l<d)if(r.wrap){for(var m=[],p=0;p<n.length;){for(var b=p,h=!1;b<n.length;){var f=b+1;if(h||(f=n.indexOf(" ",f))<0&&(f=n.length),o.getSubStringLength(p,f-p)>l){if(p<b)break;if(h){b=n.length;break}h=!0,b=p}else b=f}for(m.push(n.substring(p,b).trim()),p=b;" "==n.charAt(p);)p++}a.empty();for(var g=0,_=m;g<_.length;g++){var v=_[g],y=C("tspan",this.page_document).appendTo(a).text(v);v!=m[0]&&y.attr({dy:t})}u=m.length}else r.shrink&&(t=t*l/d,a.attr("font-size",t));if((1<u?a.find("tspan"):a).attr("x",e.x1+(1+s)*l/2),a.attr("y",e.y1+(1+i)*(c-(u-1)*t)/2),0<=["edge","ie11","ie10"].indexOf(ASC.browser)){var w=x(a);a.attr("y",parseFloat(a.attr("y"))+e.y1-w.y+(e.height()-w.height)*(1+i)/2)}if(r.clip&&((w=x(a)).width>l||w.height>c)){var E="CP_"+A++,S=C("clipPath",this.page_document).appendTo(this.$page).attr("id",E);C("rect",this.page_document).appendTo(S).attr({x:e.x1,y:e.y1,width:l,height:c}),a.attr("clip-path","url(#"+E+")")}return this.rtl&&(w=x(a),a.attr({transform:"scale(-1 1) translate("+(-2*w.x-w.width)+")"})),a},i.prototype.Image=function(t,e,n,s){void 0===n&&(n=0),void 0===s&&(s=0);var i=C("image",this.page_document),r=document.createAttributeNS("http://www.w3.org/1999/xlink","href");r.nodeValue=e,i[0].attributes.setNamedItemNS(r),i.appendTo(this.$page).attr({x:t.x1,y:t.y1});var a=t.width(),o=t.height();if(n||s){var l=x(i),c=function(){var e=Math.min(a/l.width,o/l.height);a=l.width*e,o=l.height*e,0==n?i.attr("width",t.width()):0<n&&i.attr({x:t.x2-a,width:a}),0==s?i.attr("height",t.height()):0<n&&i.attr({y:t.y2-o,width:o})};l.width?c():i.load(function(){l=x(i),c()})}else i.attr({width:a,height:o});if(this.rtl){var u=x(i);i.attr({transform:"scale(-1 1) translate("+(-2*u.x-u.width)+")"})}return i},i.prototype.Tootlip=function(e,t){C("title",this.page_document).text(t).prependTo(e)},i.prototype.ShadowFilter=function(e,t,n){void 0===e&&(e=3),void 0===t&&(t=2),void 0===n&&(n=2);var s="filter_"+A++;return this.SvgEl("filter",this.$defs).attr({id:s}).html('<feGaussianBlur in="SourceAlpha" stdDeviation="'+e+'"/><feOffset dx="'+t+'" dy="'+n+'" result="offsetblur"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>'),"url(#"+s+")"},i.drawToDiv=function(e){e.empty();var t=e.width(),n=e.height(),s=new i($j("<svg style=''>").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("width",t).attr("height",n).attr("stroke","#000000").attr("stroke-width","0").attr("fill","#000000").appendTo(e));return s.width=t,s.height=n,s},i);function i(e){this.$page=e,this.extraScale=1,this.width=0,this.height=0,this.rtl=!1,this.$defs=null,this.page_document=e[0].ownerDocument,this.$defs=C("defs",this.page_document).appendTo(this.$page)}e.SvgDC=n;var r=(a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.prototype.add=function(e){return new a(this.x+e.x,this.y+e.y)},a.prototype.sub=function(e){return new a(this.x-e.x,this.y-e.y)},a.prototype.mul=function(e){return new a(this.x*e,this.y*e)},a.prototype.normalized=function(){return this.mul(1/this.length())},a.prototype.rotate=function(e){var t=Math.cos(e),n=Math.sin(e);return new a(this.x*t-this.y*n,this.y*t+this.x*n)},a.prototype.midPointTo=function(e,t){void 0===t&&(t=.5);var n=1-t;return new a(this.x*n+e.x*t,this.y*n+e.y*t)},a.prototype.svgStr=function(){return this.x+" "+this.y},a);function a(e,t){this.x=e,this.y=t}e.CPoint=r;var o=(l.prototype.swap=function(e){return void 0===e&&(e=!0),l.swap(e,this.x1,this.y1,this.x2,this.y2)},l.swap=function(e,t,n,s,i){return e?new l(n,t,i,s):new l(t,n,s,i)},l.prototype.width=function(){return this.x2-this.x1},l.prototype.height=function(){return this.y2-this.y1},l.prototype.center=function(){return new r((this.x1+this.x2)/2,(this.y1+this.y2)/2)},l.prototype.move=function(e,t){return new l(this.x1+e,this.y1+t,this.x2+e,this.y2+t)},l.prototype.pad_rel=function(e,t){return void 0===t&&(t=e),this.pad_abs(this.width()*e,this.height()*t)},l.prototype.pad_abs=function(e,t){return void 0===t&&(t=e),new l(this.x1+e,this.y1+t,this.x2-e,this.y2-t)},l.prototype.sliceY=function(e,t){var n=this.height();return new l(this.x1,this.y1+e*n/t,this.x2,this.y1+(e+1)*n/t)},l.prototype.contains=function(e){return e.x>=this.x1&&e.x<=this.x2&&e.y>=this.y1&&e.y<=this.y2},l);function l(e,t,n,s){this.x1=e,this.y1=t,this.x2=n,this.y2=s}function p(e){return d.createElement("line",{x1:e.p1.x,y1:e.p1.y,x2:e.p2.x,y2:e.p2.y,stroke:e.stroke})}function b(e){var t=e.p1,n=e.p2,s=n.sub(t).rotate(Math.PI/2).mul(.1),i=t.midPointTo(n,.2).add(s),r=t.midPointTo(n,.8).add(s);return d.createElement("path",{d:"M"+t.svgStr()+" C "+i.svgStr()+","+r.svgStr()+","+n.svgStr(),fill:"none"})}e.CRect=o,e.RSvgLine=p,e.RSvgCircle=function(e){var t=e.center,n=e.radius;return d.createElement("circle",s.__assign({cx:t.x,cy:t.y,r:n},{stroke:e.stroke,strokeWidth:e.strokeWidth,fill:e.fill}))},e.RSvgCurvedLine=b,e.RSvgArrow=function(e){var t=e.p1,n=e.p2,s=e.head_size,i=e.typ||"forward",r=Math.PI/6,a=p,o=r,l=-r,c=0;a=b,c=-.4;var u=n.sub(t).normalized().mul(s);return d.createElement(m.Fragment,null,d.createElement(a,{p1:t,p2:n}),("forward"==i||"bidi"==i)&&d.createElement(m.Fragment,null,d.createElement(a,{p1:n.sub(u.rotate(o+c)),p2:n}),d.createElement(a,{p1:n,p2:n.sub(u.rotate(l+c))})),("back"==i||"bidi"==i)&&d.createElement(m.Fragment,null,d.createElement(a,{p1:t.add(u.rotate(o-c)),p2:t}),d.createElement(a,{p1:t,p2:t.add(u.rotate(l-c))})))}}),ASC.setModuleSourceFunc("/substitution/online/leftpanel.js",function(e,require,t){e.__esModule=!0;var N=require("tslib"),O=require("react"),B=require("../../rpr/dbi"),j=require("../../asc/asc_react"),M=require("../../dashboard/dbi_events"),U=require("../subst"),z=require("../../asc/actions"),P=require("../server/commands");function d(e,t){return t.name||e.rowName("event_types",t.typ)}function F(E){for(var S=this,C=E.dbi,x=E.getDate(),A=C.req,T={eventInfo:new Map,eventTypeInfo:new Map,absentInfo:new Map},e=E.getEvents(),I=E.getAbsents(),k=U.buildSubstOnlineTTItemsEx(C,x,!1),D=U.buildSubstOnlineTTItemsEx(C,x,!0),t=0,n=I;t<n.length;t++){var s=n[t];T.absentInfo.set(s.id,{eventids:new Set})}for(var R=[],i=function(e){var t={state:"",menu:[]};if("changeroom"==e.typ){for(var n=e.teacherids[0],s=e.classroomids[0],i=e.classroomids[1],r=null,a=null,o=0,l=1<e.durationperiods?D:k;o<l.length;o++){var c=l[o];c.uniperiod==B.DBITools.getUniPeriod(e)&&c.teacherids.includes(n)&&("period"==B.DBITools.typeOfUniPeriod(c.uniperiod)&&(c.durationperiods||1)!=e.durationperiods||(0<=c.classroomids.indexOf(s)&&(r=c),0<=c.classroomids.indexOf(i)&&(a=c)))}if(r){if(0==r.substids.length&&1==r.classroomids.length){var u=function(){return N.__awaiter(S,void 0,void 0,function(){return N.__generator(this,function(e){switch(e.label){case 0:return[4,P.updateSubstTTItem(null,r.id,{classroomids:[i]},{substitution_typeid:U.getDefault_substitution_typeid(C,"changeroom")},1<r.durationperiods)];case 1:return e.sent(),[2]}})})};t.menu.push({text:ASC.ls(1257)+" -> "+A.ls(1003),icon:z.action_icon("add"),onclick:function(){return N.__awaiter(S,void 0,void 0,function(){var t;return N.__generator(this,function(e){switch(e.label){case 0:return"short",t=C.tools.ttitem_popis(r,"short"),[4,j.RDialog.showConfirm(O.createElement("div",null,A.ttls(3794)+"?",O.createElement("br",null),O.createElement("br",null),t.period+" "+t.subject+" "+t.class,O.createElement("br",null),O.createElement("br",null),t.classroom," -> ",C.rowName("classrooms",i,"short")),{srcFunction:F})];case 1:return e.sent()?[4,u()]:[3,3];case 2:e.sent(),E.refresh(),e.label=3;case 3:return[2]}})})}}),R.push(u)}}else a&&(t.state="handled")}else if("bookroom"==e.typ);else{var d={teachers:[],classes:[],classrooms:[]},m=!1;for(var p in d)for(var b=0,h=M.event_tableIds(e,p,{dbi:C,date:x,expand_ctevent:!0});b<h.length;b++){var f=h[b],g=m=!0;if(e.period)for(var _=parseInt(e.period),v=_+(e.durationperiods||1)-1,y=_;y<=v;y++){var w;(w=U.findAbsent(I,p,f,{groupnames:e.groupnames,period:""+y}))?T.absentInfo.get(w.id).eventids.add(e.id):g=!1}else(w=U.findAbsent(I,p,f,{groupnames:e.groupnames,starttime:e.starttime,endtime:e.endtime,daypart:e.daypart}))?T.absentInfo.get(w.id).eventids.add(e.id):g=!1;g||d[p].push(f)}0==d.classes.length&&0==d.teachers.length&&0==d.classrooms.length?t.state=m?"handled":"":(t.state="",t.menu.push({text:ASC.ls(1257)+" -> "+ASC.ls(1622),icon:z.action_icon("add"),onclick:function(){return E.showAbsentEditDlg("",{classids:d.classes,teacherids:d.teachers,classroomids:d.classrooms,period:e.period,durationperiods:e.durationperiods,groupname:e.groupnames[0]})}}))}T.eventInfo.set(e.id,t)},r=0,a=e;r<a.length;r++){i(a[r])}if(1<R.length){var o=A.ls(1257)+" -> "+A.ls(1003)+" ("+R.length+")";T.eventTypeInfo.set("changeroom",{menu:[{text:o,icon:z.action_icon("add"),onclick:function(){return N.__awaiter(S,void 0,void 0,function(){var t,n,s;return N.__generator(this,function(e){switch(e.label){case 0:return[4,j.RDialog.showConfirm(O.createElement(O.Fragment,null,o,O.createElement(j.VGap,{height:10}),A.ls(1054)))];case 1:if(!e.sent())return[3,6];t=0,n=R,e.label=2;case 2:return t<n.length?(s=n[t],[4,ASC.blockUI(s())]):[3,5];case 3:e.sent(),e.label=4;case 4:return t++,[3,2];case 5:E.refresh(),e.label=6;case 6:return[2]}})})}}]})}return T}function m(e){var t=e.online,n=e.event,s=e.eventInfo,i=t.dbi,r=i.tools.ttitem_popis(n).period,a=d(i,n),o=[];return 0<n.classids.length&&(a=i.rowNames("classes",n.classids,"short")+": "+a,B.DBITools.groupnamesIsEntireClass(n.groupnames)||o.push(i.tools.groupnames_names(n.groupnames))),n.subjectid&&o.push(i.rowName("subjects",n.subjectid,"short")),0<n.teacherids.length&&o.push(i.rowNames("teachers",n.teacherids,"short")),0<n.classroomids.length&&o.push(i.rowNames("classrooms",n.classroomids,"short")),O.createElement(b,N.__assign({},{key:n.subId,state:s.state,icon:"/global/pics/ui/events_32.png",name:a,when:r,reason:o.join("; "),menuCallback:function(){var e=[];return 0<s.menu.length&&(e=N.__spreadArrays(s.menu,[[]])),e.push({text:ASC.ls(1053),icon:z.action_icon("edit"),onclick:function(){return t.showEventEditDlg(n.id)}}),e.push([]),e.push({text:ASC.ls(1844),icon:i.table("events").icon(),onclick:function(){return t.showEventsDlg()}}),e}}))}e.eventName=d;var n,r=(n=O.Component,N.__extends(s,n),s.prototype.render=function(){var s=this,e=this.props,i=e.online,r=e.eventsInfo,t=this.state.collapsed,n=i.dbi.tableFilterData("events",{date:i.getDate()});if(0==n.length)return null;for(var a={},o=0,l=n;o<l.length;o++){var c=l[o],u=c.typ;a[u]||(a[u]=[]),a[u].push(c)}var d=i.dbi.tableData("event_types").map(function(e){var t=a[e.id];if(!t)return null;var n=r.eventTypeInfo.get(e.id);return O.createElement(p,{key:e.id,title:e.name,collapsedRef:j.stateRef(s,"collapsed_"+e.id),count:t.length,level:1,menu:n?n.menu:void 0},t.map(function(e){return O.createElement(m,{key:e.subId,online:i,event:e,eventInfo:r.eventInfo.get(e.id)})}))});return O.createElement(O.Fragment,null,O.createElement(p,{title:ASC.ls(1844),collapsedRef:j.stateRef(this,"collapsed"),count:n.length}),O.createElement(j.AnimatedCollapseDiv,{collapsed:t},d))},s);function s(e){var t=n.call(this,e)||this;return t.state={collapsed:!1},t}function a(t){var e="",n="/timetable/pics/app/office/patient_ok_128.png";return t.uploaded?e=ASC.ttls(1995):t.holiday?(e=ASC.ls(1245),n="/timetable/pics/app/office/rest_area_128.png"):e=t.isAbsent?ASC.ttls(1447):ASC.ttls(3815)+"\n"+ASC.ASC_date2str(t.date,!1)+"\n"+ASC.ttls(3816),O.createElement("div",{className:"add isAbsent",onClick:function(e){t.uploaded?t.online.checkUploaded(t.date):t.online.showAbsentEditDlg("")}},O.createElement("div",{className:"img",style:{backgroundImage:"url("+n+")"}}),e)}function p(t){var e=t.children||[],n=t.collapsedRef.read(),s=t.count;return void 0===s&&(s=e.length),O.createElement(O.Fragment,null,O.createElement("div",{className:t.level?"subheader":"header",style:{cursor:"pointer",userSelect:"none",display:"flex",flexDirection:"row"},onClick:function(){return t.collapsedRef.write(!n)}},O.createElement("span",{style:{flex:1}},t.title+(n?" ("+s+")":":")),t.menu&&O.createElement("span",{style:{padding:"1px 4px"},onClick:function(e){return ASC.showContextMenu(t.menu,e,e.currentTarget)}},O.createElement("i",{className:"fa fa-caret-down"}))),O.createElement(j.AnimatedCollapseDiv,{collapsed:n},e))}function b(n){function e(e){var t=n.menuCallback();ASC.showContextMenu(t,e,e.currentTarget),e.preventDefault()}var t=["item"],s="";switch(n.state){case"handled":t.push("handled"),s="/global/pics/ui/item_ok_32.png";break;case"event":s="/global/pics/ui/events_32.png";break;case"error":s="/global/pics/ui/item_bad_32.png"}return O.createElement("div",{className:t.join(" "),onClick:e,onContextMenu:e,style:{backgroundColor:n.color,position:"relative"}},O.createElement("img",{src:n.icon}),O.createElement("div",{className:"when"},n.when),O.createElement("div",{className:"name"},n.name),O.createElement("div",{className:"reason"},n.reason),!!s&&O.createElement("img",{src:s,style:{position:"absolute",left:21,top:23,height:16,filter:"drop-shadow(1px 1px 2px rgba(0,0,0,0.5))"}}))}function o(e){var n=this,s=e.absent,i=e.online,r=i.naming_dbi,a=e.absentInfo,o=U.absentGetTable(s),l=U.absentGetId(s),t=r.rowName(o,l);"groups"==s.table&&(t+=" ("+r.tools.groupnames_names([s.groupname])+")");var c="";s.longtime_datefrom&&(c=ASC.ASC_date2str(s.longtime_datefrom,!1)+"-"+ASC.ASC_date2str(s.longtime_dateto,!1)+" "),void 0!==s.period&&(c+=r.tools.ttitem_popis(s).period);var u=r.rowName("absent_types",s.absent_typeid);return O.createElement(b,{key:s.subId,icon:"/global/pics/ui/"+B.DBITools.removeEs(o)+"_32.png",state:0<a.eventids.size?"event":"",name:t,when:c,reason:u,menuCallback:function(){var t=N.__spreadArrays([N.__assign(N.__assign({},z.action_menu("edit")),{onclick:function(){return i.showAbsentEditDlg(s.id)}}),[],N.__assign(N.__assign({},z.action_menu("delete")),{onclick:function(){return i.showAbsentDeleteDlg(s.id)}}),[]],i.timetableMenu(o,l));return"teachers"==s.table&&(t.push([]),t.push(N.__assign(N.__assign({},z.action_menu("lessons")),{onclick:function(){return N.__awaiter(n,void 0,void 0,function(){return N.__generator(this,function(e){return[2,i.showAbsentLessons(s)]})})}}))),0<a.eventids.size&&(t.push([]),t.push({text:ASC.ls(1844)+":",disabled:!0}),a.eventids.forEach(function(e){t.push({text:d(r,r.rowData(M.TABLE_events,e)),icon:"/global/pics/ui/events_32.png",onclick:function(){return i.showEventEditDlg(e)}})})),t}})}e.LeftPanel=function(e){var t=e.online,n=F(t),s=t.getDateRow(),i=t.getAbsents();return O.createElement("div",{style:{width:"200px",display:"flex",flexDirection:"column"},className:"absent_d"},O.createElement(a,{online:e.online,uploaded:!!s.uploaded_int,holiday:s.is_holiday,isAbsent:0<i.length,date:t.getDate()}),O.createElement("div",{className:"list",style:{overflow:"auto",flex:"1 100px"}},O.createElement(l,{online:e.online,table:"teachers",title:ASC.ttls(3817),eventsInfo:n}),O.createElement(l,{online:e.online,table:"classes",title:ASC.ttls(3779),eventsInfo:n}),O.createElement(l,{online:e.online,table:"classrooms",title:ASC.ttls(3780),eventsInfo:n}),O.createElement(r,{online:e.online,eventsInfo:n})))};var i,l=(i=O.Component,N.__extends(c,i),c.prototype.render=function(){var t=this.props,e=t.online,n=t.online.getAbsents().filter(function(e){return U.absentGetTable(e)==t.table}),s=new Map;function i(e){return s.get(U.absentGetId(e))||1e3}return e.dbi.tableData(t.table).forEach(function(e,t){return s.set(e.id,t+1)}),n.sort(function(e,t){return i(e)-i(t)}),0==n.length?null:O.createElement(p,{title:t.title,collapsedRef:j.stateRef(this,"collapsed")},n.map(function(e){return O.createElement(o,{key:e.subId,online:t.online,absent:e,absentInfo:t.eventsInfo.absentInfo.get(e.id)})}))},c);function c(e){var t=i.call(this,e)||this;return t.state={collapsed:!1},t}}),ASC.setModuleSourceFunc("/timetable/ttitem.js",function(e,require,t){e.__esModule=!0;var v=require("tslib"),y=require("../rpr/dbi");var n=(s.prototype.setDate=function(e,t){var n=e&&null!=e.tt_day?""+e.tt_day:"";n==this.day&&t==this.tt_dbi||(this.day=n,this.tt_dbi=t,this.initDate())},s.prototype.setDateAsync=function(i){return v.__awaiter(this,void 0,void 0,function(){var t,n,s;return v.__generator(this,function(e){switch(e.label){case 0:return i==this.date?[3,4]:(this.date=i,t=this.dbi.rowData("dates",i),this.day=null!=t.tt_day?""+t.tt_day:"",n=this,t.tt_num?[4,this.dbi.timetabledbi(t.tt_num)]:[3,2]);case 1:return s=e.sent(),[3,3];case 2:s=null,e.label=3;case 3:n.tt_dbi=s,this.initDate(),e.label=4;case 4:return[2]}})})},s.prototype.ensure_up=function(e){var t=this.up_data,n=t.get(e);return n||(n={starttime:"",endtime:"",cbs:[]},t.set(e,n)),n},s.prototype.initDate=function(){var e=this.up_data,t=this.dbi,n=this.tt_dbi;e.clear();for(var s=0,i=t.tableData("periods");s<i.length;s++){var r=(d=i[s]).id;(m=this.ensure_up(r)).starttime=d.starttime,m.endtime=d.endtime}for(var a=0,o=t.tableData("dayparts");a<o.length;a++){var l=o[a];r=l.id,(m=this.ensure_up(r)).starttime=l.starttime,m.endtime=l.endtime}if(n){for(var c=0,u=n.tableData("periods");c<u.length;c++){r=(d=u[c]).id;var d,m=this.ensure_up(r);d.starttime&&(m.starttime=d.starttime,m.endtime=d.endtime)}for(var p=0,b=n.tableData("breaks");p<b.length;p++){var h=b[p];r="b"+h.id,m=this.ensure_up(r),h.starttime&&(m.starttime=h.starttime,m.endtime=h.endtime)}for(var f=0,g=n.tableData("custombells");f<g.length;f++){var _=g[f];r=_.period,_.break&&(r="b"+_.break),(m=e.get(r))&&m.cbs.push(_)}}},s.prototype.provide=function(e){var t=this.up_data,n=this.day,s=e.uniperiod;if("ad"==s)return{starttime:"00:00",endtime:"24:00"};function i(e){return{starttime:e.starttime,endtime:e.endtime}}if(e.durationperiods&&1<e.durationperiods&&"period"==y.DBITools.typeOfUniPeriod(s)){var r=v.__assign(v.__assign({},e),{durationperiods:null}),a=this.provide(r);r.uniperiod=""+(parseInt(e.uniperiod)+e.durationperiods-1);var o=this.provide(r);return{starttime:a.starttime,endtime:o.endtime}}if(f=t.get(s)){if(0<f.cbs.length){for(var l=e.lessonid,c=0<=e.classids.length?e.classids[0]:"",u=null,d=-1,m=0,p=f.cbs;m<p.length;m++){var b=p[m],h=0;if(b.day){if(b.day!=n)continue;h+=1}if(l&&0<=b.lessonids.indexOf(l))h+=100;else if(0<b.classids.length){if(!c)continue;if(b.classids.indexOf(c)<0)continue;h+=10}d<h&&(u=b,d=h)}if(u)return i(u)}return i(f)}if(5==s.length&&"-"==s[2])return{starttime:s.substr(0,2)+":"+s.substr(3,2),endtime:e.endtime||""};var f=this.ensure_up(s);if("b"==s[0]){var g=t.get(""+(parseInt(s.substr(1))-1)),_=t.get(s.substr(1));_&&(f.endtime=_.starttime,f.starttime=g?g.endtime:function(e){if(e<0)return"";var t=e%60,n=(e-t)/60;return(n<10?"0":"")+n+":"+(t<10?"0":"")+t}(function(e){return e?60*parseInt(e.substr(0,2))+parseInt(e.substr(3,2)):-1}(f.endtime)-5))}return i(f)},s.prototype.fill=function(e,t){var n=this.provide(t);e.starttime=n.starttime,e.endtime=n.endtime},s.ttitem_needed_columns=["subjectid","classids","teacherids","groupnames","igroupid","studentids","groupsubjectids"],s.needed_part={periods:["period","starttime","endtime"],dayparts:["daypart","starttime","endtime"],dates:["tt_day","tt_num"]},s);function s(e){this.dbi=e,this.date="",this.tt_dbi=null,this.day="",this.up_data=new Map}e.TTItemTimeProvider=n,e.ttitemFromData=function(e){for(var t={uniperiod:e.uniperiod||y.DBITools.getUniPeriod(e),subjectid:e.subjectid||"",classids:e.classids||[],groupnames:e.groupnames||[],teacherids:e.teacherids||[]},n=0,s=["date","classroomids","groupsubjectids","starttime","endtime","durationperiods","studentids","igroupid","eventid"];n<s.length;n++){var i=s[n];void 0!==e[i]&&(t[i]=e[i])}return t},e.ttitemTableIds=function(e,t){switch(t){case"classes":return e.classids;case"teachers":return e.teacherids;case"classrooms":return e.classroomids;case"igroups":return e.igroupid?[e.igroupid]:[];case"subjects":return e.subjectid?[e.subjectid]:[]}return[]},e.ttitemFilterMatch=function(e,t,n){if(!n)return!1;switch(t){case"classes":return 0<=e.classids.indexOf(n);case"teachers":return 0<=e.teacherids.indexOf(n);case"classrooms":return 0<=e.classroomids.indexOf(n);case"igroups":return e.igroupid==n;case"subjects":return e.subjectid==n;case"students":return e.studentids&&0<=e.studentids.indexOf(n)}return!1},e.ttitemUniperiodMatchSimple=function(e,t){if(!t)return!1;if(t==e.uniperiod)return!0;if("ad"==e.uniperiod)return!0;if("ad"==t)return!0;if("period"!=y.DBITools.typeOfUniPeriod(t)||"period"!=y.DBITools.typeOfUniPeriod(e.uniperiod))return!1;var n=parseInt(t),s=parseInt(e.uniperiod),i=s+(e.durationperiods||1)-1;return s<=n&&n<=i},e.ttitemUniperiods=function(e){var t=e.uniperiod,n=e.durationperiods;if("period"==y.DBITools.typeOfUniPeriod(t)&&1<e.durationperiods){for(var s=parseInt(t),i=s+n-1,r=[],a=s;a<=i;a++)r.push(""+a);return r}return[t]}}),ASC.setModuleSourceFunc("/substitution/online/combo.js",function(e,require,t){e.__esModule=!0;var He=require("tslib"),Ve=require("../../rpr/dbi"),We=require("./timetable"),Ke=require("../../timetable/timeoff_r"),Ye=require("./settings"),n=require("../subst"),$e=require("../../asc/lib_date");function s(e){var t,n=e.table,s=e.ttitem,i=e.dbi,r=e.tt_dbi,a=e.remove_ttitemids,o=s.date,l=$e.date_month(o),c=[],u="?",d=s;if(s.cancelled&&(d=He.__assign(He.__assign(He.__assign({},s),{cancelled:!1}),s.orig)),"teachers"==n){for(var m=0,p=i.tableData(n);m<p.length;m++){var b=p[m];c.push({id:b.id,debug_name:i.rowName(n,b.id),cb_hidden:b.cb_hidden,subst_hidden:b.subst_hidden})}u="teacherids"}if("classrooms"==n){for(var h=0,f=i.tableData(n);h<f.length;h++){var g=f[h];c.push({id:g.id,cb_hidden:g.cb_hidden})}u="classroomids"}for(var _=function(e){var t=i.rowData("subjects",e);return!t||!t.subst_join_forbidden},v=0,y=c;v<y.length;v++){var w=y[v],E=We.getSubstTTItemKolizie(i,r,He.__assign(He.__assign({},d),((t={})[u]=[w.id],t)),a);if(w.fb=We.jeSubstKolizaAbsent(E,n,w.id),We.jeSubstKoliziaRow(E,n,w.id)){var S=!1;if("teachers"==n&&_(s.subjectid))for(var C=0,x=E;C<x.length;C++){var A=x[C];if(A.table==n&&A.id==w.id){if(!A.join||!_(A.subjectid)){S=!1;break}S=!0}}S?w.fj=!0:w.fo=!0}}if(c=c.filter(function(e){return!e.fb}),"teachers"==n){var T=new Set;if(r)for(var I=0,k=r.tableData("lessons");I<k.length;I++){var D=k[I];if(Ve.idsIsOverlap(D.classids,d.classids))for(var R=0,N=D.teacherids;R<N.length;R++){var O=N[R];T.add(O)}}for(var B=0,j=c;B<j.length;B++){w=j[B];T.has(w.id)&&(w.fu=!0)}for(var M=new Set,U=(Ne=i.rowData("classes",d.classids[0]))&&Ne.grade||"",z=0,P=i.tableData("approbations");z<P.length;z++){var F=P[z];if(!(F.subjectids.indexOf(d.subjectid)<0)){if(U){if(F.gradefrom&&parseInt(F.gradefrom)>parseInt(U))continue;if(F.gradeto&&parseInt(F.gradeto)<parseInt(U))continue}M.add(F.id)}}for(var L=0,G=c;L<G.length;L++){w=G[L];for(var q=0,H=i.rowData("teachers",w.id).approbationids;q<H.length;q++){var V=H[q];M.has(V)&&(w.fp=!0)}}for(var W=0,K=d.classids;W<K.length;W++){var Y=K[W],$=i.rowData("classes",Y);if($)for(var Z=0,J=c;Z<J.length;Z++){(w=J[Z]).id!=$.teacherid&&w.id!=$.teacher2id||(w.ft=!0)}}for(var X=0,Q=c;X<Q.length;X++){w=Q[X];(b=i.rowData("teachers",w.id))&&b.dateto&&b.dateto<s.date&&(w.out=!0)}if("period"==Ve.DBITools.typeOfUniPeriod(s.uniperiod)){var ee=parseInt(s.uniperiod),te=i.rowData("substonline_dates",s.date),ne=te.tt_num;if(ne)for(var se=0,ie=c;se<ie.length;se++){w=ie[se];if(b=i.rowData("teachers",w.id)){var re=(b.subst_tt_timeoff||b.subst_tt_timeoff_vt)[ne];if(re){var ae=Ke.timeOff_get(re,te.tt_term,te.tt_week,te.tt_day,ee);"0"==ae&&(w.fx=!0),"D"==ae&&(w.fd=!0)}}}}if("period"==Ve.DBITools.typeOfUniPeriod(s.uniperiod)){for(var oe=parseInt(s.uniperiod),le=oe+(s.durationperiods||1)-1,ce=i.tableFilterData("substonline_ttitems",{date:s.date}).filter(function(e){return a.indexOf(e.id)<0}),ue=new Set,de=0,me=ce;de<me.length;de++)for(var pe=me[de],be=0,he=pe.teacherids;be<he.length;be++){O=he[be];ue.add(O+":"+pe.uniperiod)}for(var fe=i.tableIds("periods"),ge=0,_e=c;ge<_e.length;ge++){if(!(w=_e[ge]).fj&&!w.fo){O=w.id;for(var ve=null,ye=null,we=0,Ee=fe;we<Ee.length;we++){var Se=Ee[we];if(ue.has(O+":"+Se))(ee=parseInt(Se))<oe&&(ve=ee),le<ee&&null===ye&&(ye=ee)}var Ce=0;(Ce=null==ve?null==ye?-5:-(ye-le-1):null==ye?-(oe-ve-1):1)&&(w.fa=Ce)}}}for(var xe=0,Ae=c;xe<Ae.length;xe++){w=Ae[xe];var Te=i.rowData("substonline_teacher_month",l+":"+w.id);if(Te){var Ie=void 0;"classroomsupervision"==s.type?Ie=Te.sv_substing:null==(Ie=Te.de_plusminus)&&(Ie=Te.substing-Te.absent),Ie&&(w.fq=-Ie)}}}if("classrooms"==n){for(var ke=new Set,De=0,Re=d.classids;De<Re.length;De++){var Ne;Y=Re[De];(Ne=i.rowData("classes",Y))&&ke.add(Ne.classroomid)}if(d.igroupid){var Oe=i.rowData("igroups",d.igroupid);Oe&&ke.add(Oe.classroomid)}for(var Be=0,je=c;Be<je.length;Be++){w=je[Be];ke.has(w.id)&&(w.frh=!0)}}var Me=i.rowData("global_settings","1"),Ue=Ye.default_subst_online_criteria;Me&&Me.subst_online_criteria&&(Ue=Me.subst_online_criteria);for(var ze=0,Pe=c;ze<Pe.length;ze++){w=Pe[ze];var Fe=0;e.topid&&w.id==e.topid&&(Fe+=1e6),w.cb_hidden&&(Fe-=1e5),w.subst_hidden&&(Fe-=1e5),w.out&&(Fe-=1e5),w.fo&&(Fe+=-5e4),w.fa&&(Fe+=Ue.assign*w.fa),w.fu&&(Fe+=Ue.teachesclass),w.fp&&(Fe+=Ue.approbation),w.fj&&(Fe+=Ue.join),w.fx&&(Fe+=-5e4),w.fd&&(Fe+=Ue.duty),w.ft&&(Fe+=Ue.classteacher),w.fq&&(Fe+=Ue.equable*w.fq),w.priorita=Fe}c.sort(function(e,t){return t.priorita-e.priorita});for(var Le=0,Ge=c;Le<Ge.length;Le++){var qe=[];(w=Ge[Le]).fo&&qe.push("subst-obsadeny"),(w.cb_hidden||w.subst_hidden)&&qe.push("cb_hidden"),w.className=qe.join(" ")}return c}e.substComboTables=["teachers","classrooms"],(e.substTTItemComboItems=s).npp=n.substOnlineNeededPartProvider(function(){return[{global_settings:["subst_online_criteria"],substonline_dates:["tt_num","tt_day","tt_week","tt_term"],classrooms:["cb_hidden"],teachers:["approbationids","cb_hidden","subst_hidden","subst_tt_timeoff"],classes:["teacherid","teacher2id"],substonline_teacher_month:["de_plusminus","substing","absent","sv_substing"]}]}),s.ttdbi={npp:Ve.neededPartProvider(function(){return[We.getSubstTTItemKolizie.ttdbi,{lessons:["classids","teacherids"]}]})}}),ASC.setModuleSourceFunc("/substitution/online/settings.js",function(u,require,e){u.__esModule=!0;var d=require("tslib"),m=require("../../asc/asc_react"),p=require("react"),b=require("../../asc/edurequest"),h=require("../../rpr/itemdlg"),f=require("../../asc/asc_react2"),g=p.lazy(function(){return Promise.resolve().then(function(){return require("../../react/slider")})});u.default_subst_online_criteria={assign:10,teachesclass:3,classteacher:10,approbation:70,join:100,duty:1e4,equable:1};var o=[[0,1],[50,10],[300,100],[5e3,1e3]];function _(e){return m.castRef(e,function(e){for(var t=0,n=o.length-1;0<=n;n--){var s=o[n];s[0]>e||(t+=(e-s[0])/s[1],e=s[0])}return t},function(e){for(var t=0,n=1,s=0,i=o;s<i.length;s++){var r=i[s],a=(r[0]-t)/n;if(e<a)break;e-=a,t=r[0],n=r[1]}return t+e*n})}var v=_(m.makeSimpleValueRef(function(){return 5e4},function(){})).read();function t(){var n=b.client_req;m.useTTLang();var e=n.getSchoolYear(),t=h.useMainDBIItemDlgState(e,"global_settings","1",{needed_part:{global_settings:["subst_online_criteria"]},blank:{subst_online_criteria:u.default_subst_online_criteria},trackEvent:function(e){return barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstSettingsCriteriaDlg."+e,eventLabel:""})}}),s=t.dbi,i=t.rowRef,r=t.rdlgProps,a=m.subRef(i,"subst_online_criteria"),o=a.read(),l=s.column("global_settings","subst_online_criteria"),c=l.subcolumns||[];return p.createElement(m.RDialog,d.__assign({},r,{header:n.ls(1003),width:620,footer:p.createElement(p.Fragment,null,p.createElement(m.RButton,{label:n.ttls(1540),onClick:function(){var e={margin:20,marginTop:10};m.RDialog.showConfirm(p.createElement("div",null,p.createElement(m.VGap,{height:15}),p.createElement("div",null,["classteacher","teachesclass","approbation","join","duty"].map(function(e){return l.subcolumn(e).name()}).join(", ")),p.createElement("div",{style:e},n.ttls(1564),p.createElement(m.VGap,{height:10}),n.ttls(2191)),p.createElement("div",null,l.subcolumn("assign").name()),p.createElement("div",{style:e},n.ttls(1567)),p.createElement("div",{style:e},n.ttls(2192)),p.createElement("div",null,l.subcolumn("equable").name()),p.createElement("div",{style:e},n.ttls(1569))),{width:520,buttons:["close"],header:n.ttls(1540)})}}),p.createElement(m.RButton,{label:n.ttls(1539),onClick:function(){return i.update(function(e){return d.__assign(d.__assign({},e),{subst_online_criteria:d.__assign(d.__assign({},e.subst_online_criteria),u.default_subst_online_criteria)})})}}))}),p.createElement("div",{style:{minHeight:350}},p.createElement(f.DlgHeader,{icon:"/timetable/pics/app/office/settings_basic_32.png",title:n.localize("{6737}"),small:!0}),p.createElement(p.Suspense,{fallback:p.createElement(m.Loading,null)},p.createElement(m.RLabel,{text:n.ttls(1530)}),p.createElement("i",{className:"fa fa-arrow-down"}),p.createElement(m.HGap,{width:298}),p.createElement("i",{className:"fa fa-arrow-up"}),p.createElement(m.VGap,{height:10}),c.map(function(e){var t=m.subRef(a,e.id);return p.createElement(p.Fragment,{key:e.id},p.createElement(m.RLabel,{text:e.name()}),p.createElement(g,{valueRef:_(t),min:0,max:v,style:{width:320}}),p.createElement("span",{style:{display:"inline-block",width:110,overflow:"hidden",textAlign:"center",verticalAlign:"middle",whiteSpace:"pre",textOverflow:"ellipsis"}},o[e.id]||n.ttls(2173)),p.createElement(m.VGap,{height:4}))}),p.createElement(m.VGap,{height:20}),p.createElement("div",null,n.ttls(2196)),p.createElement(m.VGap,{height:10}),p.createElement("div",null,n.ttls(2195)))))}u.showSubstSettingsCriteriaDlg=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){switch(e.label){case 0:return[4,m.RDialog.show(p.createElement(t,null))];case 1:return e.sent(),[2]}})})},u._hotswap=[t]}),ASC.setModuleSourceFunc("/rpr/itemdlg.js",function(e,require,t){e.__esModule=!0;var E=require("tslib"),S=require("react"),C=require("./dbi"),x=require("../asc/asc_react"),A=require("./dbi_react"),T=require("../asc/actions"),I=require("../asc/asc_react2");function i(e,t,l,n,c){var s,i,r,a=this,u=A.useSubscribedDBI(e,t,{needed_part:c.needed_part,client_filter:c.client_filter||(s={},s[l]=[{id:n}],s),vt_filter:c.vt_filter,needed_combos:c.needed_combos}),o=u.req,d=c.trackEvent,m=u.table(l),p=S.useRef(null),b=x.useStateValueRef(c.blank||{}),h=!n;p.current||u.mock||(h?(r=i=m.blankRow(),c.blank_add&&(r=E.__assign(E.__assign({},r),c.blank_add)),c.onAddingRow&&(r=E.__assign(E.__assign({},r),c.onAddingRow({dbi:u})))):(r=i=u.rowData(l,n),c.onEditingRow&&c.onEditingRow({dbi:u,origrow:i})),i||ASC.dieError("3352738883",[l,n]),p.current=i,b.write(r),d&&d("open"));var f=p.current||c.blank||{},g=b.read(),_=S.useRef();S.useEffect(function(){c.onChange&&c.onChange({row:g})},[g,c.onChange]);var v=x.useWorkIndicator();S.useEffect(function(){if(h&&m.column("short")){var e=function(e,t,n){var s=n.name||"";switch(t){case"classes":case"classrooms":return s;case"teachers":var i=(n.firstname||"").substr(0,1),r=(n.firstname||"").substr(0,1);return e.sort_name_col.indexOf("F")<e.sort_name_col.indexOf("L")?i+r:r+i;case"subjects":for(var a="",o=0,l=s.split(" ");o<l.length;o++){var c=l[o];a+=c.substr(0,1)}return a;default:return s.substr(0,1)}}(o,l,g);e&&x.subRef(b,"short").write(e)}},[g.name,g.lastname,g.firstname]);var y=g.name||g.lastname&&(g.firstname+" "+g.lastname).trim()||"";function w(){return E.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a,o=this;return E.__generator(this,function(e){switch(e.label){case 0:return t=g,c.onValidate?[4,c.onValidate({dbi:u,origrow:f,row:t,adding:h})]:[3,2];case 1:if(!(n=e.sent()))return[2,null];"object"==typeof n&&(t=n),e.label=2;case 2:return s=C.DBITools.rowChanges2write(f,t),i="",s?(r=c.doWrite||function(e){var t=e.dbi,n=e.urow,s=e.adding;return E.__awaiter(o,void 0,void 0,function(){return E.__generator(this,function(e){switch(e.label){case 0:return s?[4,t.backend.addRow(l,n)]:[3,2];case 1:return[2,e.sent()];case 2:return[4,t.backend.updateRow(l,n)];case 3:return e.sent(),[2,""]}})})},[4,v(r({dbi:u,origrow:f,urow:s,adding:h}))]):[3,4];case 3:a=e.sent(),i=h?(t=E.__assign(E.__assign({},t),{id:a}),"add="+a):"ok",d&&d("save"),e.label=4;case 4:return c.onAfterOk?[4,c.onAfterOk({row:t})]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2,{cop:i}]}})})}return{id:n,dbi:u,origrow:f,loaded:!!p.current,adding:h,rowRef:b,row:g,dlgRow:{dbi:u,table:l,rowRef:b},doApply:w,rdlg:_.current,rdlgProps:{ref:_,header:m.itemName()+(h?" - "+T.action_name("add"):""),buttons:["ok","cancel"],width:400,onConfirm:function(n){return E.__awaiter(a,void 0,void 0,function(){var t;return E.__generator(this,function(e){switch(e.label){case 0:return[4,w()];case 1:return(t=e.sent())&&n.confirmClose(t.cop),[2]}})})}},header:S.createElement(I.DlgHeader,{icon:m.icon(),title:y||m.itemName(),subtitle:g.short||void 0,small:!0})}}e.useMainDBIItemDlgState=function(e,t,n,s){return i("maindbi",""+e,t,n,s)},e.useItemDlgState0=i}),ASC.setModuleSourceFunc("/timetable/ttview_components.js",function(j,require,e){j.__esModule=!0;var M=require("tslib"),U=require("react"),z=require("../asc/asc_react"),a=require("../asc/edurequest"),P=require("../rpr/dbi"),F=require("./app/ttdoc");function o(e){var t=e.box,n=e.text,s=e.swap,i=e.splitLineTop,r=e.bgIcon,a=e.icon,o=e.icon_tooltip,l=e.onClick;return U.createElement(U.Fragment,null,r&&U.createElement("img",{src:r,style:{position:"absolute",left:t.x1,top:t.y1,height:t.y2-t.y1,width:t.x2-t.x1,opacity:.3}}),U.createElement(z.RTextBox,M.__assign({},z.swapBox(t,s),{text:n,hAlign:"center",vAlign:"center",style:M.__assign({fontSize:18,textShadow:r?"0px 0px 2px #ffffff":void 0,cursor:l?"pointer":void 0},e.style||{}),onClick:l})),a&&U.createElement("img",{src:a,title:o,style:{position:"absolute",left:t.x2-16,top:t.y1+1,width:16}}),i&&U.createElement(z.RBox,M.__assign({},z.swapBox({x1:t.x2-.25*(t.x2-t.x1),x2:t.x2,y1:t.y1,y2:t.y1+1},s),{style:{backgroundColor:j.COLOR_lines}})))}function S(e){var s=e.tlr,t=e.dbi,i=e.rowHeight,r=e.swap,a="px solid #e0e0e0",n={x1:0,x2:s.pSize,y1:0,y2:i};return U.createElement(U.Fragment,null,U.createElement(z.RBox,M.__assign({},z.swapBox(n,r),{style:{borderTop:"1px solid "+j.COLOR_lines,borderLeft:"1px solid "+j.COLOR_lines}})),t.tableData("periods").map(function(e){var t=s.data2t(e),n={x1:s.t2p(t.t1),x2:s.t2p(t.t2)+1,y1:0,y2:i};return U.createElement(z.RBox,M.__assign({key:e.id},z.swapBox(n,r),{style:M.__assign({background:"none",pointerEvents:"none"},r?{borderTop:1+a,borderBottom:1+a}:{borderLeft:1+a,borderRight:1+a})}))}))}function L(e,t,n,s){var i=e.req;return"classes"==t&&1<n.length&&P.idsArrayMatchI(n,e.tableIds(t))?i.ls(3100):n.length<5?e.rowNames(t,n,s):n.length+" "+e.tools.itemName(t,n.length)}function C(e){var t=e.dbi,n=e.ttitem,s=e.table,i=e.tlr_part,r=e.colors,a=e.swapAxis,o=e.small,l=e.onClick,c=e.box,u="",d="";"top"!=i&&"bottom"!=i||(u="ellipsis",a&&(d="bottom"==i?"right":"left")),"supervisionside"!=i||a||(d="left",u="clip");var m=n.attached,p=[];if(m&&0<m.length)for(var b=Math.min(19,.4*(c.y2-c.y1)/m.length),h=0,f=n.attached;h<f.length;h++){var g=f[h];p.push(U.createElement(z.RTextBox,M.__assign({key:p.length},z.swapBox({x1:c.x1,x2:c.x2,y1:c.y1,y2:c.y1+b-1},a),{style:{background:"#ffff80",color:"#404040",borderRadius:3,fontSize:Math.min(1*(b-1),13),paddingLeft:3,cursor:l?"pointer":void 0},hAlign:"center",vAlign:"center",rotate:a?"left":void 0,text:U.createElement("span",{style:{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"}},g.name),onClick:l}))),c=M.__assign(M.__assign({},c),{y1:c.y1+b})}var _=d?c.x2-c.x1:c.y2-c.y1,v=.9*_,y=Math.min(o?14:18,v),w=Math.min(o?9:12,v/2),E=n.name||"",S="",C="",x="",A="",T="#000000",I="#d0d0d0",k=void 0,D=!1;if("absent"==n.type?(I=n.eventid?j.BACKGROUND_event_absent:j.BACKGROUND_absent,D=!0):"event"==n.type?(I=n.absentid?j.BACKGROUND_event_absent:j.BACKGROUND_event,D=!0):"classroomsupervision"==n.type?(k="inset 0px 0px 0px 1px #b0b0b0",E="classrooms"==s?t.rowNames("teachers",n.teacherids,"short"):t.rowNames("classrooms",n.classroomids,"short")):"subst_duty"==n.type&&(E=U.createElement("img",{src:"/substitution/pics/must_be_32.svg",height:Math.min(32,_)})),E=E||(n.igroupid?t.rowName("igroups",n.igroupid):t.rowName("subjects",n.subjectid,"short")),!u&&"classroomsupervision"!=n.type){if(n.groupnames&&!P.DBITools.groupnamesIsEntireClass(n.groupnames)&&(S=t.tools.groupnames_names(n.groupnames)),"classrooms"!=s)C=L(t,"classrooms",n.classroomids,"short");"classes"==s||"igroups"==s?x=L(t,"teachers",n.teacherids,"short"):(x=L(t,"classes",n.classids),"teachers"!=s&&(A=L(t,"teachers",n.teacherids,"short")))}n.removed&&(I="#c0c0c0",T="#e0e0e0");var R=r&&0<r.length;if(R){var N=function(e){if(0==e.length)return.5;for(var t,n=0,s=0,i=e;s<i.length;s++){var r=i[s];n+=(t=r)&&7==t.length?(299*parseInt(t.substr(1,2),16)+587*parseInt(t.substr(3,2),16)+114*parseInt(t.substr(5,2),16))/1e3/255:0}return n/e.length}(r);"#000000"==T&&N<=.25&&(T="#ffffff"),.95<=N&&(k="inset 0px 0px 0px 1px #c0c0c0")}var O=z.swapBox(c,a),B=_<25?1:2;return U.createElement(U.Fragment,null,U.createElement(z.RTextBox,M.__assign({},O,{hAlign:"center",vAlign:"center",rotate:d,style:M.__assign({color:T,padding:1,fontSize:y,background:R?F.strippedBackground(r,O.x2-O.x1,O.y2-O.y1):I,boxShadow:k,borderRadius:D?4:3,cursor:l?"pointer":void 0},e.style||{}),onClick:l,text:u?U.createElement("span",{style:{textOverflow:u,whiteSpace:"nowrap",overflow:"hidden"}},E):E})),S&&U.createElement(z.RTextBox,M.__assign({},O,{text:S,hAlign:"left",vAlign:"top",style:{color:T,paddingLeft:3,paddingTop:B,fontSize:w,pointerEvents:"none"}})),C&&U.createElement(z.RTextBox,M.__assign({},O,{text:C,hAlign:"right",vAlign:"top",style:{color:T,paddingRight:3,paddingTop:B,fontSize:w,pointerEvents:"none"}})),x&&U.createElement(z.RTextBox,M.__assign({},O,{text:x,hAlign:"left",vAlign:"bottom",style:{color:T,paddingLeft:3,paddingBottom:B,fontSize:w,pointerEvents:"none"}})),A&&U.createElement(z.RTextBox,M.__assign({},O,{text:A,hAlign:"right",vAlign:"bottom",style:{color:T,paddingRight:3,paddingBottom:B,fontSize:w,pointerEvents:"none"}})),p)}function x(e){var t=e.box,n=e.swapAxis;return U.createElement(U.Fragment,null,U.createElement(z.RBox,M.__assign({},z.swapBox(t,n),{style:{boxShadow:"0px 0px 10px 2px #000000",zIndex:1,pointerEvents:"none",borderRadius:3}})),U.createElement(z.RBox,M.__assign({},z.swapBox(t,n),{style:{border:"1px solid #ffffff",zIndex:2,pointerEvents:"none",borderRadius:3}})))}j.COLOR_lines="#e0e0e0",j.TTView_OuterLines=function(e){return U.createElement(z.RBox,M.__assign({},e.outerBox,{style:{pointerEvents:"none",borderRight:"1px solid "+j.COLOR_lines,borderBottom:"1px solid "+j.COLOR_lines}}))},j.TTView_Header=o,j.TTView_Day=function(e){var t=e.box,n=e.date,s=e.splitLineTop,i=e.swap,r=a.client_req;return U.createElement(o,{box:t,swap:i,splitLineTop:s,text:U.createElement(U.Fragment,null,r.lib_date.day_name(n,!0),U.createElement("span",{style:{fontSize:10}},ASC.ASC_date2str(n,!1)))})},j.TTView_Object=function(e){var t=e.dbi,n=e.table,s=e.id,i=e.showTable;return U.createElement(o,M.__assign({},M.__assign(M.__assign({},e),{text:t.rowName(n,s,"short"),bgIcon:i?t.table(n).icon():e.bgIcon})))},j.TTView_Periods=function(e){var t=e.tlr,n=e.dbi,i=e.onPeriodClick,s=e.periodsBox,r=e.swap,a=e.showTime;t.clear(),t.qSize=s.y2-s.y1;for(var o=t,l=0,c=e.periods||n.tableData("periods");l<c.length;l++){var u=c[l];o.addItem("main",u)}return o.render(),U.createElement(z.RBox,M.__assign({},z.swapBox(s,r),{style:{background:"#ffffff"}}),o.items.map(function(e){var t=e.data,n=z.swapBox(o.item2box(e),r),s=Math.min(1,(n.y2-n.y1)/40);return U.createElement(z.Fragment,{key:t.id},U.createElement(z.RTextBox,M.__assign({},n,{text:U.createElement(U.Fragment,null,t.short,a&&U.createElement("span",{style:{fontSize:10*s}},ASC.ASC_time2str(t.starttime,{ajSekundy:!1})+" - "+ASC.ASC_time2str(t.endtime,{ajSekundy:!1}))),hAlign:"center",vAlign:"center",style:{fontSize:18*s,cursor:i?"pointer":void 0},onClick:i?function(){return i(t.id)}:void 0})))}))},j.TTView_Lines=S,j.BACKGROUND_absent="#7b7b7b",j.BACKGROUND_event="#d0ffd0",j.BACKGROUND_event_absent="repeating-linear-gradient(-45deg, #87A587, #87A587 5px, #7b7b7b 5px, #7b7b7b 10px)",j.TTView_Cell=C,j.TTView_TTDay=function(e){var r=e.dbi,t=e.box,n=e.gap_day,a=e.table,o=e.tlr,s=e.ttitems,l=e.onTTItemClick,c=e.selectedTTItem,u=e.swapAxis,i=e.showTime,d=t.y2-t.y1;o.clear(),o.qSize=d-n;for(var m=0,p=s;m<p.length;m++){var b=p[m],h="main";"event"==b.type&&(h="autotop"),"classroomsupervision"==b.type&&(h="supervision","break"==P.DBITools.typeOfUniPeriod(b.uniperiod)&&(h="supervisionside")),"absent"!=b.type&&"subst_duty"!=b.type||(h="autobottom"),b.removed&&"main"==h&&(h="autobottom"),b.main&&(h="main"),o.addItem(h,b,{slices:b.cellSlices,order:b.cellOrder})}o.render();var f=null;if(i){var g=o.t2p(o.data2t({starttime:i}).t1),_=Math.round(g-.5),v=Math.min(5,o.pSize-_),y={x1:_-5,y1:-5,x2:_+1+v,y2:d-n+5-0},w="#ff0000",E="rgba(0,0,0,0)";f=U.createElement(z.RBox,M.__assign({},z.swapBox(y,u),{style:{background:w,borderLeftWidth:5,borderTopWidth:5,borderRightWidth:u?5:v,borderBottomWidth:u?v:5,borderStyle:"solid",backgroundClip:"content-box",borderColor:u?E+" "+w:w+" "+E,pointerEvents:"none",zIndex:1}}))}return U.createElement(U.Fragment,null,U.createElement(z.RBox,M.__assign({},z.swapBox(t,u),{style:{overflow:"visible"}}),U.createElement(S,{dbi:r,tlr:o,rowHeight:d,swap:u}),o.renderOrderItems().map(function(e,t){var n=o.item2box(e),s=e.data,i=c==s;return U.createElement(z.Fragment,{key:t},U.createElement(C,M.__assign({},{dbi:r,table:a,box:n,swapAxis:u,ttitem:s,style:{border:s.removed?"1px dashed #808080":s.changed?"2px dashed #000":void 0},colors:s.colors?s.colors:void 0,tlr_part:e.part,onClick:l?function(){return l(s)}:void 0})),i&&U.createElement(x,{box:n,swapAxis:u}))}),f),U.createElement(z.RBox,M.__assign({},z.swapBox(t,u),{style:{pointerEvents:"none"}})))},j.TTView_CellSelect=x}),ASC.setModuleSourceFunc("/timetable/app/ttdoc.js",function(b,require,e){b.__esModule=!0;var t,n,h=require("tslib"),f=require("../../asc/asc_react"),g=require("../../asc/edurequest"),s=require("../../rpr/dbi");function _(t){return!!b.metaclassrooms_priorita_def.find(function(e){return e.id==t})}function r(d,m,p){return h.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a,o,l,c,u;return h.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.loadTTLang()];case 1:return e.sent(),[4,Promise.resolve().then(function(){return require("../../rpr/vyber")})];case 2:if(t=e.sent().DBIVyberDlg,"metaclassrooms"!=m)return[3,4];for(n=[],s="*optimal",i=0,r=p;i<r.length;i++)_(a=r[i])?s=a:n.push({id:a,select:s});return[4,f.RDialog.showComponent(t,{dbi:d,table:m,selected:n,filter:function(e){return!_(e)},selectTypes:b.metaclassrooms_priorita_def.map(function(e){return{id:e.id,icon:e.icon,name:g.client_req.localize(e.short)}})})];case 3:if(!(u=e.sent()).confirm)return[2,null];for(p=[],s="*optimal",o=0,l=u.state.selected;o<l.length;o++)(c=l[o]).select!=s&&(s=c.select,p.push(s)),p.push(c.id);return[2,p];case 4:return[4,f.RDialog.showComponent(t,{dbi:d,table:m,ids:p})];case 5:return[2,(u=e.sent()).confirm?u.state.selected.map(function(e){return e.id}):null]}})})}function i(e,t,n){for(var s=0,i=e.tableData(t+"defs");s<i.length;s++){var r=i[s];if(!(1<r.vals.length)&&r.vals[0]==n)return r}return null}function u(e,t,n){var s=i(e,t,n);return s?e.rowName(t+"defs",s.id):n}function l(e,t,n){if(void 0===n&&(n="short"),!t.days)return"";for(var s=e.rowData("lessons",t.lessonid),i=h.__assign(h.__assign({},s),t),r="",a=0,o=["terms","weeks","days"];a<o.length;a++){var l=o[a],c=i[l];c.indexOf("0")<0||(r&&(r+=", "),r+=u(e,l,c))}return(r+" "+e.tools.uniperiodName(t.period,n,s)).trim()}function c(e,t,n){return void 0===n&&(n="short_name"),a(e,t,null,n)}function a(e,t,n,s){void 0===s&&(s="BHSN");var i=e.req;if(!t)return"";if(n)return"BHSN"==s&&"classes"==t.table&&"subjects"==n.id?"("+c(e,t,"short")+":"+c(e,n,"short")+") "+c(e,t,"name")+": "+c(e,n,"name"):c(e,t,s)+" : "+c(e,n,s);switch(t.table){case"cards":var r=e.rowData("cards",t.id),a=c(e,{table:"lessons",id:r.lessonid})+" - ";return r.days?a+=l(e,r,"short"):a+=i.ttls(1765),a;case"lessons":var o=e.rowData("lessons",t.id);a=e.rowName("subjects",o.subjectid);return o.seminargroup&&(a+=" "+o.seminargroup),a+=" (",0==o.classids.length?a+=i.ttls(2825):a+=e.rowNames("classes",o.classids,"short"),a+=")",0<o.groupnames.length&&!o.groupnames.includes("")&&(a+=" "+e.tools.groupnames_names(o.groupnames)),a}return e.rowName(t.table,t.id,s)}(t=b.TypCoGenerovat||(b.TypCoGenerovat={}))[t.TCG_VSETKO=0]="TCG_VSETKO",t[t.TCG_STUDENTI=1]="TCG_STUDENTI",t[t.TCG_STUDENTI_BEZKARIET=2]="TCG_STUDENTI_BEZKARIET",t[t.TCG_MASTER=3]="TCG_MASTER",t[t.TCG_MASTER_LOCKSTUDENTI=4]="TCG_MASTER_LOCKSTUDENTI",t[t.TCG_MASTER_HIDDENSTUDENTI=5]="TCG_MASTER_HIDDENSTUDENTI",t[t.TCG_UCEBNE=6]="TCG_UCEBNE",t[t.TCG_UCEBNE_LOCKPRIRADENE=7]="TCG_UCEBNE_LOCKPRIRADENE",t[t.TCG_VSETKO_BEZUCEBNI=8]="TCG_VSETKO_BEZUCEBNI",t[t.TCG_REARRANGESTUDENTSINSEMINARGROUPS=9]="TCG_REARRANGESTUDENTSINSEMINARGROUPS",t[t.TCG_ASSIGNSTUDENTS=10]="TCG_ASSIGNSTUDENTS",t[t.TCG_VSETKO_WEEK1=11]="TCG_VSETKO_WEEK1",t[t.TCG_VSETKO_WEEK2=12]="TCG_VSETKO_WEEK2",t[t.TCG_ANALYZE=13]="TCG_ANALYZE",t[t.TCG_MAX=14]="TCG_MAX",t[t.TCG_MASK_TCG=255]="TCG_MASK_TCG",t[t.TCG_FLAG_IMPROVE=256]="TCG_FLAG_IMPROVE",t[t.TCG_FLAG_USE_HIGHSCHOOL=512]="TCG_FLAG_USE_HIGHSCHOOL",t[t.TCG_FLAG_OBMEDZENYHIGHSCHOOL=1024]="TCG_FLAG_OBMEDZENYHIGHSCHOOL",t[t.TCG_FLAG_IBAOPTIMIZE=2048]="TCG_FLAG_IBAOPTIMIZE",(n=b.PRINTAREA||(b.PRINTAREA={}))[n.TRIEDA=0]="TRIEDA",n[n.UCITEL=1]="UCITEL",n[n.ZIAK=2]="ZIAK",n[n.UCEBNA=3]="UCEBNA",n[n.PREDMET=4]="PREDMET",n[n.SUHRN_TRIEDA=5]="SUHRN_TRIEDA",n[n.SUHRN_UCITEL=6]="SUHRN_UCITEL",n[n.SUHRN_UCEBNA=7]="SUHRN_UCEBNA",n[n.SUHRN_POSTER_TRIEDA=8]="SUHRN_POSTER_TRIEDA",n[n.SUHRN_POSTER_UCITEL=9]="SUHRN_POSTER_UCITEL",n[n.SUHRN_POSTER_UCEBNA=10]="SUHRN_POSTER_UCEBNA",n[n.SUHRN_TRIEDA_PO_DNOCH=11]="SUHRN_TRIEDA_PO_DNOCH",n[n.SUHRN_UCITEL_PO_DNOCH=12]="SUHRN_UCITEL_PO_DNOCH",n[n.SUHRN_UCEBNA_PO_DNOCH=13]="SUHRN_UCEBNA_PO_DNOCH",n[n.VOLNE_UCEBNE=14]="VOLNE_UCEBNE",n[n.LESSONGRID=15]="LESSONGRID",n[n.MASTER=16]="MASTER",n[n.SUHRN_ZIAK=17]="SUHRN_ZIAK",n[n.SUHRN_PREDMET=18]="SUHRN_PREDMET",n[n.CUSTOM1=19]="CUSTOM1",n[n.CUSTOM2=20]="CUSTOM2",n[n.CUSTOM3=21]="CUSTOM3",n[n.INSPEKCIA=22]="INSPEKCIA",n[n.INSPEKCIA_UCITEL=23]="INSPEKCIA_UCITEL",n[n.INSPEKCIA_UCITEL_EXTRA=24]="INSPEKCIA_UCITEL_EXTRA",n[n.CONTRACT_OVERVIEW=25]="CONTRACT_OVERVIEW",n[n.DAILYATTENDANCE=26]="DAILYATTENDANCE",n[n.NUMBER_OF=27]="NUMBER_OF",b.metaclassrooms_linka_def=[{id:"*home",name:"{tt:1067}",icon:"/timetable/pics/app/homeroom.png"},{id:"*teacher",name:"{tt:3773}",icon:"/global/pics/ui/teacher_32.svg"},{id:"*shared",name:"{tt:1068}",icon:"/timetable/pics/app/sharedroom.png"},{id:"*subject",name:"{tt:3774}",icon:"/global/pics/ui/subject_32.svg"}],b.metaclassrooms_priorita_def=[{id:"*optimal",name:"{tt:4358}",short:"{tt:4359}",color:"#22B14C",icon:"/timetable/pics/app/standard/vyber_optimal_16.png"},{id:"*normal",name:"{tt:4360}",short:"{tt:4361}",color:"#B5E61D",icon:"/timetable/pics/app/standard/vyber_normal_16.png"},{id:"*bad",name:"{tt:4362}",short:"{tt:4363}",color:"#f1c40f",icon:"/timetable/pics/app/standard/vyber_bad_16.png"},{id:"*emergency",name:"{tt:4364}",short:"{tt:4365}",color:"#FF311D",icon:"/timetable/pics/app/standard/vyber_emergency_16.png"}],b.isMetaclassroomPriorita=_,b.metaclassrooms_def=h.__spreadArrays(b.metaclassrooms_linka_def,b.metaclassrooms_priorita_def),b.showTTDocVyberDlg=r,b.phpShowVyberDlg=function(n,s,i){return h.__awaiter(this,void 0,void 0,function(){var t;return h.__generator(this,function(e){switch(e.label){case 0:return[4,ASC.blockUI(g.client_req.ttuidocdbi(n,{tables:[s],columns:["name","short","firstname","lastname","color"]}))];case 1:return[4,r(e.sent(),s,i)];case 2:return(t=e.sent())?[2,"sel:"+t.join(",")]:[2,""]}})})},b.allItemsName=function(e,t){var n={classes:"{tt:1868}",subjects:"{tt:3056}",teachers:"{tt:3055}"}[t]||"All";return e.localize(n)},b.entireClassGroupid=function(e,t){for(var n=0,s=e.tableData("groups");n<s.length;n++){var i=s[n];if(i.classid==t&&i.entireclass)return i.id}return""},b.findClassGroup=function(e,t,n){for(var s=0,i=e.tableData("groups");s<i.length;s++){var r=i[s];if(r.classid==t&&!r.entireclass&&r.name==n)return r.id}return""},b.ids2colors=function(e,t,n){for(var s=[],i=0,r=n;i<r.length;i++){var a=r[i],o=e.rowData(t,a);s.push(o&&o.color||"#ffffff")}return s},b.strippedBackground=function(e,t,n){var s=e.length;if(0==s)return"#fff";if(1==s)return e[0];var i=45;return 3<=t&&3<=n&&(i=Math.atan2(n,t/(s-1))/Math.PI*180),0===t&&(i=0),"linear-gradient("+(180-i)+"deg,"+e.map(function(e,t){return e+" "+100*t/s+"%,"+e+" "+100*(t+1)/s+"%"}).join()+")"},b.lessonSeminarClasses=function(i,r){return r.seminargroup?0<r.groupids.length?r.classids.filter(function(e){for(var t=0,n=r.groupids;t<n.length;t++){var s=n[t];if(i.rowData("groups",s).classid==e)return!1}return!0}):r.classids:[]},b.trackTTOEvent=function(e,t,n){void 0===n&&(n="");var s=window.ga;s&&s("ttonlineTracker.send","event",e,t,n)},b.defaultShort=function(e,t,n){var s=n.name||"";switch(t){case"classes":case"classrooms":return s;case"teachers":case"students":var i=(n.firstname||"").substr(0,1),r=(n.lastname||"").substr(0,1);return e.sort_name_col.indexOf("F")<e.sort_name_col.indexOf("L")?i+r:r+i;case"subjects":for(var a="",o=0,l=s.split(" ");o<l.length;o++){a+=l[o].substr(0,1)}return a;default:return s.substr(0,1)}},b.obdobieBitsToRow=i,b.obdobieName=u,b.cardPositionName=l,b.idssArrayMatch=function(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(!s.idsArrayMatch(e[n],t[n]))return!1;return!0},b.getUINazov=c,b.getUINazov2=a,b.getTTDocStructure=function(e){var t={periodfrom:1,periodto:8,days:1,weeks:1,terms:1},n=e.tableData("periods");0<n.length&&(t.periodfrom=parseInt(n[0].id),t.periodto=parseInt(n[n.length-1].id));for(var s=0,i=["days","weeks","terms"];s<i.length;s++){var r=i[s],a=e.tableData(r);if(0<a.length)t[r]=a.length;else{var o=e.tableData(r+"defs");if(0<o.length){var l=o[0];l.vals&&(t[r]=l.vals[0].length)}}}return t}}),ASC.setModuleSourceFunc("/substitution/server/settings.js",function(e,require,t){t.implementRpc(["getSubstOnlineUISettings","updateSubstOnlineUISettings"])}),ASC.setModuleSourceFunc("/substitution/server/substdbi.js",function(e,require,t){t.implementRpc(["substDBIAccessor"])}),ASC.setModuleSourceFunc("/substitution/online/dlg_addcard.js",function(e,require,t){e.__esModule=!0;var y=require("tslib"),w=require("react"),n=require("../../rpr/dbi"),s=require("../server/commands"),E=require("../../asc/asc_react"),S=require("../../asc/edurequest"),C=require("../subst"),x=require("./timetable"),A=require("../../asc/asc_react2"),T=require("../../rpr/dbi_react"),I=(require("../../asc/actions"),require("./combo")),k="substonline_substitutions";function D(e){for(var t=e.kolizie,n=e.table,s=0,i=t;s<i.length;s++){if(i[s].table==n)return w.createElement("img",{src:"/global/pics/ui/item_bad_16.png",style:{height:16,verticalAlign:"top",paddingTop:3},title:ASC.ttls(3447)})}return null}var a,o=(a=w.Component,y.__extends(i,a),i.prototype.render=function(){var t=this,e=this.props,n=this.state,s=e.dbi,i=e.tt_dbi,r=e.date,a=e.substid,o=s.req,l=n.row,c=E.stateRef(this,"row"),u=!a,d=u?ASC.ttls(3784):ASC.ttls(1058);n.orig&&n.orig.origid&&(d=ASC.lsf(7443,{date:S.client_req.lib_date.date_format_date(n.orig.origid.split(":")[0])})),this.hasChanges()&&(d+="*");var m={verticalAlign:"top"},p=o.isApp()?{}:{width:100},b=[];l.classids.forEach(function(e){return b.push({table:"classes",id:e})}),l.teacherids.forEach(function(e){return b.push({table:"teachers",id:e})}),l.classroomids.forEach(function(e){return b.push({table:"classrooms",id:e})});var h=[];if(!u){var f=C.findTTItemFromSubstId(s.tableData("substonline_ttitems"),a);f&&h.push(f.id)}var g={id:"_editing_",date:r,subId:"",type:"tcard",uniperiod:l.uniperiod,endtime:l.endtime,subjectid:l.subjectid,teacherids:l.teacherids,classids:l.classids,groupnames:l.groupnames,classroomids:l.classroomids,igroupid:l.igroupid,added:!0,changes:[],substids:[],origofids:[]},_=[g],v=x.getSubstTTItemKolizie(s,i,g,h);return w.createElement(E.RDialog,{header:d,width:970,ref:function(e){return t.rdlg=e},onConfirm:function(){return t.ok()},buttons:["ok","cancel"],appFullScreen:!0},w.createElement(E.VGap,{height:6}),w.createElement(A.HorizontalSplit,null,w.createElement(A.SectionWithIcon,{icon:s.table("subjects").icon(),small:!0,style:m},w.createElement(E.RLabel,{text:s.table("subjects").itemName()+":",style:p}),w.createElement(E.RComboBox,{valueRef:E.subRef(c,"subjectid"),items:s.tools.tableCombo("subjects")})),w.createElement(A.SectionWithIcon,{icon:s.table("classes").icon(),small:!0,style:m},w.createElement(E.RLabel,{text:s.table("classes").itemName()+":",style:p}),w.createElement(T.UniClassPicker,y.__assign({},{dbi:s,date:r,rowRef:c})),w.createElement(D,{kolizie:v,table:"classes"}))),w.createElement(A.SeparatorLine,null),w.createElement(A.HorizontalSplit,null,w.createElement(A.SectionWithIcon,{icon:s.table("teachers").icon(),small:!0,style:m},w.createElement(E.RLabel,{text:s.table("teachers").itemName()+":",style:p}),w.createElement(T.UniTeacherPicker,y.__assign({},{dbi:s,rowRef:c,style:{width:200},substCombo:I.substTTItemComboItems({table:"teachers",dbi:s,tt_dbi:i,ttitem:g,remove_ttitemids:h,topid:l.teacherids[0]})})),w.createElement(D,{kolizie:v,table:"teachers"})),w.createElement(A.SectionWithIcon,{icon:s.table("classrooms").icon(),small:!0,style:m},w.createElement(E.RLabel,{text:s.table("classrooms").itemName()+":",style:p}),w.createElement(T.UniClassroomPicker,y.__assign({},{dbi:s,rowRef:c,style:{width:200},substCombo:I.substTTItemComboItems({table:"classrooms",dbi:s,tt_dbi:i,ttitem:g,remove_ttitemids:h,topid:l.classroomids[0]})})),w.createElement(D,{kolizie:v,table:"classrooms"}))),w.createElement(A.SeparatorLine,null),w.createElement(A.HorizontalSplit,null,w.createElement(A.SectionWithIcon,{icon:"/timetable/pics/app/office/alarm_48.png",small:!0,style:m},w.createElement(E.RLabel,{text:ASC.ls(1345)+":",style:p}),w.createElement("span",{style:{display:"inline-block",verticalAlign:"top"}},w.createElement(T.UniPeriodPicker,y.__assign({},{dbi:s,rowRef:c,modes:["period","starttime","daypart"]})))),w.createElement(A.SectionWithIcon,{icon:s.table("substitution_types").icon(),small:!0,style:m},w.createElement(E.RLabel,{text:s.column(k,"substitution_typeid").name()+":",style:p}),w.createElement(E.RComboBox,{valueRef:E.subRef(c,"substitution_typeid"),items:s.tools.tableCombo("substitution_types"),style:{width:200}}),w.createElement(E.VGap,{height:3}),w.createElement(E.RLabel,{text:s.column(k,"note").name()+":",style:y.__assign(y.__assign({},p),{verticalAlign:"top"})}),w.createElement(E.RTextArea,{valueRef:E.subRef(c,"note"),style:{width:200}}))),w.createElement(A.SeparatorLine,null),w.createElement("div",{style:{minHeight:200}},!1,w.createElement(x.SubstDlgTimetableView,y.__assign({},{date:r,dbi:s,tt_dbi:i,items:b,style:{height:Math.min(50+60*b.length,300)},remove_ttitemids:h,editing_ttitems:_,onPeriodClick:function(e){return c.write(y.__assign(y.__assign({},l),{uniperiod:e,endtime:""}))},kolizie:v}))))},i.prototype.componentDidMount=function(){barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstEditAddCardDlg.open",eventLabel:""})},i.prototype.hasChanges=function(){var e=this.state;return!e.orig||!!n.DBITools.rowChanges2write(e.orig,e.row)},i.prototype.ok=function(){return y.__awaiter(this,void 0,void 0,function(){var t,n;return y.__generator(this,function(e){switch(e.label){case 0:return t=this.state,this.hasChanges()?[4,ASC.blockUI(s.updateupdateSubstSubstitutionAddCard(null,t.row))]:(this.rdlg.close(),[2]);case 1:return(n=e.sent()).fail?[4,E.showUniResponse(n)]:[3,3];case 2:return e.sent(),[3,4];case 3:this.rdlg.confirmClose(),barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstEditAddCardDlg.ok",eventLabel:""}),e.label=4;case 4:return[2]}})})},i);function i(e){var t=a.call(this,e)||this,n={orig:t.rdlg=null,row:null},s=e.dbi,i=e.substid;if(i){var r=s.rowData(k,i);n.orig=C.substItem2substAddCardItem(r),n.row=n.orig}else n.row={id:"",date:e.date,subId:"",uniperiod:"1",endtime:"",subjectid:"",teacherids:[],classids:[],groupnames:[""],igroupid:"",classroomids:[],substitution_typeid:"",note:"",origid:""};return t.state=n,t}e.showSubstEditAddCardDlg=function(i,r,a){return y.__awaiter(this,void 0,void 0,function(){var t,n,s;return y.__generator(this,function(e){switch(e.label){case 0:return!(t=a.date)&&r&&(t=r.split(":")[0]),s=n=null,a.online?(n=a.online.dbi,s=a.online.tt_dbi,[3,3]):[3,1];case 1:return[4,ASC.blockUI(S.client_req.maindbi(i,{tables:C.SubstApp_maindbi_needed_tables,columns:C.SubstApp_maindbi_needed_columns,vt_filter:{date:t}}))];case 2:n=e.sent(),e.label=3;case 3:return[4,ASC.loadTTLang()];case 4:return e.sent(),[4,E.RDialog.show(o,{date:t,dbi:n,tt_dbi:s,substid:r})];case 5:return[2,e.sent()]}})})},e._hotswap=[o]}),ASC.setModuleSourceFunc("/substitution/online/dlg_ttitem.js",function(e,require,t){e.__esModule=!0;var K=require("tslib"),z=require("react"),Y=require("../../rpr/dbi"),P=require("../../asc/asc_react"),$=require("../subst"),B=require("../../asc/edurequest"),j=require("../../asc/asc_react2"),M=require("./timetable"),U=require("../../asc/actions"),d=require("../server/commands"),F=require("./combo"),r=require("../../asc/datatable_r"),m=require("./rightpanel"),L="substonline_substitutions",x="substonline_ttitems",G="_no_teacher_",q={display:"flex",flexDirection:"row",minHeight:23,alignItems:"center"},H={flex:"0.7 1 0px",minWidth:0},V={flex:"1 1 0px",minWidth:0,textAlign:"right"};function W(e){var t=e.dbi,n=e.table,s=e.valueRef,i=e.orig_value,r=e.disable_change,a=e.should_change,o=e.kolizie,l=e.cancelled,c=e.absents,u=e.combo,d=e.join_duration,m=e.onCombo,p=e.new_value||"";s&&(p=s.read());var b=z.useState(!(!s||r||!a&&p==i)),h=b[0],f=b[1];r||p==i||h||f(!0);var g=e.orig_text;g||i&&(g=t.tools.rowName(n,i));var _=e.new_text||"";!_&&p&&(_=t.tools.rowName(n,p)),"periods"==n&&1<d&&(g+="-"+t.rowName("periods",Y.DBITools.uniperiod_delta(i,d-1)),_+="-"+t.rowName("periods",Y.DBITools.uniperiod_delta(p,d-1)));var v=null;if(o)for(var y=!1,w=!1,E=0,S=o;E<S.length;E++){var C=S[E];C.table==n&&C.id==p&&(C.join?w=!0:y=!0),(y||w)&&(v=z.createElement("img",{src:y?$.ICON_subst_kolizia:$.ICON_subst_spojenie,style:{height:16,verticalAlign:"middle",paddingTop:-3,display:"inline-block",marginLeft:7},title:y?ASC.ttls(3447):ASC.ttls(1535)}))}var x=!1;if(i&&c)for(var A=0,T=c;A<T.length;A++){var I=T[A];$.absentGetTable(I)==n&&$.absentGetId(I)==i&&(x=!0)}var k=z.createElement("span",{style:{textAlign:"right",verticalAlign:"middle",fontWeight:x?"bold":"normal"}},x?"("+g+")":g),D=null,R=null,N=null;if(D=z.createElement("img",{src:"/global/pics/ui/replace_32.svg",style:{verticalAlign:"middle",height:16,padding:"0px 5px"}}),l)R=z.createElement(z.Fragment,null);else if(r)R=z.createElement(z.Fragment,null,_||(x?ASC.ls(1846):"-"));else if(h){var O=u;if(!u)if("periods"==n&&1<d){O=[];for(var B=0,j=t.tableIds("periods");B<j.length;B++){var M=j[B],U=Y.DBITools.uniperiod_delta(M,d-1);t.rowData("periods",U)&&O.push({value:M,name:t.rowName("periods",M)+"-"+t.rowName("periods",U)})}}else O=t.tools.tableCombo(n,void 0,0<=["subjects","periods"].indexOf(n)?null:void 0);R=z.createElement(P.RComboBox,{valueRef:s,items:O,style:"periods"==n?{}:{minWidth:150}}),m&&(R=z.createElement("span",{onClick:m,style:{display:"inline-block"}},z.createElement("span",{style:{pointerEvents:"none"}},R)))}else R=z.createElement(P.Fragment,null,_),r||(N=z.createElement("a",{style:{marginLeft:7,fontSize:"80%",color:"#a0a0a0",cursor:"pointer"},onClick:function(){f(!0)}},ASC.ls(1090)));return g!=_||x||h||(k=g,R=D=null),z.createElement("div",{style:q},z.createElement("div",{style:H},k),D,z.createElement("div",{style:V},R,v,N))}function Z(e){return z.createElement("div",{style:q},z.createElement("div",{style:H}),z.createElement("div",{style:V},e.children))}function J(e){return z.createElement(Z,null,z.createElement("a",{style:{marginLeft:7,fontSize:"80%",color:"#a0a0a0",cursor:"pointer"},onClick:e.onClick},ASC.ls(1257)))}var A,n=(A=z.Component,K.__extends(s,A),s.prototype.render=function(){function e(e,t,n){e:for(var s=0;s<n.length;s++){var i=n[s];if(i=i||t[s]){for(var r=0,a=I;r<a.length;r++){var o=a[r];if(o.table==e&&o.id==i)continue e}I.push({table:e,id:i})}}}var t=this,n=this.props,s=this.state,i=n.ttitemid.split(":")[0],a=n.dbi,o=n.tt_dbi,r=n.ttitemid,l=n.join_doubles,c=s.absents,u=s.orig_row,d=s.row,m=s.teacherids_cancelled,p=s.cancelled,b=s.substs,h=a.req,f=$.buildSubstOnlineTTItemsEx(a,i,l).find(function(e){return e.id==r}),g=f.durationperiods,_=P.fullStateRef(this),v=P.subRef(_,"row"),y={verticalAlign:"top"},w=K.__assign({},y),E=K.__assign({},y),S={display:"none"},C={},x={},A="period"==Y.DBITools.typeOfUniPeriod(d.uniperiod),T="classroomsupervision"!=d.type,I=[];"classroomsupervision"==d.type?(e("classrooms",u.classroomids,d.classroomids),e("teachers",u.teacherids,d.teacherids)):(u.igroupid&&I.push({table:"igroups",id:u.igroupid}),e("classes",u.classids,d.classids),p||(e("teachers",u.teacherids,d.teacherids),e("classrooms",u.classroomids,d.classroomids)));var k=K.__assign(K.__assign({},d),{id:"_editing_",date:i,subId:"",type:"classroomsupervision"==d.type?"classroomsupervision":"tcard",durationperiods:g});function D(e,t){for(var n=[{value:"",name:"-"},[]],s=0,i=F.substTTItemComboItems({table:e,dbi:a,tt_dbi:o,ttitem:k,remove_ttitemids:R,topid:t});s<i.length;s++){var r=i[s];n.push({value:r.id,name:a.rowName(e,r.id,"teachers"==e?B.client_req.sort_name_col:void 0),classname:r.className})}return"teachers"==e&&(n.push([]),n.push({value:G,name:ASC.ttls(3118)})),n}p&&(k.orig=$.coreOfTTItem(k),k.cancelled=!0,k.subjectid="",k.classids=[],k.igroupid="",k.teacherids=[],k.classroomids=[]);var R=K.__spreadArrays([f.id],f.join_ttitemids||[]),N=M.getSubstTTItemKolizie(a,o,k,R),O="classroomsupervision"!=f.type&&!p;return z.createElement(P.RDialog,{header:ASC.ls(1003)+" - "+B.client_req.lib_date.date_format_day(i)+(this.hasChanges()?"*":""),width:970,ref:function(e){return t.rdlg=e},onConfirm:function(){return t.ok()},buttons:["ok","cancel"],footer:z.createElement(P.RButton,{label:U.action_name("help"),fa_icon:U.action_fa_icon("help"),onClick:function(){return window.open("https://help.edupage.org/text.php?id=1639","_blank")}}),appFullScreen:!0},z.createElement(P.VGap,{height:6}),"classroomsupervision"!=d.type&&z.createElement(P.Fragment,null,z.createElement(j.HorizontalSplit,null,z.createElement(j.SectionWithIcon,{icon:a.table("subjects").icon(),small:!0,style:w},z.createElement(P.RLabel,{text:a.table("subjects").itemName()+":",style:S}),z.createElement(W,{dbi:a,table:"subjects",orig_value:u.subjectid,valueRef:P.subRef(v,"subjectid"),cancelled:p})),u.igroupid?z.createElement(j.SectionWithIcon,{icon:a.table("igroups").icon(),small:!0,style:E},z.createElement(W,{dbi:a,table:"igroups",orig_value:u.igroupid,new_value:d.igroupid,disable_change:!0,kolizie:N,cancelled:p,absents:c})):z.createElement(j.SectionWithIcon,{icon:a.table("classes").icon(),small:!0,style:E},z.createElement(P.RLabel,{text:a.table("classes").itemName()+":",style:S}),u.classids.map(function(e,t){return z.createElement(W,{key:""+t,dbi:a,table:"classes",orig_value:e,new_value:d.classids[t],disable_change:!0,kolizie:N,cancelled:p,absents:c})}),(!Y.idsArrayMatch(d.groupnames,d.groupnames)||!Y.DBITools.groupnamesIsEntireClass(d.groupnames))&&z.createElement(P.Fragment,null,z.createElement(P.VGap,{height:5}),z.createElement(W,{dbi:a,table:"groupnames",orig_text:a.tools.groupnames_names(u.groupnames),new_text:a.tools.groupnames_names(d.groupnames),disable_change:!0,cancelled:p})))),z.createElement(j.SeparatorLine,{style:C})),z.createElement(j.HorizontalSplit,null,z.createElement(j.SectionWithIcon,{icon:a.table("teachers").icon(),small:!0,style:w},z.createElement(P.RLabel,{text:a.table("teachers").itemName()+":",style:S}),d.teacherids.map(function(e,n){var t=P.castRef(_,function(e){return e.row.teacherids[n]||(e.teacherids_cancelled[n]?G:"")},function(e,t){return t=K.__assign(K.__assign({},t),{row:K.__assign(K.__assign({},t.row),{teacherids:K.__spreadArrays(t.row.teacherids)}),teacherids_cancelled:K.__spreadArrays(t.teacherids_cancelled)}),e==G?(t.row.teacherids[n]="",t.teacherids_cancelled[n]=!0):(t.row.teacherids[n]=e,t.teacherids_cancelled[n]=!1),t});return z.createElement(W,{key:""+n,dbi:a,table:"teachers",orig_value:u.teacherids[n]||"",valueRef:t,kolizie:N,cancelled:p,should_change:!u.teacherids[n],absents:c,combo:D("teachers",s.row.teacherids[n]),onCombo:h.isApp()?function(){return P.RDialog.show(z.createElement(ee,{table:"teachers",valueRef:t,ttitemid:r,dbi:a,tt_dbi:o,join_doubles:l}))}:void 0})}),O&&d.teacherids[d.teacherids.length-1]&&z.createElement(J,{onClick:function(){return t.setState({row:K.__assign(K.__assign({},d),{teacherids:K.__spreadArrays(d.teacherids,[""])}),orig_row:K.__assign(K.__assign({},u),{teacherids:K.__spreadArrays(u.teacherids,[""])})})}})),z.createElement(j.SectionWithIcon,{icon:a.table("classrooms").icon(),small:!0,style:E},z.createElement(P.RLabel,{text:a.table("classrooms").itemName()+":",style:S}),d.classroomids.map(function(e,t){return z.createElement(W,{key:""+t,dbi:a,table:"classrooms",orig_value:u.classroomids[t]||"",valueRef:P.indexRef(P.subRef(v,"classroomids"),t),disable_change:!T,kolizie:N,cancelled:p,should_change:!u.classroomids[t],absents:c,combo:D("classrooms",s.row.classroomids[0])})}),O&&(0==d.classroomids.length||d.classroomids[d.classroomids.length-1])&&z.createElement(J,{onClick:function(){return t.setState({row:K.__assign(K.__assign({},d),{classroomids:K.__spreadArrays(d.classroomids,[""])}),orig_row:K.__assign(K.__assign({},u),{classroomids:K.__spreadArrays(u.classroomids,[""])})})}}))),z.createElement(j.SeparatorLine,{style:C}),z.createElement(j.HorizontalSplit,null,z.createElement(j.SectionWithIcon,{icon:"/timetable/pics/app/office/alarm_48.png",small:!0,style:K.__assign(K.__assign({},w),{minHeight:70})},z.createElement(P.RLabel,{text:ASC.ls(1345)+":",style:S}),A?z.createElement(W,{dbi:a,table:"periods",orig_value:u.uniperiod,valueRef:P.subRef(v,"uniperiod"),cancelled:p,join_duration:g}):z.createElement(W,{dbi:a,table:"periods",orig_text:a.tools.uniperiodName(u.uniperiod,void 0,u)||"-",new_text:a.tools.uniperiodName(d.uniperiod,void 0,d)||"-",disable_change:!0,cancelled:p}),z.createElement("br",null),z.createElement(Z,null,z.createElement(P.RCheckBox,{valueRef:P.stateRef(this,"cancelled"),label:ASC.ls(2322)}))),z.createElement(j.SectionWithIcon,{icon:a.table("substitution_types").icon(),small:!0,style:E},b.map(function(n,e){var s=P.indexRef(P.stateRef(t,"substs"),e),i=a.column(L,"note").name();return 1==b.length?z.createElement(P.Fragment,{key:""+e},p||z.createElement(P.Fragment,null,z.createElement(P.RLabel,{text:a.column(L,"substitution_typeid").name()+":",style:x}),z.createElement(P.RComboBox,{valueRef:P.subRef(s,"substitution_typeid"),items:a.tools.tableCombo("substitution_types"),style:{width:200}}),z.createElement(P.VGap,{height:3})),z.createElement(P.RLabel,{text:i+":",style:K.__assign(K.__assign({},x),{verticalAlign:"top"})}),z.createElement(P.RTextArea,{valueRef:P.subRef(s,"note"),style:{width:200}})):z.createElement("div",{key:""+e},z.createElement("div",{style:{fontSize:"80%",color:"#808080"}},function(n,e){for(var t=e.absent?$.absentGetTable(e.absent):"teachers",s=null,i=null,r=0,a=e.changes;r<a.length;r++){var o=a[r],l=$.changeColumn2table(o.column);"teachers"==l?s=o:l==t&&(i=o)}var c=[];return s&&c.push(s),i&&c.push(i),0!=c.length?c.map(function(e){var t=$.changeColumn2table(e.column);return n.tools.rowName(t,e.old)+" -> "+n.tools.rowName(t,e.new)}).join(", "):e.absent?"("+n.rowName($.absentGetTable(e.absent),$.absentGetId(e.absent))+")":""}(a,n)),p||z.createElement(P.RComboBox,{valueRef:P.subRef(s,"substitution_typeid"),items:a.tools.tableCombo("substitution_types"),style:{width:200}}),z.createElement(P.HGap,{width:4}),z.createElement("a",{style:{cursor:"pointer",display:"inline-block",whiteSpace:"nowrap",textOverflow:"ellipsis"},onClick:function(){return K.__awaiter(t,void 0,void 0,function(){var t;return K.__generator(this,function(e){switch(e.label){case 0:return[4,P.RDialog.showInput({note:n.note},function(e){return z.createElement(P.RTextArea,{valueRef:P.subRef(e.stateRef,"note"),style:{height:50}})},{header:i})];case 1:return(t=e.sent())&&P.subRef(s,"note").write(t.note),[2]}})})}},i+(n.note?": "+n.note:"")),z.createElement(P.VGap,{height:5}))}))),z.createElement(j.SeparatorLine,{style:C}),z.createElement("div",{style:{minHeight:200}},!1,z.createElement(M.SubstDlgTimetableView,K.__assign({},{date:i,dbi:a,tt_dbi:o,items:I,style:{height:Math.min(50+60*I.length,300)},remove_ttitemids:R,editing_ttitems:[k],join_doubles:l,onPeriodClick:A?function(e){return v.write(K.__assign(K.__assign({},d),{uniperiod:e,endtime:""}))}:null,kolizie:N}))),z.createElement(P.RUpdateListener,{updateTriggers:[d,p],onUpdate:function(){var e=Q({dbi:a,ttitem:f,orig_row:u,row:d,teacherids_cancelled:m,cancelled:p,prev_substs:b,final:!1});t.setState({substs:e})},onMount:function(){return t.rdlg.dlg.center()}}))},s.prototype.componentDidMount=function(){barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstEditTTItemDlg.open",eventLabel:""})},s.prototype.buildUpdates=function(){for(var e={remove:[],update:[],add:[]},t=this.state,n=this.props,s=n.dbi,i=t.orig_row,r=t.row,a=t.cancelled,o=t.substs,l=t.teacherids_cancelled,c=s.rowData(x,n.ttitemid),u=Q({dbi:s,ttitem:c,orig_row:i,row:r,teacherids_cancelled:l,cancelled:a,prev_substs:o,final:!0}),d=new Set,m=0,p=u;m<p.length;m++){var b={note:(v=p[m]).note,changes:v.changes,substitution_typeid:v.substitution_typeid,cancelled:v.cancelled,cancel_teacher:v.cancel_teacher};if(v.id){d.add(v.id);var h=s.rowData(L,v.id);$.substChangesEquals(b.changes,h.changes)&&(b.changes=h.changes),a&&(b.changes=void 0);var f=Y.DBITools.rowChanges2write(h,b);f&&e.update.push(Y.unpartial(f))}else e.add.push(b)}for(var g=0,_=c.substids;g<_.length;g++){var v,y=_[g];(v=s.rowData(L,y)).absent||d.has(v.id)||e.remove.push(v.id)}return e},s.prototype.hasChanges=function(){var e=this.buildUpdates();return 0!=e.add.length||0!=e.update.length||0!=e.remove.length},s.prototype.writeChanges=function(){return K.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a,o,l,c,u;return K.__generator(this,function(e){switch(e.label){case 0:t=this.props.join_doubles,n=this.buildUpdates(),s=0,i=n.update,e.label=1;case 1:return s<i.length?(o=i[s],[4,d.updateSubstSubstitution(null,o.id,o,t)]):[3,4];case 2:e.sent(),e.label=3;case 3:return s++,[3,1];case 4:r=0,a=n.add,e.label=5;case 5:return r<a.length?(o=a[r],[4,d.addSubstSubstitution(null,this.props.ttitemid,o,t)]):[3,8];case 6:e.sent(),e.label=7;case 7:return r++,[3,5];case 8:l=0,c=n.remove,e.label=9;case 9:return l<c.length?(u=c[l],[4,d.removeSubstSubstitution(null,u)]):[3,12];case 10:e.sent(),e.label=11;case 11:return l++,[3,9];case 12:return[2]}})})},s.prototype.ok=function(){return K.__awaiter(this,void 0,void 0,function(){return K.__generator(this,function(e){switch(e.label){case 0:return this.hasChanges()?[4,ASC.blockUI(this.writeChanges())]:(this.rdlg.close(),[2]);case 1:return e.sent(),this.rdlg.confirmClose(),barTrackEvent({eventCategory:"SubstOnline",eventAction:"SubstEditTTItemDlg.ok",eventLabel:""}),[2]}})})},s.npp=$.substOnlineNeededPartProvider(function(){return[$.buildSubstOnlineTTItemsEx,F.substTTItemComboItems,Q,{substonline_substitutions:["changes","cancelled","cancel_teacher","note","substitution_typeid"],periods:["period","starttime","endtime"]}]}),s);function s(e){var t=A.call(this,e)||this;t.rdlg=null;var n=e.dbi,s=e.select_change,i=n.rowData(x,e.ttitemid),r=K.__assign({},i.orig||$.coreOfTTItem(i));r.teacherids=K.__spreadArrays(r.teacherids),r.classroomids=K.__spreadArrays(r.classroomids);for(var a=K.__assign(K.__assign({},r),{teacherids:K.__spreadArrays(r.teacherids),classroomids:K.__spreadArrays(r.classroomids),classids:K.__spreadArrays(r.classids)}),o={absents:[],orig_row:r,row:a,cancelled:i.cancelled,teacherids_cancelled:[],substs:[]},l=[],c=0,u=i.substids;c<u.length;c++){var d=u[c],m=n.rowData(L,d);if(m.absent&&o.absents.push(m.absent),!$.subst_isTargetAbsent(m)&&(o.substs.push(m),l=$.mergeSubstChanges(l,$.substBasicChanges(m)),m.cancel_teacher))for(var p=0,b=m.changes;p<b.length;p++){var h=b[p];if("teachers"==$.changeColumn2table(h.column)&&h.old)for(var f=0;f<r.teacherids.length;f++)r.teacherids[f]==h.old&&(o.teacherids_cancelled[f]=!0)}}for(var g=0,_=i.cancelled?l:i.changes;g<_.length;g++){switch(w=(h=_[g]).column){case"subjectid":case"igroupid":a.subjectid=h.new||"";break;case"period":a.uniperiod=h.new||"";break;default:"teacherid"==w&&(w="teacherids");var v=r[w],y=a[w];if(h.old){for(f=0;f<v.length;f++)if(v[f]==(h.old||"")){y[f]=h.new||"";break}}else v.push(""),y.push(h.new)}}if(s){var w,E=!1,S=a[w=Y.DBITools.removeEs($.changeColumn2table(s.column))+"ids"],C=r[w];for(f=0;f<C.length;f++)if(C[f]==s.old){E=!0,S[f]=s.new;break}E||(s.old&&ASC.dieError("2580200144"),C.push(s.old||""),S.push(s.new||""))}return 0==o.substs.length&&o.substs.push({id:"",substitution_typeid:X(n,"classroomsupervision"==i.type?"classroomsupervision":"normal"),note:"",changes:[]}),t.state=o,t}function X(e,t){void 0===t&&(t="normal");for(var n=0,s=e.tableData("substitution_types");n<s.length;n++){var i=s[n];if(i.default_for==t)return i.id}return""}function Q(e){var t=e.dbi,n=e.ttitem,s=e.orig_row,i=e.row,r=e.teacherids_cancelled,a=e.prev_substs,o=e.cancelled,l=e.final,c=[],u=X(t,"classroomsupervision"==n.type?"classroomsupervision":"normal"),d=[],m=new Set,p=[],b=[],h="classroomsupervision"==n.type?"teacherid":"teacherids";if(!o){for(var f=a.filter(function(e){return!$.subst_isTargetAbsent(e)}).filter(function(e){return e.absent}).filter(function(e){return"classrooms"==$.absentGetTable(e.absent)}).map(function(e){return $.absentGetId(e.absent)}),g=0;g<i.teacherids.length;g++){var _=s.teacherids[g]||"";!(v=i.teacherids[g]||"")&&r[g]&&_&&m.add(_),v!=_&&d.push({column:h,old:_||void 0,new:v||void 0})}for(g=0;g<i.classroomids.length;g++){var v,y={column:"classroomids",old:(_=s.classroomids[g]||"")||void 0,new:(v=i.classroomids[g]||"")||void 0};0<=f.indexOf(_)?p.push(y):v!=_&&b.push(y)}i.subjectid!=s.subjectid&&b.push({column:"subjectid",old:s.subjectid,new:i.subjectid}),i.uniperiod!=s.uniperiod&&("period"!=Y.DBITools.typeOfUniPeriod(i.uniperiod)&&ASC.dieError("1066666158"),b.push({column:"period",old:s.uniperiod,new:i.uniperiod}))}for(var w=[],E=[],S=[],C=0,x=a;C<x.length;C++){var A=(B=x[C]).absent?$.absentGetTable(B.absent):"";"teachers"==A?w.push(B):"classrooms"==A?E.push(B):S.push(B)}for(var T=new Set,I=function(e){for(var t=0,n=e.changes;t<n.length;t++){var s=n[t];if("teachers"==$.changeColumn2table(s.column))return}for(var i=0,r=d;i<r.length;i++){s=r[i];if(!T.has(s)){e.changes.push(s),T.add(s),e.cancel_teacher=m.has(s.old);break}}},k=function(e){if(!(e.cancelled=o))for(var t=0,n=b;t<n.length;t++){var s=n[t];e.changes.push(s)}},D=function(){if(T.size<d.length)return!1;if((0<b.length||o)&&0==c.length)return!1;if(0==c.length){if(!l)return!1;var e=a[0];if(e&&(e.substitution_typeid||e.note))return!1}return!0},R=0,N=w;R<N.length;R++){var O=N[R],B=K.__assign(K.__assign({},O),{changes:[],cancelled:o});if(!o){for(var j=$.absentGetId(B.absent),M=!1,U=0,z=d;U<z.length;U++){(H=z[U]).old==j&&(T.add(H),B.changes.push(H),B.cancel_teacher=m.has(H.old),M=!0)}M||(ASC.logProblem("0897145113"),B.changes.push({column:h,old:j,new:j}))}k(B),c.push(B)}for(var P=0,F=E;P<F.length;P++){O=F[P],B=K.__assign(K.__assign({},O),{changes:[],cancelled:o});if(!o){for(var L=$.absentGetId(B.absent),G=(M=!1,0),q=p;G<q.length;G++){var H;(H=q[G]).old==L&&(B.changes.push(H),M=!0)}M||(ASC.logProblem("9288323371"),B.changes.push({column:"classroomids",old:L,new:L})),I(B)}k(B),c.push(B)}for(var V=0,W=S;V<W.length;V++){O=W[V];if(D())break;I(B=K.__assign(K.__assign({},O),{changes:[],cancelled:o})),k(B),c.push(B)}for(;!D();){I(B={id:"",date:n.date,substitution_typeid:u,note:"",changes:[],cancelled:o}),k(B),c.push(B)}return c}e.SubstEditTTItemDlg=n,Q.needed_part=Y.typed({substonline_substitutions:["absent","changes"],substitution_types:["default_for"]});var i,a=(i=z.Component,K.__extends(o,i),o.prototype.render=function(){var t=this,n=this.props.app,s=n.naming_dbi,e=n.getTTItems().filter(function(e){return!(e.cancelled||e.added)}).map(function(e){var t=e.orig||e,n=s.tools.ttitem_popis(t);return n.teacher=s.tools.ttitem_popis(t,B.client_req.sort_name_col).teacher,K.__assign(K.__assign({},n),{uniperiod:t.uniperiod,id:e.id})});function i(){var e=t.state.ttitemid;e?(t.rdlg.confirmClose(),barTrackEvent({eventCategory:"SubstOnline",eventAction:"ChangeOtherLessonDlg.change",eventLabel:""}),n.showTTItemEditDlg(e)):P.RDialog.showConfirm(ASC.ls(1574))}return e.sort(function(e,t){return parseInt(e.uniperiod)-parseInt(t.uniperiod)}),z.createElement(P.RDialog,{header:ASC.ttls(3794),width:700,height:600,ref:function(e){return t.rdlg=e},buttons:[{label:ASC.ttls(1054),type:"green",onClick:i},"cancel"]},z.createElement(r.RDatatable,{columns:[{key:"period",label:ASC.ls(1466),width:70,sortable:!0},{key:"teacher",label:ASC.ls(1300),width:130,sortable:!0},{key:"class",label:ASC.ls(1263),width:130,sortable:!0},{key:"subject",label:ASC.ls(1299),width:130,sortable:!0},{key:"classroom",label:ASC.ls(1197),width:80,sortable:!0}],data:e,style:{flex:"1 1 200px"},selectedIdRef:P.stateRef(this,"ttitemid"),fitWidth:!0,onRowDoubleClick:i}))},o.prototype.componentDidMount=function(){barTrackEvent({eventCategory:"SubstOnline",eventAction:"ChangeOtherLessonDlg.open",eventLabel:""})},o);function o(e){var t=i.call(this,e)||this;return t.rdlg=null,t.state={ttitemid:""},t}function ee(e){var t=e.table,n=e.valueRef,s=e.ttitemid,i=e.dbi,r=e.tt_dbi,a=e.join_doubles,o=s.split(":")[0],l=z.useState(n.read())[0],c=z.useState(""),u=c[0],d=c[1];return z.createElement(P.RDialog,{appFullScreen:!0,width:400,height:600,buttons:["ok","cancel"],onConfirm:function(e){n.write(u),e.confirmClose()}},z.createElement(m.TeachersView,{dbi:i,tt_dbi:r,date:o,join_doubles:a,ttitemid:s,table:t,topid:l,uiSettings:{grid_mode:"periods",kriteria_cols:[]},onRowSelect:function(e){return d(e)}}))}e.ChangeOtherLessonDlg=a,e._hotswap=[ee]}),ASC.setModuleSourceFunc("/substitution/commands.js",function(e,require,t){e.__esModule=!0;var o=require("tslib"),n=require("../rpr/dbi"),a=require("react"),l=require("../asc/asc_react"),c=require("../asc/actions"),u=require("./server/commands"),i=require("../asc/edurequest"),r=i.client_req&&i.client_req.isApp()?"SubstApp":"SubstOnline";function d(s,i){return o.__awaiter(this,void 0,void 0,function(){var t,n;return o.__generator(this,function(e){return(t=s.rowData("substonline_dates",i))||ASC.dieError("3637166007"),t.uploaded_int?(n=a.createRef(),l.RDialog.showMessage(ASC.ls(2740),{footer:a.createElement(a.Fragment,null,a.createElement(l.RButton,{label:ASC.ls(2741),onClick:function(){n.current.close(),m(i)}})),width:350,ref:n}),[2,!0]):[2,!1]})})}function m(s){return o.__awaiter(this,void 0,void 0,function(){var t,n;return o.__generator(this,function(e){switch(e.label){case 0:return t=i.client_req,n=t.ls(2741)+" ("+t.lib_date.date_format_date(s)+") - "+t.ls(1054),[4,l.RDialog.showConfirm(n)];case 1:return e.sent()?[4,u.deleteSubstDay(null,s,{log_module:r})]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2]}})})}function s(r,a){return o.__awaiter(this,void 0,void 0,function(){var t,n,s,i;return o.__generator(this,function(e){switch(e.label){case 0:return t=r.req,n=a.split(":")[0],[4,d(r,n)];case 1:return e.sent()?[2,!1]:(s=r.rowData("substonline_absents",a),i=t.ttls(2117),s&&"teachers"!=s.table&&(i=c.action_name("delete")+" - "+t.ls(1054)),[4,l.RDialog.showConfirm(i)]);case 2:return e.sent()?[4,u.removeAbsent(null,a)]:[2,!1];case 3:return e.sent(),[2,!0]}})})}function p(s,i,r){return o.__awaiter(this,void 0,void 0,function(){var t,n;return o.__generator(this,function(e){switch(e.label){case 0:return t=s.req,(n=s.rowData("substonline_substitutions",i))||ASC.dieError("5944750757"),n.absent?[4,l.RDialog.show(t.ttlsf(3198,{s:n.absent.name}))]:[3,2];case 1:return e.sent(),[2,!1];case 2:return[4,l.RDialog.showConfirm(a.createElement(a.Fragment,null,t.ls(1054)))];case 3:return e.sent()?[4,u.removeSubstSubstitution(null,i,r)]:[2,!1];case 4:return e.sent(),[2,!0]}})})}(e.checkUploaded=d).npp=n.neededPartProvider(function(){return[m,{substonline_dates:["uploaded_int"]}]}),(e.showDayDeleteDlg=m).needed_part=n.typed({}),(e.showAbsentDeleteDlg=s).npp=n.neededPartProvider(function(){return[d,{substonline_absents:["table"]}]}),(e.showSubstDeleteDlg=p).needed_part=n.typed({substonline_substitutions:["absent"]})}),ASC.setModuleSourceFunc("/substitution/viewerAdmin.js",function(e,require,t){e.__esModule=!0;var a=require("tslib"),o=require("react"),l=require("./online/report"),c=require("../asc/asc_react"),u=require("./viewer"),r=require("../asc/edurequest"),d=require("./server/viewer"),m=require("../asc/asc_react2"),p=require("../customize/privacy");function i(e){var t=e.settingsRef,n=e.dbi,s=e.type,i=r.client_req;return o.createElement("div",{style:{flex:1}},o.createElement(m.ModuleHeader,{title:i.localize(l.substReportTypeName[s]),icon:n.table(s).icon(),small:!0}),o.createElement(c.RLabel,{text:i.ls(1671)+":"}),o.createElement(c.RComboBox,{items:p.privacyCombo2(i),valueRef:c.subRef(t,"privacy")}),o.createElement(c.VGap,{height:20}),o.createElement("div",{style:"disabled"==t.read().privacy?{visibility:"hidden"}:{}},o.createElement(l.SubstReportSettingsDiv,{settingsRef:c.subRef(t,"settings"),type:s})))}function b(e){var t=e.settingsRef,n=e.dbi,s=r.client_req;return o.createElement(o.Fragment,null,o.createElement("div",{style:{display:"flex",flexDirection:"row",position:"relative"}},o.createElement(i,{settingsRef:c.subRef(t,"classes"),type:"classes",dbi:n}),o.createElement(m.VSeparatorLine,{height:"auto",style:{alignSelf:"stretch"}}),o.createElement(i,{settingsRef:c.subRef(t,"teachers"),type:"teachers",dbi:n})),o.createElement(m.SeparatorLine,null),o.createElement("div",null,o.createElement(c.RLabel,{text:s.ls(2206)+":",style:{width:"auto"}}),o.createElement(c.HGap,{width:10}),o.createElement(c.RComboBox,{items:function(e,t){void 0===t&&(t=31);for(var n=[{value:"-1",name:e.ls(1349)},{value:"-2",name:e.ls(3146)},[]],s=0;s<=t;s++)n.push({value:""+s,name:e.lsf(2261,{n:s})});return n}(s),valueRef:c.castRef(c.subRef(t,"past_limit_days"),function(e){return""+e},function(e){return parseInt(e)})})))}function h(){return a.__awaiter(this,void 0,void 0,function(){var t,n,s,i;return a.__generator(this,function(e){switch(e.label){case 0:return t=r.client_req,[4,ASC.loadTTLang()];case 1:return e.sent(),[4,d.getSubstViewerSettings(null)];case 2:return n=e.sent(),[4,t.maindbi(t.getSchoolYear(),{tables:["teachers","subjects","classes","classrooms","absent_types","substitution_types"],columns:["short","name"],info_columns:["__name"]})];case 3:return s=e.sent(),[4,c.RDialog.showInput({settings:n},function(e){var t=c.subRef(e.stateRef,"settings");return o.createElement(b,a.__assign({},{settingsRef:t,dbi:s}))},{header:ASC.ls(1003)+" - "+ASC.ls(1932)+" - "+ASC.ls(1637),width:800})];case 4:return(i=e.sent())?[4,d.setSubstViewerSettings(null,i.settings)]:[2,!1];case 5:return e.sent(),[2,!0]}})})}e.SubstViewerAdmin=function(e){var t=o.useState(0),n=t[0],s=t[1];function i(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return[4,h()];case 1:return e.sent()&&s(function(e){return e+1}),[2]}})})}var r=c.useReq();return o.createElement(c.RScopedStyle,{rules:l.EditSettingsBtn.rules,style:{position:"relative"},className:"SubstViewerAdmin"},o.createElement("div",{className:"messageBox customize",style:{marginBottom:5}},o.createElement(c.HGap,{width:8}),o.createElement(c.RButton,{label:r.ls(2339),type:"green",onClick:function(){return i()}}),o.createElement(c.HGap,{width:8}),o.createElement(c.RButton,{label:r.ls(2340),type:"green",onClick:function(){return document.location.href="/substitution/online.php"}})),o.createElement(l.EditSettingsBtn,{onClick:function(){return i()}}),o.createElement(u.SubstViewer,a.__assign({},a.__assign(a.__assign({},e),{refresh:n}))))},e.showSubstViewerAdminSettingsDlg=h,e._hotswap=[i,b]}),ASC.setModuleSourceFunc("/substitution/online/report.js",function(p,require,e){p.__esModule=!0;var k=require("tslib"),D=require("react"),f=require("react-dom"),x=require("../../dashboard/printSheet"),R=require("../subst"),A=require("../../rpr/dbi"),E=require("../../asc/asc_react"),T=require("./leftpanel"),S=require("../../dashboard/dbi_events"),a=require("../../rpr/dbi_react"),C=require("../../asc/lib_date"),g=require("../server/report"),N=require("../../asc/asc_react2"),I=require("../../timetable/ttitem");function s(e,t){return{names_teachers:e.sort_name_col,names_classes:"name",names_classrooms:"name",names_subjects:"name",names_igroups:"classes"==t?"hide":"name",names_absent_types:"hide",names_substitution_types:"hide",show_signatures:"",show_absents:"absent",show_time:!1,hideabsentteacher:"classes"==t&&"de/th"==e.school_country,absent_summary_teachers:!1,absent_summary_classes:!1,absent_summary_classrooms:!1,pagebreak_date:!0,change_format:"",style:""}}p.substReportTypeName={teachers:"{1929}",classes:"{1930}"},p.substReportTypes=[{type:"teachers",name:p.substReportTypeName.teachers},{type:"classes",name:p.substReportTypeName.classes}],p.substReportDefaultSettings=s;var o=[{value:"",name:ASC.ls(1858)},{value:"compact",name:ASC.ls(4953)},{value:"compact_extra",name:ASC.ls(4953)+" (Extra)"},{value:"bars",name:ASC.ls(8996)},{value:"table",name:ASC.ls(1891)}];ASC.asc&&(o.push([]),o.push({value:"mobile",name:ASC.ls(6950)+" (aSc)"}));var l=[{value:"",name:"-"},{value:"subst_day",name:ASC.ls(1003)+" - "+ASC.ls(1465)},{value:"subst_lesson",name:ASC.ls(1003)+" - "+ASC.ls(1301)}],c=[{value:"",name:"-"},{value:"absent",name:ASC.ls(1846)},{value:"absent_lesson",name:ASC.ls(1846)+" + "+ASC.ls(1460)}],u=[{value:"",name:ASC.req.localize("{1858} - {2323}")},{value:"ss",name:ASC.req.localize("{2324}")}],O=100,B="---";function h(e){return{TABLE_ttitems:e?"substonline_ttitems":"subst_ttitems",TABLE_substs:e?"substonline_substitutions":"subst_substitutions",TABLE_absents:e?"substonline_absents":"subst_absents",TABLE_dates:e?"substonline_dates":"subst_dates"}}function _(n){return k.__awaiter(this,void 0,void 0,function(){var t;return k.__generator(this,function(e){switch(e.label){case 0:return t=[k.__assign(k.__assign({},n),h(n.unpublished))],[4,function(b){return k.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a,o,l,c,u,d,m,p;return k.__generator(this,function(e){switch(e.label){case 0:return t=b.req,n=b.unpublished,s=b.dates,i=s[0],r=s[s.length-1],a=h(n),[4,t.maindbi(t.getSchoolYear(i),{tables:[a.TABLE_dates,a.TABLE_absents,a.TABLE_substs,a.TABLE_ttitems,"absent_types","substitution_types","subjects","teachers","classes","classrooms","igroups","periods","dayparts","events","event_types"],columns:k.__spreadArrays(R.SubstApp_maindbi_needed_columns,["nameprefix","namesuffix","privacy","dp","noclassallclasses","categoryid","is_online","buildingid","studentids","tt_num","subst_dbi","attachevent","ttcancel"]),info_tables:["students"],info_columns:["__name"],vt_filter:{datefrom:i,dateto:r}})];case 1:o=e.sent(),u=c=null,d=0,m=(l=o).tableData(a.TABLE_dates),e.label=2;case 2:return d<m.length?(p=m[d],c||!p.tt_num?[3,4]:[4,t.timetabledbi(p.tt_num,{tables:["classes","teachers","classrooms","subjects"],columns:["name","short","firstname","lastname"]})]):[3,7];case 3:c=e.sent(),e.label=4;case 4:return u||!p.subst_dbid?[3,6]:[4,t.substdbi(p.subst_dbid,{tables:["classes","teachers","classrooms","subjects","absent_types","substitution_types"],columns:["name","short"]})];case 5:u=e.sent(),e.label=6;case 6:return d++,[3,2];case 7:return u&&(l=c||u?new A.MergeDBI(o,c,u):o),[2,{dbi:l,main_dbi:o,tt_dbi:c,subst_dbi:u}]}})})}(n)];case 1:return[2,k.__assign.apply(void 0,[k.__assign.apply(void 0,t.concat([e.sent()])),{settings:n.settings||s(n.req,n.type)}])]}})})}function v(e){return D.createElement("a",{className:"editSettings",onClick:e.onClick},D.createElement("i",{className:"fa fa-fw fa-pencil"}))}function y(e){var n=e.settingsRef,s=e.type,t=e.multidate,i=E.useReq();E.useTTLang();var r=a.useMainDBI(e.year||i.getSchoolYear(),{needed_part:{teachers:[],subjects:[],classes:[],classrooms:[],igroups:[],absent_types:[],substitution_types:[]}});return D.createElement("div",null,D.createElement(E.RLabel,{text:i.ls(1353)+":"}),D.createElement(E.RComboBox,{valueRef:E.subRef(n,"style"),items:o}),D.createElement(E.VGap,{height:10}),D.createElement(N.RGroupBox,{title:i.ls(6473)},["teachers","subjects","classes","igroups","classrooms","absent_types","substitution_types"].map(function(e){if("classes"==s&&0<=["absent_types","substitution_types"].indexOf(e))return null;var t=!1;return 0<=["absent_types","substitution_types"].indexOf(e)&&(t=!0),"classes"==s&&("teachers"!=e&&"igroups"!=e||(t=!0)),D.createElement(E.Fragment,{key:e},D.createElement(E.RLabel,{text:r.table(e).name()+":"}),D.createElement(a.DBINameColInput,{valueRef:E.subRef(n,"names_"+e),table:e,allowHide:t}),D.createElement("br",null))}),D.createElement(E.VGap,{height:10}),D.createElement(E.RLabel,{text:i.ls(1622)+" - "+i.ls(1489)+":"}),D.createElement(E.RComboBox,{valueRef:E.subRef(n,"show_absents"),items:c}),D.createElement(E.VGap,{height:10}),D.createElement(E.RLabel,{text:i.ls(2325)+":"}),D.createElement(E.RComboBox,{valueRef:E.subRef(n,"change_format"),items:u})),D.createElement(E.VGap,{height:10}),D.createElement(N.RGroupBox,{title:i.ls(1363)+" - "+i.ls(1898)},["teachers","classes","classrooms"].map(function(e){return D.createElement(E.Fragment,{key:e},D.createElement(E.RCheckBox,{label:i.localize(ce[e]),valueRef:E.subRef(n,"absent_summary_"+e)}),D.createElement("br",null))})),"teachers"==s&&D.createElement(D.Fragment,null,D.createElement(E.VGap,{height:10}),D.createElement(E.RLabel,{text:i.ls(2694)+":"}),D.createElement(E.RComboBox,{valueRef:E.subRef(n,"show_signatures"),items:l})),"classes"==s&&D.createElement(D.Fragment,null,D.createElement(E.VGap,{height:10}),D.createElement(E.RCheckBox,{valueRef:E.subRef(n,"hideabsentteacher"),label:i.ls(2074)}),D.createElement("br",null)),D.createElement(E.VGap,{height:10}),D.createElement(E.RLabel,{text:i.ls(1345)+":"}),D.createElement(E.RCheckBox,{label:i.ls(1489),valueRef:E.subRef(n,"show_time")}),t&&D.createElement(D.Fragment,null,D.createElement(E.VGap,{height:10}),D.createElement(E.RCheckBox,{valueRef:E.subRef(n,"pagebreak_date"),label:i.ls(3157)})))}p.substReportScope=_,p.showSubstReportDlg=function(o){return k.__awaiter(this,void 0,void 0,function(){var t,n,s,i,r,a;return k.__generator(this,function(e){switch(e.label){case 0:return n=(t=E.RDialog).show,i=(s=D).createElement,r=[d],a={},[4,_(o)];case 1:return n.apply(t,[i.apply(s,r.concat([(a.scope=e.sent(),a)]))]),[2]}})})},(p.EditSettingsBtn=v).rules=A.typed({"a.editSettings":{display:"none",padding:"0.25em",backgroundColor:"rgba(0,0,0,0.4)",color:"#fff",cursor:"pointer",margin:"1px",textDecoration:"none",position:"absolute",right:0,top:0},"$:hover a.editSettings":{display:"block"}}),p.SubstReportInReportovac=function(e){var t=this,n=D.useState(null),s=n[0],r=n[1],i=D.useState(0),a=i[0],o=i[1],l=e.dates,c=e.reportid,u=e.subst_unpublished,d=e.buildingid,m=E.useReq(),p=c.split("_")[1],b=E.useAsyncMemo(function(){return k.__awaiter(t,void 0,void 0,function(){var t,n;return k.__generator(this,function(e){switch(e.label){case 0:return t=_,n={req:m,type:p,unpublished:u,buildingid:d,dates:l},[4,g.getSubstReportInReportovacSettings(m,p)];case 1:return[4,t.apply(void 0,[(n.settings=e.sent(),n)])];case 2:return[2,e.sent()]}})})},[p,u,l.join(),d,a],null,[a]);function h(){return k.__awaiter(this,void 0,void 0,function(){var t,n,s,i;return k.__generator(this,function(e){switch(e.label){case 0:return t=b.settings,n=b.dbi,s=b.dates,[4,E.RDialog.showInput({settings:t},function(e){var t=E.castRef(E.subRef(e.stateRef,"settings"),function(e){return e},function(e){return r(e),e});return D.createElement(y,{settingsRef:t,type:p,year:parseInt(n.dbid),multidate:1<s.length})},{header:m.ls(1637),width:400})];case 1:return(i=e.sent())?[4,g.setSubstReportInReportovacSettings(null,p,i.settings)]:[3,3];case 2:return e.sent(),r(null),o(function(e){return e+1}),[3,4];case 3:r(null),e.label=4;case 4:return[2]}})})}return b?D.createElement(E.RAutoUnmount,null,D.createElement(E.RScopedStyle,{className:"SubstReportInReportovac",rules:v.rules,style:{position:"relative"},ref:function(e){e&&(f.findDOMNode(e)._editSettings=function(){return h()})}},D.createElement(v,{onClick:function(){return h()}}),D.createElement(de,k.__assign({},k.__assign(k.__assign({},b),{settings:s||b.settings}))))):D.createElement(E.Loading,null)},p.showSubstReportInReportovacSettings=function(s){return k.__awaiter(this,void 0,void 0,function(){var t,n;return k.__generator(this,function(e){return t=$j(s).find(".SubstReportInReportovac").first(),(n=t.get(0))&&n._editSettings(),[2]})})},p.SubstReportSettingsDiv=y;var n,d=(n=D.Component,k.__extends(t,n),t.prototype.render=function(){var e=this,t=this.props.scope,i=t.type,r=t.req,n=this.state.settings;return D.createElement(x.PrintSheet,{renderer:function(){return null},asDialog:!0,filename:r.ls(1003),onCustomize:function(){return k.__awaiter(e,void 0,void 0,function(){var t,n,s=this;return k.__generator(this,function(e){switch(e.label){case 0:return t=this.state.settings,[4,E.RDialog.showInput({settings:t},function(e){var t=E.castRef(E.subRef(e.stateRef,"settings"),function(e){return e},function(e){return s.setState({settings:e}),e});return D.createElement(y,k.__assign({},{settingsRef:t,type:i}))},{header:r.ls(1637),width:400})];case 1:return n=e.sent(),this.setState({settings:n?n.settings:t}),[2]}})})}},D.createElement(de,k.__assign({},k.__assign(k.__assign({},t),{settings:n}))))},t.prototype.componentDidMount=function(){barTrackEvent({eventCategory:"SubstPrintSheet",eventAction:"SubstPrintSheet.open",eventLabel:""})},t);function t(e){var t=n.call(this,e)||this;return t.state={settings:e.scope.settings},t}var j=["public","students","participants","participants+teachers"],M="/global/pics/ui/absent_32.svg",U="/global/pics/ui/events_32.svg";function z(e){return D.isValidElement(e)?e.type==N.RJoin&&0==D.Children.count(e.props.children):""==e||null==e||null==e||"boolean"==typeof e}function P(e){var t=e.scope,n=e.uniperiod,s=e.data,i=e.what,r=e.info,a=e.info_detail,o=e.className,l=e.show_signature,c=t.settings,u=t.dbi,d=t.timeProvider,m=t.req,p=c.show_time,b="",h="";switch(o){case"event":b=U;break;case"event_absent":b=U,h=M;break;case"absent":b=M}var f="remove"==o,g=u.tools.uniperiodName(n,void 0,s);f&&(g="("+g+")");var _="";if(p&&!f&&0<=["period","break"].indexOf(A.DBITools.typeOfUniPeriod(n))){var v=s||{},y=d.provide({uniperiod:n,classids:v.classids||[],endtime:v.endtime||"",durationperiods:v.durationperiods||null});if(y){var w=function(e){return m.lib_date.date_format_time0(e,{ajSekundy:!1,short:!0})};_=w(y.starttime)+"-"+w(y.endtime)}}var E=g,S=null;b&&(S=D.createElement("img",{src:b,style:{height:16,display:"inline-block",verticalAlign:"text-bottom",marginRight:5}}),h&&(S=D.createElement("span",{style:{position:"relative"}},S,D.createElement("img",{src:h,style:{height:10,display:"block",position:"absolute",left:8,bottom:-1}}))));var C=D.createElement(D.Fragment,null,_&&D.createElement(D.Fragment,null,_,", "),S,i,!z(i)&&!z(r)&&" - ",r);return"table"==c.style?D.createElement(D.Fragment,null,D.createElement("td",{className:"period"},D.createElement(x.PrintFontResizable,null,E)),p&&D.createElement("td",{className:"time"},D.createElement(x.PrintFontResizable,null,_)),D.createElement("td",{className:"what"},D.createElement(x.PrintFontResizable,null,S,i)),D.createElement("td",{className:"info"},D.createElement(x.PrintFontResizable,null,r)),"subst_lesson"==c.show_signatures&&D.createElement("td",{className:"signature"},l||B)):D.createElement("div",{className:"row "+o},D.createElement("div",{className:"period"},D.createElement(x.PrintFontResizable,null,E)),D.createElement("div",{className:"info"},D.createElement(x.PrintFontResizable,null,C,l&&D.createElement(Z,null),a&&D.createElement("div",{className:"detail"},a))))}function F(e){var t=e.scope,n=e.old,s=e.new,i=e.prefix;return n==s?D.createElement(D.Fragment,null,i,s):n?"ss"==t.settings.change_format?D.createElement(D.Fragment,null,i,D.createElement("s",null,n),s&&D.createElement(D.Fragment,null," âž” ",s)):D.createElement(D.Fragment,null,i,"(",n,")",s&&D.createElement(D.Fragment,null," âž” ",s)):s?D.createElement(D.Fragment,null,i,"+",s):null}function L(e){var t=e.scope,n=e.infos,s=e.ttitem,i=e.orig,r=e.col,a=e.ignoreid,o=e.force_show,l=t.dbi,c=t.settings,u=t.req,d=c.hideabsentteacher,m=R.changeColumn2table(r);if(!m)throw ASC.dieError("9561628993");var p=c["names_"+m];if("teachers"!=m||"hide"!=p){var b=new Set,h=!!o;if(!A.idsArrayMatchI(s[r],i[r]))if(s.added&&0==i[r].length)h=!0;else for(var f=0,g=s.changes;f<g.length;f++){var _=g[f];if(R.changeColumn2table(_.column)==m&&(!a||_.old!=a&&_.new!=a))if(_.new){if(_.old)if("teachers"==m&&d)n.push(u.ls(1003)+": "+l.rowName(m,_.new,p));else{var v="?";"teachers"==m&&(v=u.ls(1003),"mobile"==c.style&&(v="")),"classrooms"==m&&(v=u.ls(1895)),n.push(D.createElement(F,{scope:t,prefix:v&&v+": ",old:l.rowName(m,_.old,p),new:l.rowName(m,_.new,p),key:""+n.length}))}else n.push(D.createElement(F,{scope:t,new:l.rowName(m,_.new,p),key:""+n.length}));b.add(_.new)}else if(_.old)if("teachers"==m&&d)if(0==s.teacherids.length){var y=u.ttls(3118);n.indexOf(y)<0&&n.push(y)}else n.push(D.createElement(F,{scope:t,old:u.ls(3356),key:""+n.length}));else n.push(D.createElement(F,{scope:t,old:l.rowName(m,_.old,p),key:""+n.length}))}if(h){var w=s[r];w=w.filter(function(e){return!b.has(e)}),a&&(w=w.filter(function(e){return e!=a})),w.length&&n.push(l.tools.itemName(m,w.length)+": "+l.rowNames(m,w,p))}}else A.idsArrayMatchI(s[r],i[r])||n.push(u.ls(1003))}function G(e){var t=e.infos,n=e.scope,s=e.ttitem,i=e.orig,r=n.dbi,a=n.settings,o=n.req,l=A.idsArrayDiff(i.classids,s.classids);0<l.length&&t.push("("+o.ttls(2825)+" "+r.rowNames("classes",l,a.names_classes)+")")}function q(e){var t=e.infos,n=e.scope,s=e.ttitem,i=e.orig,r=n.dbi,a=n.req;A.idsArrayMatchI(s.groupnames,i.groupnames)||t.push(D.createElement(F,{scope:n,prefix:a.ls(6964)+": ",old:r.tools.groupnames_names(i.groupnames),new:r.tools.groupnames_names(s.groupnames),key:""+t.length}))}function H(e){for(var t=e.infos,n=e.scope,s=e.ttitem,i=n.dbi,r=n.TABLE_substs,a=n.req,o="",l=0,c=[7442,7443];l<c.length;l++)for(var u=c[l],d=a.lsf(u,{date:""}).trim(),m=0,p=t;m<p.length;m++){var b=p[m];if("string"==typeof b&&0<=b.indexOf(d)){o=d;break}}for(var h=0,f=s.substids;h<f.length;h++){var g=f[h],_=i.rowData(r,g);if(_){var v=_.note;o&&0<=v.indexOf(o)&&v.length<=o.length+8&&(v=""),v&&t.indexOf(v)<0&&t.push(v)}}}function V(e){var t=e.infos,n=e.ttitem,s=e.scope,i=s.dbi,r=s.date,a=s.req,o="";if(n.cancelled&&0<n.origofids.length){var l=n.origofids[0].split(":")[0];if(l!=r)o=a.lsf(7442,{date:a.lib_date.date_format_day(l,!1,!0)});else for(var c=0,u=n.changes;c<u.length;c++){var d=u[c];"period"==d.column&&d.new&&(o=a.lsf(9701,{period:i.rowName("periods",d.new)}))}}return!!o&&(t.push(o),!0)}function m(e){var t=e.scope,n=e.ttitem,s=t.dbi,i=t.teacherid,r=t.classid,a=t.absents,o=t.TABLE_substs,l=i?"teachers":"classes",c=i||r;if(!c)return!1;if(0<=R.substTTItem_tableIds(n,l).indexOf(c))return!1;for(var u=0,d=n.substids;u<d.length;u++){var m=d[u],p=s.rowData(o,m);if(p)if((f=p.absent)&&R.absentGetTable(f)==l&&R.absentGetId(f)==c)return!0}if(n.cancelled&&"teachers"==l)for(var b=0,h=a;b<h.length;b++){var f=h[b];if(R.absentGetTable(f)==l&&R.absentGetId(f)==c){if(f.allday)return!0;if(f.period&&"period"==A.DBITools.typeOfUniPeriod(n.uniperiod)){var g=parseInt(f.period),_=g+(f.durationperiods||1)-1,v=parseInt(n.uniperiod);if(g<=v&&v<=_)return!0}}}return!1}function W(e){var t=e.infos,n=e.ttitem,s=e.scope,i=s.dbi,r=s.date,a=s.req,o="";if(n.origsubstid){var l=n.origsubstid.split(":")[0];if(l!=r)o=a.lsf(7443,{date:a.lib_date.date_format_day(l,!1,!0)});else for(var c=0,u=n.changes;c<u.length;c++){var d=u[c];"period"==d.column&&d.old&&(o=a.lsf(9702,{period:i.rowName("periods",d.old)}))}}return!!o&&(t.push(o),!0)}function b(e,t){var n=e.dbi,s=e.buildingid;if(!s)return!0;for(var i=!1,r=0,a=t;r<a.length;r++){var o=a[r],l=n.rowData("classrooms",o);if(l){if(l.buildingid==s)return!0;i=!0}}return!i}function w(e,t){if(!e.buildingid)return!0;var n=t.classroomids;return t.orig&&(n=k.__spreadArrays(n,t.orig.classroomids)),b(e,n)}function K(e){var t=e.scope,n=e.ttitem,s=t.dbi,i=t.settings,r=t.classid,a=t.req,o=n.orig||n,l="",c="";if(A.idsArrayMatchI(n.groupnames,o.groupnames)||n.cancelled){var u="",d=n.groupnames.length?n.groupnames:o.groupnames;A.DBITools.groupnamesIsEntireClass(d)||(u=s.tools.groupnames_names(d)),u&&("mobile"==i.style?l=u:c=u+": ")}var m=D.createElement(F,{scope:t,prefix:c,old:s.rowName("subjects",o.subjectid||n.subjectid,i.names_subjects),new:s.rowName("subjects",n.subjectid||o.subjectid,i.names_subjects)}),p=[],b="";return n.classids.indexOf(r)<0||n.cancelled?(V({infos:p,scope:t,ttitem:n})||p.push(a.ls(2322)),b="remove"):(n.added?(W({infos:p,scope:t,ttitem:n})||p.push(a.ls(6270)),b="add"):0<n.changes.length&&(b="change"),L({scope:t,infos:p,ttitem:n,orig:o,col:"teacherids"}),L({scope:t,infos:p,ttitem:n,orig:o,col:"classroomids"}),G({infos:p,scope:t,ttitem:n,orig:o}),q({infos:p,scope:t,ttitem:n,orig:o})),H({infos:p,scope:t,ttitem:n}),0==p.length&&p.push(a.ls(2252)),D.createElement(P,k.__assign({},{scope:t,uniperiod:n.uniperiod,data:n,className:b,what:m,info:D.createElement(N.RJoin,{children:p,glue:", "}),info_detail:l}))}function Y(e){var t=e.scope,n=e.ttitem,s=t.dbi,i=t.settings,r=t.req,a=n.orig||n,o="";if(A.idsArrayMatchI(n.groupnames,a.groupnames)||n.cancelled){var l=n.groupnames.length?n.groupnames:a.groupnames;A.DBITools.groupnamesIsEntireClass(l)||(o=s.tools.groupnames_names(l)+": ")}var c=D.createElement(F,{scope:t,prefix:o,old:s.rowName("subjects",a.subjectid||n.subjectid,i.names_subjects),new:s.rowName("subjects",n.subjectid||a.subjectid,i.names_subjects)}),u=[],d="";return!n.igroupid||n.cancelled?(V({infos:u,scope:t,ttitem:n})||u.push(r.ls(2322)),d="remove"):(n.added?(W({infos:u,scope:t,ttitem:n})||u.push(r.ls(6270)),d="add"):0<n.changes.length&&(d="change"),L({scope:t,infos:u,ttitem:n,orig:a,col:"teacherids"}),L({scope:t,infos:u,ttitem:n,orig:a,col:"classroomids"})),H({infos:u,scope:t,ttitem:n}),0==u.length&&u.push(r.ls(2252)),D.createElement(P,k.__assign({},{scope:t,uniperiod:n.uniperiod,data:n,className:d,what:c,info:D.createElement(N.RJoin,{children:u,glue:", "})}))}function $(e){var t=e.scope,n=e.ttitem,s=t.dbi,i=t.settings,r=t.teacherid,a=t.TABLE_substs,o=t.req,l=n.orig||n,c="";if("classroomsupervision"==n.type)c=o.ls(1723)+": "+s.rowNames("classrooms",l.classroomids,i.names_classrooms);else{var u=void 0,d=n.cancelled?l:n;u=d.igroupid?s.rowName("igroups",d.igroupid,i.names_igroups):s.tools.ttitem_popis(d,i.names_classes).class,c=D.createElement(F,{scope:t,prefix:u+": ",old:s.rowName("subjects",l.subjectid||n.subjectid,i.names_subjects),new:s.rowName("subjects",n.subjectid||l.subjectid,i.names_subjects)})}var m=[],p="",b=!1;if(n.cancelled)V({infos:m,scope:t,ttitem:n})||m.push(o.ls(2322)),p="remove";else if(n.teacherids.indexOf(r)<0){for(var h=!1,f=0,g=n.changes;f<g.length;f++){var _=g[f];"teachers"==R.changeColumn2table(_.column)&&_.old==r&&(h=!0,_.new?m.push(o.ttls(1481)+": "+s.rowName("teachers",_.new,i.names_teachers)):m.push(o.ttls(1481)+": "+o.ttls(3118)))}h||m.push("Error9952969758"),p="remove"}else{if(b=!0,n.added)W({infos:m,scope:t,ttitem:n})||m.push(o.ls(6270)),p="add";else{0<n.changes.length&&(p="change");for(var v=0,y=n.changes;v<y.length;v++){_=y[v];if("teachers"==R.changeColumn2table(_.column)&&_.new==r){var w=o.ls(1003);_.old&&(w=o.ls(8987)+": "+s.rowName("teachers",_.old,i.names_teachers)),m.push(w)}}}for(var E=0,S=n.substids;E<S.length;E++){var C=S[E],x=s.rowData(a,C);if(x){for(var A=!1,T=0,I=x.changes;T<I.length;T++){_=I[T];if("teachers"==R.changeColumn2table(_.column)&&_.new==r){A=!0;break}}A&&x.substitution_typeid&&"hide"!=i.names_substitution_types&&m.push(o.ls(1619)+": "+s.rowName("substitution_types",x.substitution_typeid,i.names_substitution_types))}}L({scope:t,infos:m,ttitem:n,orig:l,col:"teacherids",ignoreid:r}),L({scope:t,infos:m,ttitem:n,orig:l,col:"classroomids",force_show:l.teacherids.indexOf(r)<0}),G({infos:m,scope:t,ttitem:n,orig:l}),q({infos:m,scope:t,ttitem:n,orig:l})}return H({infos:m,scope:t,ttitem:n}),0==m.length&&m.push(o.ls(2252)),D.createElement(P,k.__assign({},{scope:t,uniperiod:n.uniperiod,data:n,className:p,show_signature:b&&"subst_lesson"==i.show_signatures,what:c,info:D.createElement(N.RJoin,{children:m,glue:", "})}))}function Z(e){return D.createElement("div",{className:"signature"},"Â ")}function J(e){var t=e.scope,n=e.event,s=e.absent,i=t.dbi,r=t.settings,a=t.req,o=[],l=[],c="";if(o.push(T.eventName(i,n)),0==n.groupnames.length)0<n.studentids.length&&o.push(a.ls(6253));else if(!A.DBITools.groupnamesIsEntireClass(n.groupnames)){var u=i.tools.groupnames_names(n.groupnames);"mobile"==r.style?c=u:o.push(u)}return n.subjectid&&l.push(i.rowName("subjects",n.subjectid)),0<n.classids.length&&!A.idsArrayMatchI(n.classids,[t.classid])&&l.push(i.rowNames("classes",n.classids,r.names_classes)),0<n.teacherids.length&&!A.idsArrayMatchI(n.teacherids,[t.teacherid])&&"hide"!=r.names_teachers&&l.push(i.rowNames("teachers",n.teacherids,r.names_teachers)),0<n.classroomids.length&&l.push(i.tools.itemName("classrooms",n.classroomids.length)+": "+i.rowNames("classrooms",n.classroomids,r.names_classrooms)),s&&s.absent_typeid&&"hide"!=r.names_absent_types&&l.push(a.ttls(1464)+": "+i.rowName("absent_types",s.absent_typeid,r.names_absent_types)),D.createElement(P,k.__assign({},{scope:t,uniperiod:A.DBITools.getUniPeriod(n),data:n,className:s?"event_absent":"event",what:o.join(", "),info:D.createElement(N.RJoin,{children:l,glue:", "}),info_detail:c}))}function X(e){var t=e.scope,n=e.absent,s=t.dbi,i=t.settings,r=t.req,a=[],o=[],l="",c=r.ls(1846);return"classes"==t.type&&n.groupname&&("mobile"==i.style?l=n.groupname:c=n.groupname+": "+c),a.push(c),n.absent_typeid&&"hide"!=i.names_absent_types&&o.push(r.ttls(1464)+": "+s.rowName("absent_types",n.absent_typeid,i.names_absent_types)),D.createElement(P,k.__assign({},{scope:t,uniperiod:A.DBITools.getUniPeriod(n),data:n,className:"absent",what:a.join(", "),info:D.createElement(N.RJoin,{children:o,glue:", "}),info_detail:l}))}function Q(e){var n=e.scope,s=e.header,i=e.items,r=e.signature,t=e.hideHeader,a=n.settings,o=D.createElement(ne,k.__assign({},{scope:n,items:i}));switch(a.style){case"compact_extra":return D.createElement("div",{className:"section print-nobreak"},D.createElement("div",{className:"header"},D.createElement(x.PrintFontResizable,null,s)),D.createElement("div",{className:"rows"},r,o));case"bars":return D.createElement("div",{className:"section print-nobreak"},D.createElement("div",{className:"header"},D.createElement(x.PrintFontResizable,null,r,s)),D.createElement("div",{className:"rows"},o));case"table":return D.createElement("tbody",{className:"print-nobreak"},i.map(function(e,t){return D.createElement("tr",{key:""+t},0==t&&D.createElement("td",{rowSpan:i.length,className:"header"},s),D.createElement(te,k.__assign({},{scope:n,item:e},{key:""+t})),0==t&&"subst_day"==a.show_signatures&&D.createElement("td",{rowSpan:i.length,className:"signature"},!r&&B))}))}return D.createElement("div",{className:"section print-nobreak"},r,t||D.createElement("div",{className:"header"},D.createElement(x.PrintFontResizable,null,s)),D.createElement("div",{className:"rows"},o))}function i(e){switch(A.DBITools.typeOfUniPeriod(e)){case"period":return parseInt(e);case"allday":return-10;case"daypart":return-9+parseInt(e[1])}return 0}function r(e){return e.event?-2:e.absent?-1:e.cancelled?1:0}function ee(e){e.sort(function(e,t){var n=i(e.uniperiod),s=i(t.uniperiod);return n!=s?n-s:r(e)-r(t)})}function te(e){var t=e.scope,n=e.item,s=n.ttitem,i=n.event,r=n.absent,a=n.text,o=n.uniperiod;return s?"teachers"==t.type?D.createElement($,k.__assign({},{scope:t,ttitem:s,key:s.id})):s.igroupid||s.orig&&s.igroupid?D.createElement(Y,k.__assign({},{scope:t,ttitem:s,key:s.id})):D.createElement(K,k.__assign({},{scope:t,ttitem:s,key:s.id})):i?D.createElement(J,k.__assign({},{scope:t,event:i,absent:r,key:i.id})):r?D.createElement(X,k.__assign({},{scope:t,absent:r,key:r.id})):a?D.createElement(P,k.__assign({},{scope:t,uniperiod:o,data:null,className:n.nosubst?"nosubst":"",what:null,info:a})):null}function ne(e){var n=e.scope,t=e.items;return D.createElement(D.Fragment,null,t.map(function(e,t){return D.createElement(te,k.__assign({},{scope:n,item:e},{key:""+t}))}))}function se(e){var t=e.classid,n=k.__assign(k.__assign({},e.scope),{classid:t}),s=n.req,r=n.dbi,i=n.settings,a=n.my_classids,o=n.TABLE_substs,l=[];n.ttitems.filter(function(e){return 0<=e.classids.indexOf(t)||!!(e.orig&&0<=e.orig.classids.indexOf(t))}).filter(function(e){if(0<e.changes.length)return!0;for(var t=0,n=e.substids;t<n.length;t++){var s=n[t],i=r.rowData(o,s);if(i&&i.note)return!0}return!1}).filter(function(e){return w(n,e)}).forEach(function(e){"absent_lesson"!=i.show_absents&&m({scope:n,ttitem:e})||l.push({uniperiod:e.uniperiod,cancelled:e.cancelled,ttitem:e})});var c=n.events.filter(function(e){return!(S.event_tableIds(e,"classes",{expand_ctevent:!0,dbi:r}).indexOf(t)<0)}).filter(function(e){return b(n,e.classroomids)}),u=new Set;if(n.absents.filter(function(e){return"classes"==R.absentGetTable(e)&&R.absentGetId(e)==t}).forEach(function(e){var t=le(e,c);l.push({uniperiod:A.DBITools.getUniPeriod(e),absent:e,event:t}),t&&u.add(t)}),c.filter(function(e){return!u.has(e)}).forEach(function(e){return l.push({uniperiod:A.DBITools.getUniPeriod(e),event:e})}),!a){if(0==l.length)return null;if(!i.show_absents&&!l.find(function(e){return!e.absent}))return null}return 0==l.length&&l.push({uniperiod:"",text:s.ls(1348),nosubst:!0}),ee(l),D.createElement(Q,{scope:n,header:r.rowName("classes",t,i.names_classes),items:l})}function ie(e){var t=e.igroupid,n=k.__assign(k.__assign({},e.scope),{igroupid:t}),s=n.req,r=n.dbi,i=n.settings,a=n.my_igroupids,o=n.TABLE_substs,l=[];n.ttitems.filter(function(e){return e.igroupid==t||!(!e.orig||e.orig.igroupid!=t)}).filter(function(e){if(0<e.changes.length)return!0;for(var t=0,n=e.substids;t<n.length;t++){var s=n[t],i=r.rowData(o,s);if(i&&i.note)return!0}return!1}).filter(function(e){return w(n,e)}).forEach(function(e){"absent_lesson"!=i.show_absents&&m({scope:n,ttitem:e})||l.push({uniperiod:e.uniperiod,cancelled:e.cancelled,ttitem:e})});var c=n.events.filter(function(e){return!(S.event_tableIds(e,"igroups").indexOf(t)<0)}).filter(function(e){return b(n,e.classroomids)}),u=new Set;if(n.absents.filter(function(e){return"igroups"==R.absentGetTable(e)&&R.absentGetId(e)==t}).forEach(function(e){var t=le(e,c);l.push({uniperiod:A.DBITools.getUniPeriod(e),absent:e,event:t}),t&&u.add(t)}),c.filter(function(e){return!u.has(e)}).forEach(function(e){return l.push({uniperiod:A.DBITools.getUniPeriod(e),event:e})}),a){var d=!1;if(n.ttitems.forEach(function(e){e.igroupid==t&&(d=!0),e.orig&&e.orig.igroupid==t&&(d=!0)}),!d)return null}else{if(0==l.length)return null;if(!i.show_absents&&!l.find(function(e){return!e.absent}))return null}return 0==l.length&&l.push({uniperiod:"",text:s.ls(1348),nosubst:!0}),ee(l),D.createElement(Q,{scope:n,header:r.rowName("igroups",t,i.names_igroups),items:l})}function re(e){var i=e.teacherid,r=k.__assign(k.__assign({},e.scope),{teacherid:i}),t=r.req,a=r.dbi,o=r.settings,n=r.my_teacherids,l=r.TABLE_substs,c=[],u=!1;r.ttitems.filter(function(e){return 0<=e.teacherids.indexOf(i)||!!(e.orig&&0<=e.orig.teacherids.indexOf(i))}).filter(function(e){if(0<e.changes.length)return!0;for(var t=0,n=e.substids;t<n.length;t++){var s=n[t],i=a.rowData(l,s);if(i&&i.note)return!0}return!1}).filter(function(e){return w(r,e)}).forEach(function(e){if(("absent_lesson"==o.show_absents||!m({scope:r,ttitem:e}))&&(c.push({uniperiod:e.uniperiod,cancelled:e.cancelled,ttitem:e}),0<=e.teacherids.indexOf(i))){e.added&&(u=!0);for(var t=0,n=e.changes;t<n.length;t++){var s=n[t];"teachers"==R.changeColumn2table(s.column)&&s.new==i&&(u=!0)}}});var s=r.events.filter(function(e){return!(S.event_tableIds(e,"teachers",{expand_ctevent:!0,dbi:a}).indexOf(i)<0)}).filter(function(e){return b(r,e.classroomids)}),d=new Set;if(r.absents.filter(function(e){return"teachers"==R.absentGetTable(e)&&R.absentGetId(e)==i}).forEach(function(e){var t=le(e,s);c.push({uniperiod:A.DBITools.getUniPeriod(e),absent:e,event:t}),t&&d.add(t)}),s.filter(function(e){return!d.has(e)}).forEach(function(e){return c.push({uniperiod:A.DBITools.getUniPeriod(e),event:e})}),!n){if(0==c.length)return null;if(!o.show_absents&&!c.find(function(e){return!e.absent}))return null}return 0==c.length&&c.push({uniperiod:"",text:t.ls(1348),nosubst:!0}),ee(c),D.createElement(Q,{scope:r,hideHeader:1==(r.my_teacherids||[]).length,header:a.rowName("teachers",i,o.names_teachers).trim(),signature:u&&"subst_day"==o.show_signatures&&D.createElement(Z,null),items:c})}function ae(e){return D.createElement(D.Fragment,null,D.createElement("div",{style:{fontSize:25,textAlign:"center"}},e.title),D.createElement("div",{style:{fontSize:16,textAlign:"center"}},e.subtitle),D.createElement(E.VGap,{height:5}))}function oe(e){var t=e.scope,n=e.hideTitle,s=e.repeatHeader,i=t.date,r=t.dbi,a=t.type,o=t.settings,l=t.TABLE_dates,c=t.req,u=t.unpublished,d=r.rowData(l,i),m=D.createElement(D.Fragment,null,n||D.createElement(ae,{title:c.ls(1003)+" - "+p.substReportTypes.filter(function(e){return e.type==a}).map(function(e){return c.localize(e.name)}),subtitle:c.lib_date.date_format_day(i,!0,!0)}),d.subst_note&&D.createElement("div",{className:"subst_note",style:{textAlign:"center",whiteSpace:"pre-wrap",marginBottom:3}},D.createElement(x.PrintFontResizable,null,d.subst_note)),D.createElement(ue,k.__assign({},{scope:t,table:"teachers"})),D.createElement(ue,k.__assign({},{scope:t,table:"classes"})),D.createElement(ue,k.__assign({},{scope:t,table:"classrooms"})),u&&d.is_online&&D.createElement("div",{style:{textAlign:"center",marginTop:5,fontWeight:"bold"}},c.ls(1645)),o.show_signatures&&D.createElement("div",{style:{float:"right",color:"#c0c0c0",textAlign:"center",width:O,marginRight:10}},c.ls(2694)),"mobile"!=o.style&&D.createElement(E.VGap,{height:15}));return s?D.createElement("div",{className:"print-header"},m):m}function le(e,t){for(var n=R.absentGetTable(e),s=R.absentGetId(e),i=A.DBITools.getUniPeriod(e),r=0,a=t;r<a.length;r++){var o=a[r];if(!(S.event_tableIds(o,n).indexOf(s)<0)&&(A.DBITools.getUniPeriod(o)==i&&(o.durationperiods||1)==(e.durationperiods||1)&&!("classes"==n&&o.groupnames.indexOf(e.groupname||"")<0)))return o}return null}p.SubstReportTitle=ae;var ce={teachers:"{tt:3817}",classes:"{tt:3779}",classrooms:"{tt:3780}"};function ue(e){var t=e.scope,n=e.table,s=t.req,i=t.dbi,r=t.absents,a=t.events,o=t.settings;if(!o["absent_summary_"+n])return null;for(var l=r.filter(function(e){return R.absentGetTable(e)==n}),c=[],u=0,d=i.tableIds(n);u<d.length;u++)for(var m=d[u],p=0,b=l;p<b.length;p++){var h=b[p];if(R.absentGetId(h)==m){var f=le(h,a),g=A.DBITools.getUniPeriod(h),_="classes"==n&&h.groupname||"",v=f?T.eventName(i,f):"",y=!1;if(v)for(var w=0,E=c;w<E.length;w++){var S=E[w];if(S.uniperiod==g&&(S.durationperiods==h.durationperiods&&S.groupname==_&&S.eventname==v)){S.ids.push(m),S.absents.push(h),y=!0;break}}y||c.push({uniperiod:g,durationperiods:h.durationperiods,ids:[m],absents:[h],groupname:_,eventname:v})}}if(0==c.length)return null;var C=o["names_"+n];return D.createElement("div",{style:{textAlign:"center"}},D.createElement(x.PrintFontResizable,null,s.localize(ce[n]),": ","hide"==C?c.length:D.createElement(N.RJoin,{glue:", "},c.map(function(e,t){return D.createElement(N.RJoin,{glue:" ",key:""+t},[D.createElement(N.RJoin,{glue:"short"==C?"+":" + ",key:"names"},e.ids.map(function(e){return i.rowName(n,e,C)})),e.groupname||null,D.createElement(N.RJoin,{glue:" ",before:" (",after:")",key:"details"},["ad"!=e.uniperiod&&i.tools.uniperiodName(e.uniperiod,void 0,e),e.eventname||null])])}))))}function de(e){var c=e.req,u=e.dbi,t=e.dates,d=e.type,m=e.my_classids,p=e.my_igroupids,b=e.my_teacherids,h=e.settings,n=e.viewer,f=e.hideTitle,g=e.repeatHeader,s="mobile"==h.style&&!c.isApp();D.useEffect(function(){s&&barCssLoad("/app/pics/css/substitution.css")},[s]);var i={},r={float:"right",borderBottom:"1px dashed #c0c0c0",width:O,marginRight:4,marginLeft:10},a={fontSize:16,textAlign:"center",flexGrow:0,marginRight:10},o={".signature":k.__assign({},r),".row":k.__assign({},{display:"flex",flexDirection:"row",alignItems:"baseline",fontSize:12,marginBottom:1}),".period":k.__assign({},a),".period>span":k.__assign({},{whiteSpace:"pre",display:"inline-block",minWidth:30}),".info":k.__assign({},{flex:1})};switch(h.style){case"compact":i=k.__assign(k.__assign({},o),{".section":{paddingLeft:4,paddingRight:4,paddingBottom:1,borderBottom:"1px solid #c0c0c0",marginBottom:1},".header":{fontSize:14,fontWeight:"bold",marginBottom:1},".rows":{paddingLeft:5},".period":k.__assign(k.__assign({},a),{fontSize:"inherit"})});break;case"compact_extra":i=k.__assign(k.__assign({},o),{".section":{paddingLeft:4,paddingRight:4,paddingBottom:1,borderBottom:"1px solid #c0c0c0",marginBottom:1,display:"flex",flexDirection:"row"},".header":{fontSize:14,fontWeight:"bold",display:"block",flex:0,minWidth:"teachers"==d&&"short"!=h.names_teachers?150:50},".rows":{paddingLeft:5,flex:1},".period":k.__assign(k.__assign({},a),{fontSize:"inherit"})});break;case"bars":i=k.__assign(k.__assign({},o),{".section":{marginBottom:20},".header":{fontSize:20,fontWeight:"bold",padding:4,backgroundColor:"#e0e0e0",marginBottom:5},".header .signature":{borderColor:"#a0a0a0"},".rows":{paddingLeft:20}});break;case"mobile":i=k.__assign({},o);break;case"table":i=k.__assign(k.__assign({},o),{table:{width:"100%",tableLayout:"auto"},tbody:{border:"2px solid #808080"},td:{border:"1px solid #808080",padding:2},".header":{fontSize:16,textAlign:"center"},".period":{fontSize:12,textAlign:"center",whiteSpace:"nowrap"},".time":{fontSize:12,textAlign:"center",whiteSpace:"pre"},".period>span":{},".signature":{width:O,textAlign:"center",color:"#a0a0a0"}});break;default:i=k.__assign(k.__assign({},o),{".section":{marginBottom:15,border:"1px solid #c0c0c0",borderRadius:6,padding:4},".header":{fontSize:20,marginBottom:5,fontWeight:"bold",border:"2px solid #c0c0c0",borderRadius:6,padding:4,display:"inline-block"},".rows":{paddingLeft:5},".signature":k.__assign({fontSize:20},r),".rows .signature":{fontSize:"inherit"}})}var _=e,l=null;if(n){var v=u.rowData(e.TABLE_dates,t[0]),y=c.lib_date;if(v&&v.published_int){var w=C.datetime_js2sql(new Date(1e3*v.published_int));l=D.createElement("div",{style:{textAlign:"center",fontSize:12}},D.createElement("a",{href:"https://www.asctimetables.com",target:"_blank"},"www.asctimetables.com")," - ",y.date_format_time(w,{ajDenSlovom:!1}))}}return D.createElement(E.RScopedStyle,{rules:i,className:s&&"app-subst"},t.map(function(e,t){var n;n=R.buildSubstOnlineTTItemsEx(u,e,!0,{table:_.TABLE_ttitems}).map(function(e){return k.__assign(k.__assign({},e),{eventids:[]})});var s=S.splitClassTeacherEvents(u,u.tableFilterData(S.TABLE_events,{date:e})),i=(s=(s=s.filter(function(e){return function(e,t){var n=e.rowData("event_types",t.typ);if(!n)return!1;if(!n.dp)return!1;var s=S.eventPrivacy(e,t);return!(j.indexOf(s)<0)}(u,e)})).filter(function(e){return!S.isAttachEvent(u,e)})).filter(function(e){return S.isAllClassesEvent(u,e)});"teachers"==d&&s.forEach(function(e){5<=e.teacherids.length&&i.indexOf(e)<0&&i.push(e)}),"classes"==d&&s.forEach(function(e){5<=e.classids.length&&i.indexOf(e)<0&&i.push(e)}),0<i.length&&(s=s.filter(function(e){return i.indexOf(e)<0}));var r=u.tableFilterData(_.TABLE_substs,{date:e}),a=new I.TTItemTimeProvider(u);a.setDate(u.rowData(_.TABLE_dates,e),_.tt_dbi);var o=k.__assign(k.__assign({},_),{date:e,timeProvider:a,absents:u.tableFilterData(_.TABLE_absents,{date:e}),ttitems:n,events:s}),l=[];return 0<i.length&&l.push(D.createElement(Q,{scope:o,header:c.ls(1155),items:i.map(function(e){return{uniperiod:A.DBITools.getUniPeriod(e),event:e}})})),"classes"==d&&((m||u.tableIds("classes")).forEach(function(e){return l.push(D.createElement(se,k.__assign({},{scope:o,classid:e,key:e})))}),"hide"!=h.names_igroups&&(p||u.tableIds("igroups")).forEach(function(e){return l.push(D.createElement(ie,k.__assign({},{scope:o,igroupid:e})))})),"teachers"==d&&(b||u.tableIds("teachers")).forEach(function(e){return l.push(D.createElement(re,k.__assign({},{scope:o,teacherid:e,settings:h,key:e})))}),D.createElement(E.Fragment,{key:e},"mobile"!=h.style&&0<t&&(h.pagebreak_date?D.createElement("div",{className:"print-pagebreak"}):D.createElement(E.VGap,{height:15})),D.createElement("div",{"data-date":e},D.createElement(oe,k.__assign({},{scope:o,hideTitle:f,repeatHeader:g})),"table"==h.style?D.createElement("table",null,l):l,0==r.length&&!(m||b||p)&&D.createElement("div",null,c.ls(1348))))}),l)}p.SubstReport=de,p._hotswap=[d,y]}),ASC.setModuleSourceFunc("/dashboard/printSheet.js",function(r,require,e){r.__esModule=!0;var a=require("tslib"),o=require("react"),n=require("react-dom"),l=require("../asc/asc_react"),c=require("../asc/actions"),u=require("../asc/edurequest");r.initUI=function(e,t){t.asDialog?l.RDialog.show(i,t):n.render(o.createElement(i,a.__assign({},t)),e)},r.PrintToolbar={formats:[{id:"a4-portrait",name:"A4 - "+ASC.ls(1835),width:716,height:1044},{id:"a4-landscape",name:"A4 - "+ASC.ls(1836),width:1044,height:716}],fontSizes:[80,90,100,110,120,130,140,150,170,200]};var s,i=(s=o.Component,a.__extends(t,s),t.prototype.render=function(){var t=this,e=u.client_req,n=o.createElement("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,padding:"100px 40% 20px 40%",backgroundColor:"rgba(222, 234, 217, 0.5)"}},o.createElement("div",{style:{textAlign:"right",padding:"1em 0"}},o.createElement("i",{className:"fa fa-close",style:{cursor:"pointer",padding:"0.5em"},onClick:function(){t.setState({hideReloadBtn:!0})}})),o.createElement(l.RButton,{label:"Reload the report content",type:"blue",onClick:function(){t.setState({hideReloadBtn:!0}),t.props.renderer(t.refs.sheet)}})),s=o.createElement("div",{ref:"sheet",className:"print-sheet print-"+this.state.format,id:"sheet"},this.props.showReloadBtn&&!this.state.hideReloadBtn&&n,this.props.children),i=o.createElement(l.Fragment,null,this.props.onCustomize&&o.createElement(o.Fragment,null,o.createElement(l.RButton,{label:c.action_name("customize"),fa_icon:c.action_fa_icon("customize"),onClick:this.props.onCustomize}),o.createElement(l.HGap,{width:15})),o.createElement(l.RButton,{label:ASC.ls(1638),fa_icon:"print",onClick:this.print.bind(this)}),o.createElement(l.RButton,{label:ASC.ls(1529),fa_icon:"download",menu:a.__spreadArrays(e.isAdmin()||e.isUcitel()?[{text:"PDF",onclick:this.download.bind(this,"pdf")},[]]:[],[{text:"HTML",onclick:this.download.bind(this,"html")},{text:"HTML ("+ASC.ls(1906)+")",onclick:this.download.bind(this,"html_p")}])}),o.createElement(l.RButton,{label:ASC.ls(1837),fa_icon:"search",onClick:this.print.bind(this,{preview:!0})}),o.createElement("span",{style:{marginLeft:"10px"}},this.props.showConvertToA3&&o.createElement(l.RButton,{label:ASC.ls(1837)+" (A3)",onClick:function(){var e=window.open("about:blank","_blank");t.print({preview:!0,window:e}),ASC.PaginatedDiv.convertToA3(e.document.body)}}),this.props.showFormat&&o.createElement(l.RComboBox,{items:r.PrintToolbar.formats.map(function(e){return{value:e.id,name:e.name}}),valueRef:l.stateRef(this,"format")}),this.props.showFontSize&&o.createElement(l.RComboBox,{items:r.PrintToolbar.fontSizes.map(function(e){return{value:e,name:ASC.ls(2153)+" "+e+"%"}}),valueRef:l.stateRef(this,"fontSize")})));return this.props.asDialog?o.createElement(l.RDialog,{header:ASC.ls(1641)+" - "+this.props.filename,width:900,height:650,buttons:["close"],footer:i,allowMaximizeBtn:!0},o.createElement("div",{style:{overflow:"auto",padding:"0 1px"}},s)):o.createElement(l.Fragment,null,o.createElement("div",{style:{flex:"1 1 auto",overflow:"auto",padding:"0 1px"}},s),o.createElement("div",{ref:"toolbar",className:"ui-widget-content print-toolbar",style:{flex:"0 0 auto",padding:"10px"}},i))},t.prototype.componentDidMount=function(){var e=this;setTimeout(function(){e.props.showReloadBtn||e.props.renderer(e.refs.sheet)},100)},t.prototype.componentDidUpdate=function(){var t=this;r.PrintToolbar.formats.forEach(function(e){$j(t.refs.sheet).toggleClass("print-"+e.id,e.id==t.state.format)}),r.PrintToolbar.fontSizes.forEach(function(e){$j(t.refs.sheet).toggleClass("print-font-size-"+e,e==parseInt(t.state.fontSize))})},t.prototype.componentWillReceiveProps=function(e){this.setState({hideReloadBtn:!e.showReloadBtn})},t.prototype.print=function(e){void 0===e&&(e={}),!e.preview&&$j(this.refs.sheet).hasClass("landscape")&&!confirm('Please do not forget to configure printer settings to "Landscape".')||ASC.printDiv(this.refs.sheet,a.__assign(a.__assign({},e),{watermark:this.props.watermark}))},t.prototype.download=function(i){return a.__awaiter(this,void 0,void 0,function(){var t,n,s=this;return a.__generator(this,function(e){switch(e.label){case 0:return""!=this.refs.sheet.innerHTML?[3,1]:(ASC.flashMessage(ASC.ls(3161)),[3,5]);case 1:switch(t=ASC.paginateDiv(this.refs.sheet,"html"==i?0:"auto",{watermark:this.props.watermark,css_inline:!0}),i){case"html":case"html_p":return[3,2];case"pdf":return[3,3]}return[3,5];case 2:return this.downloadBlob(new Blob([t.html],{type:"text/html"})),[3,5];case 3:return(n=new ASC.ui.Dialog({title:this.props.filename,width:"300px"})).setBody("<img src='/global/pics/bar/dialogLoading.gif' style='vertical-align:middle'/> "+ASC.ls(8769)),[4,Promise.resolve().then(function(){return require("./server/print_pdf")})];case 4:return e.sent().getHTMLToPdf(null,t.html,{format:this.state.format.substr(0,2).toUpperCase(),landscape:0<=this.state.format.indexOf("landscape")}).then(function(e){ASC.timer_start(),s.downloadBlob(new Blob([new Uint8Array(e.data)],{type:"text/pdf"})),n.hide(),ASC.timer_dump("downloaded")}),[3,5];case 5:return[2]}})})},t.prototype.downloadBlob=function(e){var t="text/pdf"==e.type?"pdf":"html";if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(e,this.props.filename+"."+t);else{var n=window.document.createElement("a");n.href=window.URL.createObjectURL(e),n.download=this.props.filename+"."+t,document.body.appendChild(n),n.click(),document.body.removeChild(n)}},t.defaultProps={showFormat:!0,showFontSize:!0},t);function t(e){var t=s.call(this,e)||this;return t.state={format:t.props.format||"a4-portrait",fontSize:"100"},t}r.PrintSheet=i,r.PrintFontResizable=function(e){return o.createElement("span",{className:"print-font-resizable"},e.children)}}),ASC.setModuleSourceFunc("/substitution/server/report.js",function(e,require,t){t.implementRpc(["getSubstReportInReportovacSettings","setSubstReportInReportovacSettings"])}),ASC.setModuleSourceFunc("/substitution/viewer.js",function(c,require,e){c.__esModule=!0;var f=require("tslib"),g=require("react"),_=require("./online/report"),b=require("../asc/lib_date"),v=require("../asc/asc_react"),y=require("./server/viewer");c.substViewerModeName={teachers:"{1929}",classes:"{1930}",me:"{9092}",admin:"Information for admin"};var u={teachers:"{1005}",classes:"{1194}",me:"{1751}",admin:"Admin"};function w(e){var t=e.mode,n=e.selected,s=e.onClick,i=v.useReq(),r=v.useHover(),a=r[0],o=r[1],l=v.useResponsiveLevel();return g.createElement("span",f.__assign({},o,{style:{color:n?"#000000":"#A0A0A0",marginLeft:10,cursor:s?"pointer":void 0,backgroundColor:a||n?"#e8e8e8":void 0,padding:0<l?5:void 0},onClick:s}),i.localize((0<l?u:c.substViewerModeName)[t]))}function E(r){var a=v.useReq().lib_date,n=0<v.useResponsiveLevel(),e=g.useState(function(){if(n)return r.date;var e=a.date_week(b.date_delta(r.date,-7)),t=a.week_start(e);return r.date_limitfrom&&r.date_limitfrom>t&&(t=r.date_limitfrom),t}),s=e[0],i=e[1],t=g.useState(!1),o=t[0],l=t[1];g.useEffect(function(){return l(!0)});var c=r.date_limitfrom,u=b.date_delta(s,n?6:18),d=b.date_interval_array(s,u),m=[-1,1].map(function(t){return g.createElement("div",{className:"scroller",onMouseDown:function(e){return e.preventDefault()},style:{},onClick:function(e){t<0&&s==c||i(b.date_delta(s,t))}},t<0?"<":">")}),p=n?35:Math.floor((704-1*d.length)/d.length);return g.createElement(v.RScopedStyle,{className:"SubstViewDateSwitcher",rules:{".switcher":{display:"flex",flexDirection:"row",flex:1},".cell":{whiteSpace:"pre",textAlign:"center",flex:1,minWidth:p,width:p,flexBasis:p,color:"#808080",cursor:"pointer",marginRight:1,transition:"opacity 0.1s"},".cell:hover":{backgroundColor:"#e8e8e8"},".cell.weekend":{color:"#d0d0d0"},".cell.selected":{backgroundColor:"#e8e8e8",color:"#000000",cursor:"auto",opacity:1},".cell.filler":{visibility:"hidden",height:0,display:"none"},".scroller":{paddingTop:7,cursor:"pointer",minWidth:n?25:15,width:15,flex:0,textAlign:"center",color:"#808080",visibility:n?void 0:"hidden"},".scroller:hover":{backgroundColor:"#e8e8e8"},"$:hover .scroller":{visibility:"visible"}},style:{display:"flex",flexDirection:"row",fontSize:11}},m[0],g.createElement("div",{className:"switcher"},d.map(function(e){var t=a.timezone_isWeekend(e),n=a.date_format_day(e,!1,"short"),s=n.indexOf(" ");0<=s&&(n=n.substr(0,s)+"\n"+n.substr(s+1)),n=n.replace(/ /g,"");var i=e==r.date;return g.createElement("div",{key:e,className:v.classNames({cell:!0,selected:i,weekend:t}),style:f.__assign({},o||i?{}:{opacity:.5,pointerEvents:"none",cursor:"auto"}),onClick:i?void 0:function(){return r.onDate(e)}},n)}),v.rangeFromTo(1,21).map(function(e){return g.createElement("div",{key:""+e,className:"cell filler"})})),m[1])}function S(e,t,n,s){for(var i=b.date_delta(t,n),r=0;r<3&&e.lib_date.timezone_isWeekend(i);r++)i=b.date_delta(i,n);return i<s.date_limitfrom?"":i}function C(s){var i=s.date,r=v.useReq();function e(e){var t=S(r,i,e,s),n=!!t;return g.createElement("div",{onClick:function(){return n&&s.onDate(t)},style:{cursor:"pointer",padding:"0px 10px",color:n?void 0:"#c0c0c0"},onMouseDown:function(e){return e.preventDefault()}},e<0?"<":">")}return g.createElement("div",{style:{fontSize:20,display:"flex",flexDirection:"row"}},e(-1),g.createElement("div",{style:{textAlign:"center",flex:"1 1 0px"}},r.lib_date.date_format_day(i,!0,!0)),e(1))}c.SubstViewer=function(n){var e=this,t=g.useState(n.date),s=t[0],i=t[1],r=g.useState(n.mode),a=r[0],o=r[1],l=g.useRef(!0),c=v.useResponsiveLevel(),u=v.useReq(),d=v.useAsyncMemo(function(){return f.__awaiter(e,void 0,void 0,function(){return f.__generator(this,function(e){switch(e.label){case 0:return l.current?(l.current=!1,[2,n.report_html]):[4,y.getSubstViewerDayDataHtml(null,{date:s,mode:a})];case 1:return[2,e.sent()]}})})},[s,a,n.refresh],function(){return l.current?n.report_html:""},[s,a,n.refresh]),m=0<c?C:E,p=function(r){var a=g.useRef();return{onTouchStart:function(e){e.persist(),a.current=e},onTouchEnd:function(e){var t=a.current,n=t.changedTouches[0],s=e.changedTouches[0];if(r.onHoziontalSwipe){var i=n.pageX-s.pageX;e.timeStamp-t.timeStamp<300&&80<Math.abs(i)&&r.onHoziontalSwipe(i<0?-1:1,e)}}}}({onHoziontalSwipe:function(e){var t=S(u,s,e,n);t&&i(t)}}),b=n.date_limitfrom,h=n.enabled_modes;return g.createElement("div",f.__assign({},p,{className:n.mobile?"app-view-fullHeight":"",style:{backgroundColor:"#ffffff",color:"#000000",padding:5}}),g.createElement(m,f.__assign({},{date_limitfrom:b,date:s,onDate:function(e){return i(e)}})),g.createElement(v.VGap,{height:20}),0<h.length?g.createElement(g.Fragment,null,g.createElement(_.SubstReportTitle,{title:0<c?void 0:u.ls(1003)+" - "+u.lib_date.date_format_day(s,!0,!0),subtitle:h.map(function(e){var t=a==e;return g.createElement(w,f.__assign({},{req:u,key:e,mode:e,selected:t,onClick:t?void 0:function(){o(e)}}))})}),d?g.createElement("div",{dangerouslySetInnerHTML:{__html:d}}):g.createElement(v.Loading,null)):g.createElement("div",{style:{textAlign:"center"}},u.ls(2854)))},c.DateSwitcher=E}),ASC.setModuleSourceFunc("/substitution/server/viewer.js",function(e,require,t){t.implementRpc(["getSubstViewerSettings","setSubstViewerSettings","getSubstViewerDayDataHtml","substViewerProps","getMobileSubstViewerData","getSubstViewerAdminProps"])}),ASC.setModuleSourceFunc("/customize/privacy.js",function(e,require,t){e.__esModule=!0,e.privacyCombo2=function(e){return[{value:"disabled",name:e.ls(1686),icon:"/global/pics/ui/delete_32.svg"},{value:"teachers",name:e.ls(1005),icon:"/global/pics/ui/teacher_32.svg"},{value:"students",name:e.ls(1006),icon:"/global/pics/ui/student_32.svg"},{value:"public",name:e.ls(2064),icon:"/global/pics/ui/privacy_public_32.svg"}]}});