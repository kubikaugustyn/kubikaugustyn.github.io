/*function main(<br>
    workbook: ExcelScript.Workbook,<br>
    FromName: string = "Kuba test!",<br>
    FromID: string = "Kuba643cv3xc",<br>
    MessageID: string = "fd2536fdc3@threat.tacv2",<br>
    ObsahZpravy: string = "Tohle je test.",<br>
    FromEmail: string = "Jakub.Augustyn",<br>
    DateReceived: string = "2021-02-26T09:48:03.284Z"<br>
): string {*/<br>
function main(<br>
  workbook: ExcelScript.Workbook,<br>
  FromName: string,<br>
  FromID: string,<br>
  MessageID: string,<br>
  ObsahZpravy: string,<br>
  FromEmail: string,<br>
  DateReceived: string<br>
): string {<br>
  ObsahZpravy = ObsahZpravy.replace("<div>", "")<br>
  ObsahZpravy = ObsahZpravy.replace('<div itemprop="copy-paste-block">', "")<br>
  ObsahZpravy = ObsahZpravy.replace('<div style="font-size:14px">', "")<br>
  ObsahZpravy = ObsahZpravy.replace("</div>", "")<br>
  ObsahZpravy = ObsahZpravy.replace("</div>", "")<br>
  ObsahZpravy = ObsahZpravy.replace("</div>", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  ObsahZpravy = ObsahZpravy.replace("\n", "")<br>
  let Result = StartBot(ObsahZpravy)<br>
<br>
  // Get the email table.<br>
  let emailWorksheet = workbook.getWorksheet("Messages");<br>
  let table = emailWorksheet.getTable("MessagesTable");<br>
<br>
  // Get the PivotTable.<br>
  let pivotTableWorksheet = workbook.getWorksheet("MessagesValues");<br>
  let pivotTable = pivotTableWorksheet.getPivotTable("Pivot");<br>
<br>
  // Parse the received date string to determine the day of the week.<br>
  let emailDate = new Date(DateReceived);<br>
  let DayName = emailDate.toLocaleDateString("en-US", {<br>
    weekday: 'long'<br>
  });<br>

  // Add the parsed text to the table.<br>
  table.addRow(-1, [DateReceived, DayName, FromName, ObsahZpravy, Result]);<br>
<br>
  // Refresh the PivotTable to include the new row.<br>
  pivotTable.refresh();<br>
<br>
  return Result<br>
}<br>

function StartBot(ObsahZpravy: string) {<br>
  let Result = "THIS IS BOT.<br>"<br>
  let Pozdravy = ["dobrý den", "ahoj", "čus"]<br>
  let Casy = ["kolik je hodin", "jaký je čas"]<br>
  let YTID = ["YouTubeID ${ID}", "YtID ${ID}"]<br>
  let KdoJsem = ["kdo jsi"]<br>
<br>
  let ZpravyObsahy = Pozdravy<br>
  ZpravyObsahy = ZpravyObsahy.concat(Casy)<br>
  ZpravyObsahy = ZpravyObsahy.concat(YTID)<br>
  ZpravyObsahy = ZpravyObsahy.concat(KdoJsem)<br>
<br>
  Result = addMessageValue(ObsahZpravy, Pozdravy, Result, "Pozdrav")<br>
  Result = addMessageValue(ObsahZpravy, Casy, Result, "Casy")<br>
  Result = addMessageValue(ObsahZpravy, KdoJsem, Result, "KdoJsem")<br>
  Result = addMessageValue(ObsahZpravy, YTID, Result, "YTID")<br>
  if (Result === "THIS IS BOT.<br>") {<br>
    Result += "Zkuste napsat: " + ZpravyObsahy.join(" NEBO ")<br>
  }<br>
  console.log("Result: " + Result)<br>
<br>
  return Result<br>
}<br>
<br>
function addMessageValue(OldObsahZpravy: string, Polozky: string[], OldResult: string, Type: string) {<br>
  let Result = OldResult<br>
  let ObsahZpravy = OldObsahZpravy<br>
  if ((Type != "YTID")) {<br>
    ObsahZpravy = ObsahZpravy.toLowerCase()<br>
  }<br>
  //console.log(ObsahZpravy + ":" + Polozky.join(" X ") + ":" + Result + ":" + Type + ":" + "  Kubafgdx")<br>
  //console.log((isIn(ObsahZpravy, Polozky)) + ":" + ObsahZpravy + ":" + Polozky.join(","))<br>
  switch (Type) {<br>
    case "Pozdrav":<br>
      if (isIn(ObsahZpravy, Polozky)) {<br>
        Result += "Také zdravím.&lt;br>"<br>
      }<br>
      break<br>
    case "Casy":<br>
      if (isIn(ObsahZpravy, Polozky)) {<br>
        let addToResult = "Čas: ${TIME}&lt;br>"<br>
        let Time = new Date().toLocaleDateString() + new Date().toLocaleTimeString()<br>
        addToResult = addToResult.replace("${TIME}", Time)<br>
        Result += addToResult<br>
      }
      break<br>
    case "KdoJsem":<br>
      if (isIn(ObsahZpravy, Polozky)) {<br>
        Result += "Jsem BOT.&lt;br>"<br>
      }<br>
      break<br>
    case "YTID":<br>
      Result = YTID(Result, ObsahZpravy, Polozky)<br>
  }
  //console.log("Result = '"+Result+"'")<br>
  //console.log(ObsahZpravy + ":" + Polozky.join(" X ") + ":" + Result + ":" + Type + ":" + "  Kubafgdx")<br>
  return Result<br>
}

function YTID(Result: string, ObsahZpravy: string, YTIDPolozky: string[]) {<br>
  //console.log("YTID, result = "+Result)<br>
  for (let i = 0; i < YTIDPolozky.length; i++) {<br>
    //console.log(ObsahZpravy+ObsahZpravy.search(YTIDPolozky[i].replace(" ${ID}", ""))+YTIDPolozky[i].replace(" ${ID}", ""))<br>
    if (ObsahZpravy.search(YTIDPolozky[i].replace(" ${ID}", "")) === 0) {<br>
      let YTIDPolozkaJenTextZpravy = YTIDPolozky[i].replace(" ${ID}", "")<br>
      let MujObsahZpravy = ObsahZpravy.replace(YTIDPolozkaJenTextZpravy + " ", "")<br>
      let addToResult = "Adresa URL videa: ${URL}<br>Aderesa URL videa bez reklam (uživatelům se zhlédnutím reklamy neposílají peníze): ${EMBEDURL}"<br>
<br>
      let URLS: string[] = []<br>
      let videoId: string = MujObsahZpravy<br>
      URLS[0] = "https://youtu.be/" + videoId<br>
      URLS[1] = "https://www.youtube.com/embed/" + videoId<br>
      addToResult = addToResult.replace("${URL}", getLink(URLS[0], URLS[0]))<br>
      addToResult = addToResult.replace("${EMBEDURL}", getLink(URLS[1], URLS[1]))<br>
      Result += addToResult<br>
      if (videoId.length !== 11) {<br>
        Result += "<br>Warning: Video ID hasn't length 11 but " + videoId.length<br>
      }<br>
    }<br>
  }<br>
  //console.log("YTID, result = "+Result)<br>
  return Result<br>
}<br>
<br>
function isIn(Value: string, Array: string[]) {<br>
  if (Value && Array) {<br>
    for (let i = 0; i < Array.length; i++) {<br>
      if (Value.search(Array[i]) > -1) {<br>
        return true<br>
      }<br>
    }<br>
    return false<br>
  }<br>
}<br>
<br>
function getLink(Href: String, Value: String){<br>
  let link = "<a href='"+Href+"' target='_blank'>"+Value+"</a>";<br>
  return link<br>
}<br>
